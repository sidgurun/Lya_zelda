

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>funcs &mdash; zELDA 0.0.01 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> zELDA
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorial_ideal.html">Tutorial : Computing ideal line profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorial_mock.html">Tutorial : Computing mock line profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorial_DNN.html">Tutorial : Fitting a line profile using deep learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorial_MCMC.html">Tutorial : Fitting a line profile using deep learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tutorial_fesc.html">Tutorial : Computing Lyman-alpha escape fractions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../funcs.html">funcs module</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">zELDA</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>funcs</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for funcs</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">zELDA es a phantastic code!!</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">os</span>


<span class="kn">import</span> <span class="nn">time</span>

<span class="c1">#from pylab import *</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="c1">#import urllib</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">ExtraTreesRegressor</span><span class="p">,</span> <span class="n">GradientBoostingRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KNeighborsRegressor</span>

<span class="kn">import</span> <span class="nn">pickle</span>

<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>

<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter1d</span>

<span class="kn">import</span> <span class="nn">emcee</span>

<span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPRegressor</span>

<span class="kn">from</span> <span class="nn">pyswarms.single.global_best</span> <span class="kn">import</span> <span class="n">GlobalBestPSO</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="n">Data_location</span> <span class="o">=</span> <span class="s1">&#39;/global/users/sidgurung/PROMARE/Grids/&#39;</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Check_if_DATA_files_are_found"><a class="viewcode-back" href="../funcs.html#funcs.Check_if_DATA_files_are_found">[docs]</a><span class="k">def</span> <span class="nf">Check_if_DATA_files_are_found</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function checks if all the data files are in the set directory.</span>

<span class="sd">        **Input**:</span>

<span class="sd">        None : None</span>

<span class="sd">        **Output**:</span>

<span class="sd">        Bool_1 : Bool</span>
<span class="sd">                    1 if     found.</span>
<span class="sd">                    0 if not found.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">this_dir</span><span class="p">,</span> <span class="n">this_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

    <span class="n">Bool_1</span> <span class="o">=</span> <span class="kc">True</span>
     
    <span class="n">arxiv_with_file_names</span> <span class="o">=</span> <span class="n">this_dir</span> <span class="o">+</span> <span class="s1">&#39;/DATA/List_of_DATA_files&#39;</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">arxiv_with_file_names</span> <span class="p">)</span> <span class="k">as</span> <span class="n">fd</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fd</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>

            <span class="n">arxiv_name</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="n">Bool_1</span> <span class="o">=</span> <span class="n">Bool_1</span> <span class="o">*</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span> <span class="n">Data_location</span> <span class="o">+</span> <span class="n">arxiv_name</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">Bool_1</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="load_machine_fesc"><a class="viewcode-back" href="../funcs.html#funcs.load_machine_fesc">[docs]</a><span class="k">def</span> <span class="nf">load_machine_fesc</span><span class="p">(</span> <span class="n">Machine</span> <span class="p">,</span> <span class="n">property_name</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This functions gives you the trained model that you want to use.</span>

<span class="sd">        **Input**:</span>

<span class="sd">        Machine : String</span>
<span class="sd">                    Kind of algorithm: &#39;KN&#39;, &#39;Grad&#39;, &#39;Tree&#39; or &#39;Forest&#39;</span>
<span class="sd">        </span>
<span class="sd">        property_name : String</span>
<span class="sd">                    The variable to import: &#39;KKK&#39; , &#39;CCC&#39; , &#39;LLL&#39; or &#39;f_esc&#39; </span>

<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>
<span class="sd">                                       , &#39;Bicone_X_Slab_In&#39; , &#39;Bicone_X_Slab_Out&#39;</span>

<span class="sd">        **Output**:</span>

<span class="sd">        loaded_model : file with all the necesary to do machine learning</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">Machine_Set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;KN&#39;</span> <span class="p">,</span> <span class="s1">&#39;Grad&#39;</span> <span class="p">,</span> <span class="s1">&#39;Tree&#39;</span> <span class="p">,</span> <span class="s1">&#39;Forest&#39;</span>  <span class="p">]</span>

    <span class="n">Geometry_Set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]</span>

    <span class="n">geo_code</span>     <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;thin&#39;</span>        <span class="p">,</span> <span class="s1">&#39;wind&#39;</span>           <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab&#39;</span> <span class="p">]</span>

    <span class="n">Property_Set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;KKK&#39;</span> <span class="p">,</span> <span class="s1">&#39;CCC&#39;</span> <span class="p">,</span> <span class="s1">&#39;LLL&#39;</span> <span class="p">,</span> <span class="s1">&#39;f_esc&#39;</span> <span class="p">]</span>

    <span class="k">assert</span> <span class="n">property_name</span> <span class="ow">in</span> <span class="n">Property_Set</span> <span class="p">,</span> <span class="s2">&quot;Houston we&#39;ve got a problem, Error Code = 23452345.7523&quot;</span>

    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Geometry_Set</span><span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">this_dir</span><span class="p">,</span> <span class="n">this_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>

    <span class="n">filename_root</span> <span class="o">=</span> <span class="s1">&#39;finalized_model_&#39;</span><span class="o">+</span> <span class="n">geo_code</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;_f_esc_&#39;</span> <span class="o">+</span> <span class="n">Machine</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">property_name</span> 

    <span class="k">if</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span><span class="p">:</span>
        <span class="n">filename_root</span> <span class="o">+=</span> <span class="s1">&#39;_Inside_Bicone_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span><span class="p">:</span>
        <span class="n">filename_root</span> <span class="o">+=</span> <span class="s1">&#39;_Inside_Bicone_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_root</span> <span class="o">+</span> <span class="s1">&#39;.sav&#39;</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">Data_location</span> <span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>

    <span class="k">return</span>  <span class="n">loaded_model</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Analytic_f_esc_Thin_Shell"><a class="viewcode-back" href="../funcs.html#funcs.Analytic_f_esc_Thin_Shell">[docs]</a><span class="k">def</span> <span class="nf">Analytic_f_esc_Thin_Shell</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the escape fraction computed analytically for the Thin Shell</span>
<span class="sd">        (Gurung-lopez et al. 2019a)</span>

<span class="sd">        **Input**:</span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Arr : 1-D sequence of floats</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        **Output**:</span>

<span class="sd">        fesc :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">NH18</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span> <span class="n">logNH_Arr</span> <span class="o">-</span> <span class="mi">18</span> <span class="p">)</span> 

    <span class="c1">#New MCMC</span>
    <span class="n">c11</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">1.90526</span><span class="p">)</span>
    <span class="n">c12</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">2.0399</span><span class="p">)</span>
    <span class="n">c13</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">2.34829</span><span class="p">)</span>
    <span class="n">c21</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">3.138837</span><span class="p">)</span>
    <span class="n">c22</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.92151</span><span class="p">)</span>
    <span class="n">c23</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.1860205000000001</span><span class="p">)</span>
    <span class="n">c24</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1480042</span><span class="p">)</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.0530715</span><span class="p">)</span>
    <span class="n">c4</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.743455</span><span class="p">)</span>

    <span class="n">C1</span> <span class="o">=</span> <span class="p">(</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">NH18</span><span class="p">)</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span> <span class="o">*</span> <span class="n">c11</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">NH18</span><span class="p">)</span> <span class="o">*</span> <span class="n">c12</span> <span class="o">+</span> <span class="n">c13</span>
    <span class="n">y</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">NH18</span><span class="p">)</span>
    <span class="n">C2</span> <span class="o">=</span> <span class="n">c21</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">c22</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">c23</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">c24</span>
    <span class="n">C3</span> <span class="o">=</span> <span class="n">c3</span>
    <span class="n">C4</span> <span class="o">=</span> <span class="n">c4</span>

    <span class="n">K1</span> <span class="o">=</span> <span class="n">C1</span> <span class="o">*</span> <span class="p">(</span> <span class="n">V_Arr</span> <span class="o">**</span> <span class="n">C2</span> <span class="p">)</span>
    <span class="n">K2</span> <span class="o">=</span> <span class="n">C3</span> <span class="o">*</span> <span class="p">(</span> <span class="n">V_Arr</span> <span class="o">**</span> <span class="n">C4</span> <span class="p">)</span>

    <span class="n">fesc</span> <span class="o">=</span>  <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cosh</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">K1</span> <span class="o">*</span> <span class="p">(</span> <span class="n">ta_Arr</span> <span class="o">**</span> <span class="n">K2</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">fesc</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Analytic_f_esc_Wind"><a class="viewcode-back" href="../funcs.html#funcs.Analytic_f_esc_Wind">[docs]</a><span class="k">def</span> <span class="nf">Analytic_f_esc_Wind</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the escape fraction computed analytically for the Galactic Wind</span>
<span class="sd">        (Gurung-lopez et al. 2019a)</span>

<span class="sd">        **Input**:</span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Ar : 1-D sequence of floats</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        **Output**:</span>

<span class="sd">        fesc :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">NH18</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span> <span class="n">logNH_Arr</span> <span class="o">-</span> <span class="mi">18</span> <span class="p">)</span>

    <span class="c1"># New MCMC</span>
    <span class="n">c11</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.4852541</span><span class="p">)</span>
    <span class="n">c12</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.2006394</span><span class="p">)</span>
    <span class="n">c21</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.912059</span><span class="p">)</span>
    <span class="n">c22</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.6380347</span><span class="p">)</span>
    <span class="n">c3</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mf">0.046314074999999996</span><span class="p">)</span>
    <span class="n">c4</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.782037</span><span class="p">)</span>

    <span class="n">C1</span>  <span class="o">=</span> <span class="n">c11</span> <span class="o">*</span> <span class="p">(</span> <span class="n">NH18</span> <span class="o">**</span> <span class="n">c12</span> <span class="p">)</span>
    <span class="n">C2</span>  <span class="o">=</span> <span class="n">c21</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">NH18</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c22</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">NH18</span><span class="p">)</span> <span class="c1">#+ c23</span>
    <span class="n">C3</span>  <span class="o">=</span> <span class="n">c3</span>
    <span class="n">C4</span>  <span class="o">=</span> <span class="n">c4</span>

    <span class="n">K1</span>  <span class="o">=</span> <span class="n">C1</span> <span class="o">*</span> <span class="n">V_Arr</span> <span class="o">**</span> <span class="n">C2</span>
    <span class="n">K2</span>  <span class="o">=</span> <span class="n">C3</span> <span class="o">*</span> <span class="n">V_Arr</span> <span class="o">**</span> <span class="n">C4</span>

    <span class="n">fesc</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cosh</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">K1</span> <span class="o">*</span> <span class="n">ta_Arr</span> <span class="o">**</span> <span class="n">K2</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">fesc</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="RT_f_esc_Analytic"><a class="viewcode-back" href="../funcs.html#funcs.RT_f_esc_Analytic">[docs]</a><span class="k">def</span>  <span class="nf">RT_f_esc_Analytic</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the escape fraction computed analytically</span>
<span class="sd">        (Gurung-lopez et al. 2019a, 2019b)</span>

<span class="sd">        **Input**:</span>
<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Arr : 1-D sequence of floats</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        **Output**:</span>

<span class="sd">        fesc :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">Geometry_Set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span>  <span class="p">]</span>

    <span class="k">assert</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="n">Geometry_Set</span> <span class="p">,</span> <span class="s1">&#39;The geometry &#39;</span> <span class="o">+</span> <span class="n">Geometry</span> <span class="o">+</span> <span class="s1">&#39; is nor supported in MODE=Analytic , only Thin_Shell and Galactic_Wind&#39;</span>

    <span class="n">logNH_Arr</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span> <span class="n">logNH_Arr</span> <span class="p">)</span>
    <span class="n">ta_Arr</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>    <span class="n">ta_Arr</span> <span class="p">)</span>
    <span class="n">V_Arr</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>     <span class="n">V_Arr</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="s1">&#39;Thin_Shell&#39;</span> <span class="p">:</span>
        <span class="n">f_esc_Arr</span> <span class="o">=</span> <span class="n">Analytic_f_esc_Thin_Shell</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="s1">&#39;Galactic_Wind&#39;</span> <span class="p">:</span>
        <span class="n">f_esc_Arr</span> <span class="o">=</span> <span class="n">Analytic_f_esc_Wind</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">f_esc_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="fesc_of_ta_Thin_and_Wind"><a class="viewcode-back" href="../funcs.html#funcs.fesc_of_ta_Thin_and_Wind">[docs]</a><span class="k">def</span> <span class="nf">fesc_of_ta_Thin_and_Wind</span><span class="p">(</span> <span class="n">ta</span> <span class="p">,</span> <span class="n">CCC</span> <span class="p">,</span> <span class="n">KKK</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Anallytic expression of the escape fraction as a function of the</span>
<span class="sd">        dust optical depth (Gurung-lopez et al. 2019a)</span>

<span class="sd">        **Input**:</span>

<span class="sd">        ta : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        CCC : float</span>
<span class="sd">                    CCC parameter</span>

<span class="sd">        KKK : float</span>
<span class="sd">                    KKK parameter</span>

<span class="sd">        **Output**:</span>

<span class="sd">        fesc :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">f_esc</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cosh</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">CCC</span> <span class="o">*</span> <span class="p">(</span><span class="n">ta</span><span class="o">**</span><span class="n">KKK</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">f_esc</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="fesc_of_ta_Bicone"><a class="viewcode-back" href="../funcs.html#funcs.fesc_of_ta_Bicone">[docs]</a><span class="k">def</span> <span class="nf">fesc_of_ta_Bicone</span><span class="p">(</span> <span class="n">ta</span> <span class="p">,</span> <span class="n">CCC</span> <span class="p">,</span> <span class="n">KKK</span> <span class="p">,</span> <span class="n">LLL</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Anallytic expression of the escape fraction as a function of the</span>
<span class="sd">        dust optical depth (Gurung-lopez et al. 2019b)</span>

<span class="sd">        **Input**:</span>

<span class="sd">        ta : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        CCC : float</span>
<span class="sd">                    CCC parameter</span>

<span class="sd">        KKK : float</span>
<span class="sd">                    KKK parameter</span>

<span class="sd">        LLL : float</span>
<span class="sd">                    LLL parameter</span>

<span class="sd">        **Output**:</span>

<span class="sd">        fesc :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>
 
    <span class="n">f_esc</span> <span class="o">=</span> <span class="n">LLL</span> <span class="o">*</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">cosh</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">CCC</span> <span class="o">*</span> <span class="p">(</span><span class="n">ta</span><span class="o">**</span><span class="n">KKK</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
 
    <span class="k">return</span> <span class="n">f_esc</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="RT_f_esc_Machine_Parameter"><a class="viewcode-back" href="../funcs.html#funcs.RT_f_esc_Machine_Parameter">[docs]</a><span class="k">def</span>  <span class="nf">RT_f_esc_Machine_Parameter</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">Machine_Learning_Algorithm</span><span class="o">=</span><span class="s1">&#39;Tree&#39;</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Anallytic expression of the escape fraction as a function of the</span>
<span class="sd">        dust optical depth (Gurung-lopez et al. 2019b). This uses the parametric</span>
<span class="sd">        expression of the escape fraction.</span>
<span class="sd">    </span>
<span class="sd">        **Input**:</span>
<span class="sd">    </span>
<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>
<span class="sd">                                       , &#39;Bicone_X_Slab_In&#39; , &#39;Bicone_X_Slab_Out&#39;</span>
<span class="sd">    </span>
<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Ar : 1-D sequence of floats</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>
<span class="sd">    </span>
<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>
<span class="sd">    </span>
<span class="sd">        Machine_Learning_Algorithm : string</span>
<span class="sd">                    Machine learning algorithm: &#39;KN&#39;, &#39;Grad&#39;, &#39;Tree&#39; or &#39;Forest&#39;</span>
<span class="sd">    </span>
<span class="sd">        **Output**:</span>
<span class="sd">    </span>
<span class="sd">        f_esc_Arr :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">logNH_Arr</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span> <span class="n">logNH_Arr</span> <span class="p">)</span>
    <span class="n">ta_Arr</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>    <span class="n">ta_Arr</span> <span class="p">)</span>
    <span class="n">V_Arr</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>     <span class="n">V_Arr</span> <span class="p">)</span>
    
    <span class="n">Coor_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="p">,</span> <span class="mi">2</span> <span class="p">)</span>
    
    <span class="n">Coor_matrix</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="n">V_Arr</span>
    <span class="n">Coor_matrix</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="n">logNH_Arr</span>
    
    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span>  <span class="p">]</span> <span class="p">:</span>
    
        <span class="n">CCC_machine</span> <span class="o">=</span> <span class="n">load_machine_fesc</span><span class="p">(</span> <span class="n">Machine_Learning_Algorithm</span> <span class="p">,</span> <span class="s1">&#39;CCC&#39;</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>
        <span class="n">KKK_machine</span> <span class="o">=</span> <span class="n">load_machine_fesc</span><span class="p">(</span> <span class="n">Machine_Learning_Algorithm</span> <span class="p">,</span> <span class="s1">&#39;KKK&#39;</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>
    
        <span class="n">CCC_model_Arr</span>  <span class="o">=</span> <span class="n">CCC_machine</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">Coor_matrix</span> <span class="p">)</span>
        <span class="n">KKK_model_Arr</span>  <span class="o">=</span> <span class="n">KKK_machine</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">Coor_matrix</span> <span class="p">)</span>
    
        <span class="n">f_esc_Arr</span> <span class="o">=</span> <span class="n">fesc_of_ta_Thin_and_Wind</span><span class="p">(</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">CCC_model_Arr</span> <span class="p">,</span> <span class="n">KKK_model_Arr</span> <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]</span> <span class="p">:</span>
    
        <span class="n">CCC_machine_in</span> <span class="o">=</span> <span class="n">load_machine_fesc</span><span class="p">(</span> <span class="n">Machine_Learning_Algorithm</span> <span class="p">,</span> <span class="s1">&#39;CCC&#39;</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>
        <span class="n">KKK_machine_in</span> <span class="o">=</span> <span class="n">load_machine_fesc</span><span class="p">(</span> <span class="n">Machine_Learning_Algorithm</span> <span class="p">,</span> <span class="s1">&#39;KKK&#39;</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>
        <span class="n">LLL_machine_in</span> <span class="o">=</span> <span class="n">load_machine_fesc</span><span class="p">(</span> <span class="n">Machine_Learning_Algorithm</span> <span class="p">,</span> <span class="s1">&#39;LLL&#39;</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>
    
        <span class="n">CCC_model_in_Arr</span>  <span class="o">=</span> <span class="n">CCC_machine_in</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">Coor_matrix</span> <span class="p">)</span>
        <span class="n">KKK_model_in_Arr</span>  <span class="o">=</span> <span class="n">KKK_machine_in</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">Coor_matrix</span> <span class="p">)</span>
        <span class="n">LLL_model_in_Arr</span>  <span class="o">=</span> <span class="n">LLL_machine_in</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">Coor_matrix</span> <span class="p">)</span>
    
        <span class="n">f_esc_Arr</span> <span class="o">=</span> <span class="n">fesc_of_ta_Bicone</span><span class="p">(</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">CCC_model_in_Arr</span> <span class="p">,</span> <span class="n">KKK_model_in_Arr</span> <span class="p">,</span> <span class="n">LLL_model_in_Arr</span> <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">f_esc_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="RT_f_esc_Machine_Values"><a class="viewcode-back" href="../funcs.html#funcs.RT_f_esc_Machine_Values">[docs]</a><span class="k">def</span>  <span class="nf">RT_f_esc_Machine_Values</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">Machine_Learning_Algorithm</span><span class="o">=</span><span class="s1">&#39;Tree&#39;</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Anallytic expression of the escape fraction as a function of the</span>
<span class="sd">        dust optical depth (Gurung-lopez et al. 2019b). This uses the directly</span>
<span class="sd">        the escape fraction.</span>

<span class="sd">        **Input**:</span>

<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>
<span class="sd">                                       , &#39;Bicone_X_Slab_In&#39; , &#39;Bicone_X_Slab_Out&#39;</span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Ar : 1-D sequence of floats</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        Machine_Learning_Algorithm : string</span>
<span class="sd">                    Machine learning algorithm: &#39;KN&#39;, &#39;Grad&#39;, &#39;Tree&#39; or &#39;Forest&#39;</span>

<span class="sd">        **Output**:</span>

<span class="sd">        f_esc_Arr :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">logNH_Arr</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span> <span class="n">logNH_Arr</span> <span class="p">)</span>
    <span class="n">ta_Arr</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>    <span class="n">ta_Arr</span> <span class="p">)</span>
    <span class="n">V_Arr</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>     <span class="n">V_Arr</span> <span class="p">)</span>
    
    <span class="n">Coor_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="p">,</span> <span class="mi">3</span> <span class="p">)</span>
    
    <span class="n">Coor_matrix</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="n">V_Arr</span>
    <span class="n">Coor_matrix</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="n">logNH_Arr</span>
    <span class="n">Coor_matrix</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ta_Arr</span><span class="p">)</span>
    
    <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">load_machine_fesc</span><span class="p">(</span> <span class="n">Machine_Learning_Algorithm</span> <span class="p">,</span> <span class="s1">&#39;f_esc&#39;</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>
    
    <span class="n">f_esc_Arr</span> <span class="o">=</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">Coor_matrix</span> <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">f_esc_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Linear_ND_interpolator"><a class="viewcode-back" href="../funcs.html#funcs.Linear_ND_interpolator">[docs]</a><span class="k">def</span> <span class="nf">Linear_ND_interpolator</span><span class="p">(</span> <span class="n">N_dim</span> <span class="p">,</span> <span class="n">Coor_props_Matrix</span> <span class="p">,</span> <span class="n">Coor_grid_list</span> <span class="p">,</span> <span class="n">Field_in_grid_Matrix</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Interpolates in an arbitrary dimension space        </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        N_dim : int</span>
<span class="sd">                Number of dimensions.</span>

<span class="sd">        Coor_props_Matrix : List of N_dim float values</span>
<span class="sd">                Coordenates in the N_dim space to evaluate.</span>
<span class="sd">                For example [ X , Y , Z ]</span>
<span class="sd">               </span>

<span class="sd">        Coor_grid_list : List of N_dim 1-D sequence of floats</span>
<span class="sd">                For example, if there is a field evaluated in X_Arr, Y_Arr, Z_Arr</span>
<span class="sd">                [ X_Arr , Y_Arr , Z_Arr ]</span>

<span class="sd">        Field_in_grid_Matrix : numpy array with the field to interpolate</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Field_at_the_prob_point :</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">dic_index</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">):</span>

        <span class="n">dic_index</span><span class="p">[</span><span class="s1">&#39;index_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="p">(</span> <span class="n">Coor_grid_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">Coor_props_Matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">dic_prob</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">):</span>

        <span class="n">INDEX</span> <span class="o">=</span> <span class="n">dic_index</span><span class="p">[</span><span class="s1">&#39;index_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">]</span>

        <span class="c1">#print( &#39;INDEX&#39; , INDEX)</span>

        <span class="n">diff_i</span> <span class="o">=</span> <span class="n">Coor_grid_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span> <span class="n">INDEX</span><span class="o">+</span><span class="mi">1</span> <span class="p">]</span> <span class="o">-</span> <span class="n">Coor_grid_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span> <span class="n">INDEX</span> <span class="p">]</span>

        <span class="n">min_i</span> <span class="o">=</span> <span class="n">Coor_grid_list</span><span class="p">[</span><span class="n">i</span><span class="p">][</span> <span class="n">INDEX</span> <span class="p">]</span>

        <span class="n">dic_prob</span><span class="p">[</span><span class="s1">&#39;prob_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">Coor_props_Matrix</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">min_i</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">diff_i</span>

        <span class="c1">#print( &#39;prob&#39; , dic_prob[&#39;prob_&#39; + str(i) ] )</span>

    <span class="n">N_points</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="n">N_dim</span>

    <span class="n">VOLs</span>   <span class="o">=</span> <span class="p">{}</span>
    <span class="n">FIELDs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_points</span> <span class="p">):</span>

        <span class="n">binary_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0:b}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span> <span class="n">N_dim</span> <span class="p">)</span>

        <span class="n">VOLs</span><span class="p">[</span> <span class="s1">&#39;vol_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="n">eval_INDEX</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">):</span>

            <span class="n">CTE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">binary_str</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">)</span>

            <span class="n">eval_INDEX</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">dic_index</span><span class="p">[</span><span class="s1">&#39;index_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">]</span> <span class="o">+</span> <span class="n">CTE</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">CTE</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">size_j</span> <span class="o">=</span> <span class="p">(</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">dic_prob</span><span class="p">[</span> <span class="s1">&#39;prob_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">]</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">CTE</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span> <span class="n">size_j</span> <span class="o">=</span> <span class="p">(</span>      <span class="n">dic_prob</span><span class="p">[</span> <span class="s1">&#39;prob_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">]</span> <span class="p">)</span>

            <span class="n">pre_vol</span> <span class="o">=</span> <span class="n">VOLs</span><span class="p">[</span> <span class="s1">&#39;vol_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span> <span class="p">]</span>

            <span class="n">VOLs</span><span class="p">[</span> <span class="s1">&#39;vol_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">pre_vol</span> <span class="o">*</span> <span class="n">size_j</span>

        <span class="n">eval_INDEX</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="n">eval_INDEX</span> <span class="p">)</span>

        <span class="n">FIELDs</span><span class="p">[</span><span class="s1">&#39;field_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">]</span> <span class="o">=</span> <span class="n">Field_in_grid_Matrix</span><span class="p">[</span> <span class="n">eval_INDEX</span> <span class="p">]</span>


    <span class="n">Zero_Zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">eval_INDEX</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">0</span>

    <span class="n">Zero_Zero</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span> <span class="n">Zero_Zero</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span> <span class="p">)</span>

    <span class="n">Field_at_the_prob_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span> <span class="n">Field_in_grid_Matrix</span><span class="p">[</span><span class="n">Zero_Zero</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_points</span> <span class="p">)</span> <span class="p">:</span>

        <span class="c1">#print( VOLs[ &#39;vol_&#39; + str( i ) ] , FIELDs[&#39;field_&#39; + str(i) ] )</span>

        <span class="n">Field_at_the_prob_point</span> <span class="o">+=</span> <span class="n">VOLs</span><span class="p">[</span> <span class="s1">&#39;vol_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">i</span> <span class="p">)</span> <span class="p">]</span> <span class="o">*</span> <span class="n">FIELDs</span><span class="p">[</span><span class="s1">&#39;field_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">]</span>

    <span class="k">return</span> <span class="n">Field_at_the_prob_point</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="load_Grid_fesc"><a class="viewcode-back" href="../funcs.html#funcs.load_Grid_fesc">[docs]</a><span class="k">def</span> <span class="nf">load_Grid_fesc</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">MODE</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This functions gives you grids of the escape fraction</span>

<span class="sd">        **Input**:</span>

<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>
<span class="sd">                                       , &#39;Bicone_X_Slab_In&#39; , &#39;Bicone_X_Slab_Out&#39;</span>
<span class="sd">        MODE : String</span>
<span class="sd">                    Parametrization of the escape fraction. &#39;Parameters&#39; or &#39;values&#39;</span>
<span class="sd">        **Output**:</span>

<span class="sd">        loaded_model : file the grid of f_esc parameters/values.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">Geometry_Set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span><span class="p">]</span>

    <span class="n">geo_code</span>     <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Wind&#39;</span>           <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab&#39;</span> <span class="p">]</span>

    <span class="n">MODE_Set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Parameters&#39;</span> <span class="p">,</span> <span class="s1">&#39;values&#39;</span> <span class="p">]</span>

    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Geometry_Set</span><span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">filename_root</span> <span class="o">=</span> <span class="s1">&#39;Dictonary_&#39;</span><span class="o">+</span> <span class="n">geo_code</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;_Grid_f_esc_&#39;</span> <span class="o">+</span> <span class="n">MODE</span> 

    <span class="k">if</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span><span class="p">:</span>
        <span class="n">filename_root</span> <span class="o">+=</span> <span class="s1">&#39;_Inside_Bicone_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span><span class="p">:</span>
        <span class="n">filename_root</span> <span class="o">+=</span> <span class="s1">&#39;_Inside_Bicone_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_root</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span>

    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">Data_location</span> <span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

    <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">filename</span> <span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span> <span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">loaded_model</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Interpolate_f_esc_Arrays_2D_grid"><a class="viewcode-back" href="../funcs.html#funcs.Interpolate_f_esc_Arrays_2D_grid">[docs]</a><span class="k">def</span> <span class="nf">Interpolate_f_esc_Arrays_2D_grid</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">Grid_Dictionary</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the escape fraction using the escape fraction grids of parameters</span>

<span class="sd">        **Input**:</span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Ar : 1-D sequence of floats</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        Grid_Dictionary : python dictionary</span>
<span class="sd">                    Constains the grid to compute the escape fraction. Loaded with</span>
<span class="sd">                    load_Grid_fesc().</span>

<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>
<span class="sd">                                       , &#39;Bicone_X_Slab_In&#39; , &#39;Bicone_X_Slab_Out&#39;</span>
<span class="sd">                    </span>
<span class="sd">        **Output**:</span>

<span class="sd">        f_esc_Arr :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">V_Arr_Grid</span>     <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span>     <span class="s1">&#39;V_Arr&#39;</span> <span class="p">]</span>

    <span class="n">logNH_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span> <span class="s1">&#39;logNH_Arr&#39;</span> <span class="p">]</span>

    <span class="n">logta_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span> <span class="s1">&#39;logta_Arr&#39;</span> <span class="p">]</span>

    <span class="n">Grid</span>           <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span>    <span class="s1">&#39;Grid&#39;</span>   <span class="p">]</span>

    <span class="n">N_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">)</span>

    <span class="n">CCC_Arr_evaluated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_objects</span> <span class="p">)</span>
    <span class="n">KKK_Arr_evaluated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_objects</span> <span class="p">)</span>

    <span class="c1">###################</span>

    <span class="n">Coor_grid_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">V_Arr_Grid</span> <span class="p">,</span> <span class="n">logNH_Arr_Grid</span> <span class="p">]</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span>  <span class="p">]</span> <span class="p">:</span>

        <span class="k">for</span> <span class="n">INDEX</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_objects</span> <span class="p">):</span>

            <span class="n">Coor_props_Matrix</span> <span class="o">=</span> <span class="p">[</span> <span class="n">V_Arr</span><span class="p">[</span><span class="n">INDEX</span><span class="p">]</span> <span class="p">,</span> <span class="n">logNH_Arr</span><span class="p">[</span><span class="n">INDEX</span><span class="p">]</span> <span class="p">]</span>

            <span class="c1">#CCC_Arr_evaluated[ INDEX ] , KKK_Arr_evaluated[ INDEX ] = Linear_2D_interpolator( V_Arr[INDEX] , logNH_Arr[INDEX] , V_Arr_Grid , logNH_Arr_Grid , Grid )</span>
            <span class="n">CCC_Arr_evaluated</span><span class="p">[</span> <span class="n">INDEX</span> <span class="p">]</span> <span class="p">,</span> <span class="n">KKK_Arr_evaluated</span><span class="p">[</span> <span class="n">INDEX</span> <span class="p">]</span> <span class="o">=</span> <span class="n">Linear_ND_interpolator</span><span class="p">(</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">Coor_props_Matrix</span> <span class="p">,</span> <span class="n">Coor_grid_list</span> <span class="p">,</span> <span class="n">Grid</span> <span class="p">)</span>

        <span class="n">f_esc_Arr</span> <span class="o">=</span> <span class="n">fesc_of_ta_Thin_and_Wind</span><span class="p">(</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">CCC_Arr_evaluated</span> <span class="p">,</span> <span class="n">KKK_Arr_evaluated</span> <span class="p">)</span>

    <span class="c1">###################</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]</span> <span class="p">:</span>
    
        <span class="n">LLL_Arr_evaluated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_objects</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">INDEX</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_objects</span> <span class="p">):</span>

            <span class="n">Coor_props_Matrix</span> <span class="o">=</span> <span class="p">[</span> <span class="n">V_Arr</span><span class="p">[</span><span class="n">INDEX</span><span class="p">]</span> <span class="p">,</span> <span class="n">logNH_Arr</span><span class="p">[</span><span class="n">INDEX</span><span class="p">]</span> <span class="p">]</span>

            <span class="c1">#CCC_Arr_evaluated[ INDEX ] , KKK_Arr_evaluated[ INDEX ] , LLL_Arr_evaluated[ INDEX ] = Linear_2D_interpolator( V_Arr[INDEX] , logNH_Arr[INDEX] , V_Arr_Grid , logNH_Arr_Grid , Grid )</span>
            <span class="n">CCC_Arr_evaluated</span><span class="p">[</span> <span class="n">INDEX</span> <span class="p">]</span> <span class="p">,</span> <span class="n">KKK_Arr_evaluated</span><span class="p">[</span> <span class="n">INDEX</span> <span class="p">]</span> <span class="p">,</span> <span class="n">LLL_Arr_evaluated</span><span class="p">[</span> <span class="n">INDEX</span> <span class="p">]</span> <span class="o">=</span> <span class="n">Linear_ND_interpolator</span><span class="p">(</span> <span class="mi">2</span> <span class="p">,</span> <span class="n">Coor_props_Matrix</span> <span class="p">,</span> <span class="n">Coor_grid_list</span> <span class="p">,</span> <span class="n">Grid</span> <span class="p">)</span>

        <span class="n">f_esc_Arr</span> <span class="o">=</span> <span class="n">fesc_of_ta_Bicone</span><span class="p">(</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">CCC_Arr_evaluated</span> <span class="p">,</span> <span class="n">KKK_Arr_evaluated</span> <span class="p">,</span> <span class="n">LLL_Arr_evaluated</span> <span class="p">)</span>


    <span class="k">return</span> <span class="n">f_esc_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Interpolate_fesc_Arrays_3D_grid"><a class="viewcode-back" href="../funcs.html#funcs.Interpolate_fesc_Arrays_3D_grid">[docs]</a><span class="k">def</span> <span class="nf">Interpolate_fesc_Arrays_3D_grid</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">Grid_Dictionary</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the escape fraction using the escape fraction grids of parameters</span>

<span class="sd">        **Input**:</span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Ar : 1-D sequence of floats</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        Grid_Dictionary : python dictionary</span>
<span class="sd">                    Constains the grid to compute the escape fraction. Loaded with</span>
<span class="sd">                    load_Grid_fesc().</span>

<span class="sd">        **Output**:</span>

<span class="sd">        f_esc_Arr_evaluated :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">V_Arr_Grid</span>     <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span>     <span class="s1">&#39;V_Arr&#39;</span> <span class="p">]</span>

    <span class="n">logNH_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span> <span class="s1">&#39;logNH_Arr&#39;</span> <span class="p">]</span>

    <span class="n">logta_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span> <span class="s1">&#39;logta_Arr&#39;</span> <span class="p">]</span>

    <span class="n">Grid</span>           <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span>    <span class="s1">&#39;Grid&#39;</span>   <span class="p">]</span>

    <span class="n">logta_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">ta_Arr</span> <span class="p">)</span>

    <span class="n">N_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">)</span>

    <span class="n">f_esc_Arr_evaluated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_objects</span> <span class="p">)</span>

    <span class="n">Coor_Arr_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">V_Arr_Grid</span> <span class="p">,</span> <span class="n">logNH_Arr_Grid</span> <span class="p">,</span> <span class="n">logta_Arr_Grid</span> <span class="p">]</span>

    <span class="k">for</span> <span class="n">INDEX</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_objects</span> <span class="p">):</span>

        <span class="c1">#f_esc_Arr_evaluated[ INDEX ] = Linear_3D_interpolator( V_Arr[INDEX] , logNH_Arr[INDEX] , logta_Arr[INDEX] , V_Arr_Grid , logNH_Arr_Grid , logta_Arr_Grid , Grid )</span>
    
        <span class="n">Coor_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">V_Arr</span><span class="p">[</span><span class="n">INDEX</span><span class="p">]</span> <span class="p">,</span> <span class="n">logNH_Arr</span><span class="p">[</span><span class="n">INDEX</span><span class="p">]</span> <span class="p">,</span> <span class="n">logta_Arr</span><span class="p">[</span><span class="n">INDEX</span><span class="p">]</span> <span class="p">]</span>

        <span class="n">f_esc_Arr_evaluated</span><span class="p">[</span> <span class="n">INDEX</span> <span class="p">]</span> <span class="o">=</span> <span class="n">Linear_ND_interpolator</span><span class="p">(</span> <span class="mi">3</span> <span class="p">,</span> <span class="n">Coor_list</span> <span class="p">,</span> <span class="n">Coor_Arr_list</span> <span class="p">,</span> <span class="n">Grid</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">f_esc_Arr_evaluated</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="RT_f_esc_Interpolation_Values"><a class="viewcode-back" href="../funcs.html#funcs.RT_f_esc_Interpolation_Values">[docs]</a><span class="k">def</span>  <span class="nf">RT_f_esc_Interpolation_Values</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">Machine_Learning_Algorithm</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the escape fraction using the escape fraction grids of values</span>

<span class="sd">        **Input**:</span>

<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>
<span class="sd">                                       , &#39;Bicone_X_Slab_In&#39; , &#39;Bicone_X_Slab_Out&#39;</span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Ar : 1-D sequence of floats</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        Machine_Learning_Algorithm : String</span>
<span class="sd">                    Kind of algorithm: &#39;KN&#39;, &#39;Grad&#39;, &#39;Tree&#39; or &#39;Forest&#39;</span>

<span class="sd">        **Output**:</span>

<span class="sd">        f_esc_Arr :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">logNH_Arr</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span> <span class="n">logNH_Arr</span> <span class="p">)</span>
    <span class="n">ta_Arr</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>    <span class="n">ta_Arr</span> <span class="p">)</span>
    <span class="n">V_Arr</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>     <span class="n">V_Arr</span> <span class="p">)</span>

    <span class="n">DATA_DICTIONAY</span> <span class="o">=</span> <span class="n">load_Grid_fesc</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="s1">&#39;values&#39;</span> <span class="p">)</span>

    <span class="n">f_esc_Arr</span> <span class="o">=</span> <span class="n">Interpolate_fesc_Arrays_3D_grid</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">DATA_DICTIONAY</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">f_esc_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="RT_f_esc_Interpolation_Parameters"><a class="viewcode-back" href="../funcs.html#funcs.RT_f_esc_Interpolation_Parameters">[docs]</a><span class="k">def</span>  <span class="nf">RT_f_esc_Interpolation_Parameters</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">Machine_Learning_Algorithm</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the escape fraction using the escape fraction grids of parameters</span>

<span class="sd">        **Input**:</span>

<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>
<span class="sd">                                       , &#39;Bicone_X_Slab_In&#39; , &#39;Bicone_X_Slab_Out&#39;</span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Ar : 1-D sequence of floats</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        Machine_Learning_Algorithm : String</span>
<span class="sd">                    Kind of algorithm: &#39;KN&#39;, &#39;Grad&#39;, &#39;Tree&#39; or &#39;Forest&#39;</span>

<span class="sd">        **Output**:</span>

<span class="sd">        f_esc_Arr :  1-D sequence of floats</span>
<span class="sd">                    Escape fractions for the input configurations [no dimensions] </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">logNH_Arr</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span> <span class="n">logNH_Arr</span> <span class="p">)</span>
    <span class="n">ta_Arr</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>    <span class="n">ta_Arr</span> <span class="p">)</span>
    <span class="n">V_Arr</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>     <span class="n">V_Arr</span> <span class="p">)</span>

    <span class="n">DATA_DICTIONAY</span> <span class="o">=</span> <span class="n">load_Grid_fesc</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="s1">&#39;Parameters&#39;</span> <span class="p">)</span>

    <span class="n">f_esc_Arr</span> <span class="o">=</span> <span class="n">Interpolate_f_esc_Arrays_2D_grid</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">DATA_DICTIONAY</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">f_esc_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="pre_treatment_f_esc"><a class="viewcode-back" href="../funcs.html#funcs.pre_treatment_f_esc">[docs]</a><span class="k">def</span> <span class="nf">pre_treatment_f_esc</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">MODE</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks the inflow/outflow parameters before doing the proper computation.</span>

<span class="sd">        **Input**:</span>

<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>
<span class="sd">                                       , &#39;Bicone_X_Slab_In&#39; , &#39;Bicone_X_Slab_Out&#39;</span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Ar : 1-D sequence of floats</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        MODE : optional string</span>
<span class="sd">               Set the mode in which the escape fraction is computed. It can be:</span>
<span class="sd">                    Analytic        : it uses an analytic equation fitted to the output of the RT MC code.</span>
<span class="sd">                    Parametrization : it computes the escape fraction using a function that depends on the </span>
<span class="sd">                                      dust optical depts as in Neufeld et al. 1990.</span>
<span class="sd">                    Raw             : it uses directly the output of the RT MC code.</span>

<span class="sd">                    Default = &#39;Parametrization&#39;</span>

<span class="sd">                    Kind of algorithm: &#39;KN&#39;, &#39;Grad&#39;, &#39;Tree&#39; or &#39;Forest&#39;</span>

<span class="sd">        **Output**:</span>

<span class="sd">        mask_good : 1-D sequence of bool</span>
<span class="sd">                    1 if the parameters are good, 0 if they are bad.  </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">V_Arr</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>     <span class="n">V_Arr</span> <span class="p">)</span>
    <span class="n">logNH_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span> <span class="n">logNH_Arr</span> <span class="p">)</span>
    <span class="n">ta_Arr</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>    <span class="n">ta_Arr</span> <span class="p">)</span>

    <span class="n">V_Arr</span>     <span class="o">=</span>     <span class="n">V_Arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">logNH_Arr</span> <span class="o">=</span> <span class="n">logNH_Arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">ta_Arr</span>    <span class="o">=</span>    <span class="n">ta_Arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">bool1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span> <span class="n">V_Arr</span>     <span class="p">)</span>
    <span class="n">bool2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span> <span class="n">logNH_Arr</span> <span class="p">)</span>
    <span class="n">bool3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span> <span class="n">ta_Arr</span>    <span class="p">)</span>

    <span class="n">mask_good</span> <span class="o">=</span> <span class="n">bool1</span> <span class="o">*</span> <span class="n">bool2</span> <span class="o">*</span> <span class="n">bool3</span>
    
    <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">mask_good</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">,</span> <span class="s1">&#39;All the V-logNH-ta combinations are np.nan, -np.inf or np.inf&#39;</span>

    <span class="c1">#============================================#</span>
    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]</span> <span class="p">:</span>
        <span class="n">tmp_bool1</span> <span class="o">=</span> <span class="n">V_Arr</span> <span class="o">&lt;</span> <span class="mf">100.0</span>
        <span class="n">tmp_bool2</span> <span class="o">=</span> <span class="n">logNH_Arr</span> <span class="o">&gt;=</span> <span class="mf">20.5</span>

        <span class="n">tmp_mask</span> <span class="o">=</span> <span class="n">tmp_bool1</span> <span class="o">*</span> <span class="n">tmp_bool2</span>   

        <span class="n">mask_good</span> <span class="o">=</span> <span class="n">mask_good</span> <span class="o">*</span> <span class="o">~</span><span class="n">tmp_mask</span>
 
    <span class="c1">#============================================#</span>

    <span class="n">bool5</span> <span class="o">=</span> <span class="n">V_Arr</span> <span class="o">&gt;=</span> <span class="mf">10.00</span> 

    <span class="n">bool6</span> <span class="o">=</span> <span class="n">V_Arr</span> <span class="o">&lt;=</span> <span class="mi">1000</span>
    
    <span class="n">bool7</span> <span class="o">=</span> <span class="n">logNH_Arr</span> <span class="o">&gt;=</span> <span class="mf">17.0</span>

    <span class="n">bool8</span> <span class="o">=</span> <span class="n">logNH_Arr</span> <span class="o">&lt;=</span> <span class="mf">22.0</span>

    <span class="n">mask_good</span> <span class="o">=</span> <span class="n">mask_good</span> <span class="o">*</span> <span class="p">(</span> <span class="n">bool5</span> <span class="o">*</span> <span class="n">bool6</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">bool7</span> <span class="o">*</span> <span class="n">bool8</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">MODE</span><span class="o">==</span><span class="s1">&#39;Raw&#39;</span><span class="p">:</span>
        <span class="n">bool9</span> <span class="o">=</span> <span class="n">ta_Arr</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">)</span>

        <span class="n">bool10</span> <span class="o">=</span> <span class="n">ta_Arr</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.25</span><span class="p">)</span>

        <span class="n">mask_good</span> <span class="o">=</span> <span class="n">mask_good</span> <span class="o">*</span> <span class="p">(</span> <span class="n">bool9</span> <span class="o">*</span> <span class="n">bool10</span> <span class="p">)</span>

    <span class="c1">#return V_Arr_used , logNH_Arr_used , ta_Arr_used , In_Bool_used , mask_good</span>
    <span class="k">return</span> <span class="n">mask_good</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="RT_f_esc"><a class="viewcode-back" href="../funcs.html#funcs.RT_f_esc">[docs]</a><span class="k">def</span>  <span class="nf">RT_f_esc</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">MODE</span><span class="o">=</span><span class="s1">&#39;Parametrization&#39;</span> <span class="p">,</span> <span class="n">Algorithm</span><span class="o">=</span><span class="s1">&#39;Intrepolation&#39;</span> <span class="p">,</span> <span class="n">Machine_Learning_Algorithm</span><span class="o">=</span><span class="s1">&#39;Tree&#39;</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the Lyman alpha escape fraction for a given outflow properties.</span>

<span class="sd">        **Input**</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   The outflow geometry to use: Options: &#39;Thins_Shell&#39;,</span>
<span class="sd">                   &#39;Galactic_Wind&#39; , &#39;Bicone_X_Slab&#39;.</span>

<span class="sd">        V_Arr : 1-D sequence of float</span>
<span class="sd">                Array with the expansion velocity of the outflow. The unit</span>
<span class="sd">                are km/s. </span>

<span class="sd">        logNH_Arr : 1-D sequence of float</span>
<span class="sd">                    Array with the logarithim of the outflow neutral hydrogen</span>
<span class="sd">                    column density. The units of the colum density are in c.g.s,</span>
<span class="sd">                    i.e, cm**-2.</span>

<span class="sd">        ta_Arr : 1-D sequence of float</span>
<span class="sd">                 Array with the dust optic depth of the outflow. </span>

<span class="sd">        MODE : optional string</span>
<span class="sd">               Set the mode in which the escape fraction is computed. It can be:</span>
<span class="sd">                    Analytic        : it uses an analytic equation fitted to the output of the RT MC code.</span>
<span class="sd">                    Parametrization : it computes the escape fraction using a function that depends on the </span>
<span class="sd">                                      dust optical depts as in Neufeld et al. 1990.</span>
<span class="sd">                    Raw             : it uses directly the output of the RT MC code.</span>

<span class="sd">                Default = &#39;Parametrization&#39;</span>


<span class="sd">        Algorithm : optional string</span>
<span class="sd">                Set how the escape fraction is computed. If MODE=&#39;Analytic&#39; then this varialbe is useless.</span>
<span class="sd">                    Intrepolation    : Direct lineal interpolation.</span>
<span class="sd">                    Machine_Learning : uses machine learning algorithms</span>
<span class="sd">        </span>
<span class="sd">                Default = &#39;Intrepolation&#39;</span>


<span class="sd">        Machine_Learning_Algorithm : optial string</span>
<span class="sd">                Set the machine learning algorith used. Available:</span>
<span class="sd">                    Tree   : decision tree</span>
<span class="sd">                    Forest : random forest</span>
<span class="sd">                    KN     : KN</span>

<span class="sd">                Default = &#39;Tree&#39;</span>


<span class="sd">        **Output**</span>

<span class="sd">        lines_Arr : 1-D sequence of float</span>
<span class="sd">                    The Lyman alpha escape fraction for V_Arr[i] ,</span>
<span class="sd">                    logNH_Arr[i] , ta_Arr[i] , Inside_Bicone_Arr[i].</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="n">MODE</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Parametrization&#39;</span> <span class="p">,</span> <span class="s1">&#39;Raw&#39;</span> <span class="p">,</span> <span class="s1">&#39;Analytic&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="s1">&#39;The requested mode &#39;</span> <span class="o">+</span> <span class="n">MODE</span> <span class="o">+</span> <span class="s1">&#39; is not available. The modes supported are : Parametrization , Raw , Analytic&#39;</span> 

    <span class="k">assert</span> <span class="n">Algorithm</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Intrepolation&#39;</span> <span class="p">,</span> <span class="s1">&#39;Machine_Learning&#39;</span> <span class="p">]</span> <span class="p">,</span> <span class="s1">&#39;The requested algorithm &#39;</span> <span class="o">+</span> <span class="n">Algorithm</span> <span class="o">+</span> <span class="s1">&#39; is not available. The algorithms supported are : Intrepolation , Machine_Learning&#39;</span> 

    <span class="k">assert</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span> <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]</span> <span class="p">,</span> <span class="s1">&#39;The requested geoemtry &#39;</span> <span class="o">+</span> <span class="n">Geometry</span> <span class="o">+</span> <span class="s1">&#39; is not available. The geometries supported are : Thin_Shell , Galactic_Wind , Bicone_X_Slab&#39;</span>
    
    <span class="n">mask_good</span> <span class="o">=</span> <span class="n">pre_treatment_f_esc</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">MODE</span> <span class="p">)</span> 

    <span class="c1">#print( &#39;fraction good confs = &#39; , np.sum(mask_good) * 1. / len(mask_good)  )</span>

    <span class="n">f_esc_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">mask_good</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="k">if</span> <span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;Parametrization&#39;</span>  <span class="p">:</span>

        <span class="k">if</span> <span class="n">Algorithm</span> <span class="o">==</span> <span class="s1">&#39;Intrepolation&#39;</span> <span class="p">:</span>
            <span class="n">funtion_to_use</span> <span class="o">=</span> <span class="n">RT_f_esc_Interpolation_Parameters</span> 

        <span class="k">if</span> <span class="n">Algorithm</span> <span class="o">==</span> <span class="s1">&#39;Machine_Learning&#39;</span><span class="p">:</span>
            <span class="n">funtion_to_use</span> <span class="o">=</span> <span class="n">RT_f_esc_Machine_Parameter</span>

    <span class="k">if</span> <span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;Raw&#39;</span>  <span class="p">:</span>

        <span class="k">if</span> <span class="n">Algorithm</span> <span class="o">==</span> <span class="s1">&#39;Intrepolation&#39;</span> <span class="p">:</span>
            <span class="n">funtion_to_use</span> <span class="o">=</span> <span class="n">RT_f_esc_Interpolation_Values</span>

        <span class="k">if</span> <span class="n">Algorithm</span> <span class="o">==</span> <span class="s1">&#39;Machine_Learning&#39;</span><span class="p">:</span>
            <span class="n">funtion_to_use</span> <span class="o">=</span> <span class="n">RT_f_esc_Machine_Values</span>

    <span class="k">if</span> <span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;Analytic&#39;</span> <span class="p">:</span>

        <span class="n">funtion_to_use</span> <span class="o">=</span> <span class="n">RT_f_esc_Analytic</span>        

    <span class="n">f_esc_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="o">=</span> <span class="n">funtion_to_use</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">logNH_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">ta_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">Machine_Learning_Algorithm</span><span class="o">=</span><span class="n">Machine_Learning_Algorithm</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">f_esc_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="define_RT_parameters"><a class="viewcode-back" href="../funcs.html#funcs.define_RT_parameters">[docs]</a><span class="k">def</span> <span class="nf">define_RT_parameters</span><span class="p">(</span> <span class="n">T4</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function gives the parameters use to compute useful </span>
<span class="sd">        variables when working with radiative transfer.</span>

<span class="sd">        **Input**:</span>

<span class="sd">        T4 : optional float</span>
<span class="sd">            Temperature in units of 10**4 K:</span>
<span class="sd">            T4 = T[k] / 10**4</span>

<span class="sd">        **Output**:</span>

<span class="sd">        nu0 : float</span>
<span class="sd">            Lyaman-alpha frequency.</span>

<span class="sd">        Dv : float</span>
<span class="sd">            </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">T4</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>  
       <span class="n">T4</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c1"># = 10000. / 1e4</span>

    <span class="n">nu0</span> <span class="o">=</span> <span class="mf">2.46777</span> <span class="o">*</span> <span class="mf">1.e15</span> <span class="c1">#3. * 10.**8 / (1215.67 * (10**(-10)))</span>
    <span class="n">Vth</span> <span class="o">=</span> <span class="mf">12.85</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T4</span><span class="p">)</span> <span class="c1"># lo he comentado porque sqrt(1) = 1</span>
    <span class="n">Dv</span> <span class="o">=</span> <span class="n">Vth</span> <span class="o">*</span> <span class="n">nu0</span> <span class="o">*</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">5</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nu0</span> <span class="p">,</span> <span class="n">Dv</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="convert_x_into_lamda"><a class="viewcode-back" href="../funcs.html#funcs.convert_x_into_lamda">[docs]</a><span class="k">def</span> <span class="nf">convert_x_into_lamda</span><span class="p">(</span> <span class="n">x</span> <span class="p">,</span> <span class="n">T4</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function converts from frequency in Doppler</span>
<span class="sd">        units to wavelength</span>

<span class="sd">        **Input**:</span>

<span class="sd">        x : 1-D sequence of float</span>
<span class="sd">            Frequency in Doppler units.</span>

<span class="sd">        T4 : optional float</span>
<span class="sd">            Temperature in units of 10**4 K:</span>
<span class="sd">            T4 = T[k] / 10**4</span>

<span class="sd">        **Output**:</span>

<span class="sd">        w_Arr : 1-D sequence of float</span>
<span class="sd">                wavelength.        </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">T4</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>  
        <span class="n">T4</span> <span class="o">=</span> <span class="mf">1.</span> <span class="c1"># = 10000. / 1e4</span>

    <span class="n">nu0</span> <span class="o">=</span> <span class="mf">2.46777</span> <span class="o">*</span> <span class="mf">1.e15</span> <span class="c1">#3. * 10.**8 / (1215.67 * (10**(-10)))</span>
    <span class="n">Vth</span> <span class="o">=</span> <span class="mf">12.85</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T4</span><span class="p">)</span> <span class="c1"># lo he comentado porque sqrt(1) = 1</span>
    <span class="n">Dv</span> <span class="o">=</span> <span class="n">Vth</span> <span class="o">*</span> <span class="n">nu0</span> <span class="o">*</span><span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">5</span><span class="p">))</span>
    <span class="n">nu0</span> <span class="p">,</span> <span class="n">Dv</span> <span class="o">=</span> <span class="n">define_RT_parameters</span><span class="p">(</span> <span class="n">T4</span> <span class="p">)</span> 
    <span class="n">w_Arr</span> <span class="o">=</span> <span class="mf">3.</span> <span class="o">*</span> <span class="mf">1.e8</span> <span class="o">/</span> <span class="p">(</span> <span class="n">x</span> <span class="o">*</span> <span class="n">Dv</span> <span class="o">+</span> <span class="n">nu0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">w_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="convert_lamda_into_x"><a class="viewcode-back" href="../funcs.html#funcs.convert_lamda_into_x">[docs]</a><span class="k">def</span> <span class="nf">convert_lamda_into_x</span><span class="p">(</span> <span class="n">lamda</span> <span class="p">,</span> <span class="n">T4</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function converts from frequency in Doppler</span>
<span class="sd">        units to wavelength</span>

<span class="sd">        **Input**:</span>

<span class="sd">        lamda : 1-D sequence of float</span>
<span class="sd">            wavelength</span>

<span class="sd">        T4 : optional float</span>
<span class="sd">            Temperature in units of 10**4 K:</span>
<span class="sd">            T4 = T[k] / 10**4</span>

<span class="sd">        **Output**:</span>

<span class="sd">        x_Arr : 1-D sequence of float</span>
<span class="sd">                Frequency in Doppler units.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">nu0</span> <span class="p">,</span> <span class="n">Dv</span> <span class="o">=</span> <span class="n">define_RT_parameters</span><span class="p">(</span> <span class="n">T4</span> <span class="p">)</span> 
    <span class="n">x_Arr</span> <span class="o">=</span> <span class="p">((</span> <span class="mf">3.</span> <span class="o">*</span> <span class="mf">1.e8</span> <span class="o">/</span> <span class="n">lamda</span><span class="p">)</span> <span class="o">-</span><span class="n">nu0</span> <span class="p">)</span> <span class="o">/</span> <span class="n">Dv</span>
    <span class="k">return</span> <span class="n">x_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="load_Grid_Line"><a class="viewcode-back" href="../funcs.html#funcs.load_Grid_Line">[docs]</a><span class="k">def</span> <span class="nf">load_Grid_Line</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">MODE</span><span class="o">=</span><span class="s1">&#39;FULL&#39;</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the dictionary with all the properties of the grid where the lines were run.</span>

<span class="sd">        **Input**</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   The outflow geometry to use: Options: &#39;Thins_Shell&#39;,</span>
<span class="sd">                   &#39;Galactic_Wind&#39; , &#39;Bicone_X_Slab_In&#39;, &#39;Bicone_X_Slab_Out&#39;,</span>
<span class="sd">                   &#39;Thin_Shell_Cont&#39;.</span>

<span class="sd">        MODE : optinal string.</span>
<span class="sd">               For the &#39;Thin_Shell_Cont&#39; ONLY. Defines the grid to be loaded.</span>
<span class="sd">               MODE=&#39;FULL&#39;  loads a very dense  grid. ~12GB of RAM.</span>
<span class="sd">               MODE=&#39;LIGHT&#39; loads a more sparse grid. ~ 2GB of RAM.</span>

<span class="sd">        **Output**</span>

<span class="sd">        loaded_model : Dictionary</span>
<span class="sd">                       This dictonary have all the information of the grid.</span>
<span class="sd">                       Entries:</span>
<span class="sd">                            &#39;V_Arr&#39;     : Array of velocity expansions used.[km/s]</span>
<span class="sd">                            &#39;logNH_Arr&#39; : Array of logarithm of the column density. [c.g.s.]</span>
<span class="sd">                            &#39;logta_Arr&#39; : Array of logarithm of the dust optical depth.</span>
<span class="sd">                            &#39;x_Arr&#39;     : Array of frequency in Doppler  units.</span>
<span class="sd">                            &#39;Grid&#39;      : Array with the output of the RT MC code LyaRT:</span>
<span class="sd">                                         </span>
<span class="sd">                                loaded_model[&#39;Grid&#39;][i,j,k,:] has the line profile evaluated in loaded_model[&#39;x_Arr&#39;]</span>
<span class="sd">                                with outflow velocity loaded_model[&#39;V_Arr&#39;][i] , logarithm of the neutral hydrogen </span>
<span class="sd">                                column density loaded_model[&#39;logNH_Arr&#39;][j] and logarithm of dust optical depth </span>
<span class="sd">                                loaded_model[&#39;logta_Arr&#39;][k]  </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span> <span class="p">,</span> <span class="s1">&#39;Thin_Shell&#39;</span> <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]</span> <span class="p">,</span> <span class="s1">&#39;The requested geoemtry &#39;</span> <span class="o">+</span> <span class="n">Geometry</span> <span class="o">+</span> <span class="s1">&#39;  is not available. The geometries supported are : Thin_Shell , Galactic_Wind , Bicone_X_Slab&#39;</span>

    <span class="n">Geometry_Set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]</span>

    <span class="n">geo_code</span>     <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Wind&#39;</span>           <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab&#39;</span> <span class="p">]</span>

    <span class="c1">#this_dir, this_filename = os.path.split(__file__)</span>

    <span class="c1">#print( &#39;HARDCORING PATH TO GRIDS!!!!&#39; )</span>
    <span class="c1">#this_dir = &#39;/global/users/sidgurung/PROMARE/Grids/&#39;</span>
    <span class="c1">#this_dir = &#39;/global/users/sidgurung/PROMARE/Grids/&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span> <span class="p">,</span> <span class="s1">&#39;Thin_Shell_Cont_Light&#39;</span> <span class="p">]</span> <span class="p">:</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Geometry_Set</span><span class="p">)</span> <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">filename_root</span> <span class="o">=</span> <span class="s1">&#39;Dictonary_&#39;</span><span class="o">+</span> <span class="n">geo_code</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;_Grid_Lines&#39;</span>

        <span class="k">if</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span><span class="p">:</span>
            <span class="n">filename_root</span> <span class="o">+=</span> <span class="s1">&#39;_In_Bicone_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span><span class="p">:</span>
            <span class="n">filename_root</span> <span class="o">+=</span> <span class="s1">&#39;_In_Bicone_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">filename_root</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">Data_location</span> <span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

        <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">filename</span> <span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span> <span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span> <span class="p">,</span> <span class="s1">&#39;Thin_Shell_Cont_Light&#39;</span> <span class="p">]</span> <span class="p">:</span>

        <span class="n">NV</span>  <span class="o">=</span> <span class="mi">29</span>
        <span class="n">NNH</span> <span class="o">=</span> <span class="mi">19</span>
        <span class="n">Nta</span> <span class="o">=</span> <span class="mi">9</span>

        <span class="n">NEW</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">NWi</span> <span class="o">=</span> <span class="mi">31</span>

        <span class="k">if</span> <span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;FULL&#39;</span><span class="p">:</span>
            <span class="n">NEW</span> <span class="o">=</span> <span class="mi">20</span>
            <span class="n">NWi</span> <span class="o">=</span> <span class="mi">31</span>
        
        <span class="k">if</span> <span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;LIGHT&#39;</span><span class="p">:</span>
            <span class="n">NEW</span> <span class="o">=</span> <span class="mi">8</span>
            <span class="n">NWi</span> <span class="o">=</span> <span class="mi">9</span>
        
        <span class="n">t_name</span> <span class="o">=</span> <span class="s1">&#39;_V_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">NV</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_logNH_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">NNH</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_logta_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Nta</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_EW_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">NEW</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_Wi_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">NWi</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.npy&#39;</span>

        <span class="n">loaded_model</span> <span class="o">=</span> <span class="p">{}</span>
    
        <span class="n">tmp_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">Data_location</span> <span class="o">+</span> <span class="s1">&#39;/GRID_info_&#39;</span> <span class="o">+</span> <span class="n">t_name</span> <span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span> <span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">GRID</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span> <span class="n">Data_location</span> <span class="o">+</span> <span class="s1">&#39;/GRID_data_&#39;</span> <span class="o">+</span> <span class="n">t_name</span>  <span class="p">)</span>

        <span class="n">loaded_model</span><span class="p">[</span><span class="s1">&#39;Grid&#39;</span><span class="p">]</span>      <span class="o">=</span> <span class="n">GRID</span>
        <span class="n">loaded_model</span><span class="p">[</span><span class="s1">&#39;V_Arr&#39;</span><span class="p">]</span>     <span class="o">=</span> <span class="n">tmp_1</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span>
        <span class="n">loaded_model</span><span class="p">[</span><span class="s1">&#39;logNH_Arr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_1</span><span class="p">[</span><span class="s1">&#39;logNH&#39;</span><span class="p">]</span>
        <span class="n">loaded_model</span><span class="p">[</span><span class="s1">&#39;logta_Arr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_1</span><span class="p">[</span><span class="s1">&#39;logta&#39;</span><span class="p">]</span>
        <span class="n">loaded_model</span><span class="p">[</span><span class="s1">&#39;logEW_Arr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_1</span><span class="p">[</span><span class="s1">&#39;logEW&#39;</span><span class="p">]</span>
        <span class="n">loaded_model</span><span class="p">[</span><span class="s1">&#39;Wi_Arr&#39;</span><span class="p">]</span>    <span class="o">=</span> <span class="n">tmp_1</span><span class="p">[</span><span class="s1">&#39;Wi&#39;</span><span class="p">]</span>

        <span class="n">loaded_model</span><span class="p">[</span><span class="s1">&#39;x_Arr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_lamda_into_x</span><span class="p">(</span> <span class="n">tmp_1</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span><span class="o">*</span><span class="mf">1e-10</span> <span class="p">)</span>
        <span class="n">loaded_model</span><span class="p">[</span><span class="s1">&#39;w_Arr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_1</span><span class="p">[</span><span class="s1">&#39;wavelength&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">loaded_model</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Interpolate_Lines_Arrays_3D_grid"><a class="viewcode-back" href="../funcs.html#funcs.Interpolate_Lines_Arrays_3D_grid">[docs]</a><span class="k">def</span> <span class="nf">Interpolate_Lines_Arrays_3D_grid</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">logta_Arr</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">Grid_Dictionary</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the escape fraction using the line profiles grids for many</span>
<span class="sd">        configurations</span>

<span class="sd">        **Input**:</span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Ar : 1-D sequence of floats</span>
<span class="sd">                    Logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        x_Arr : 1-D sequence of floats</span>
<span class="sd">                    Frequency in Doppler units where the line prfile will be</span>
<span class="sd">                    evaluated.</span>

<span class="sd">        Grid_Dictionary : python dictionary</span>
<span class="sd">                    All the necessary information for the interpoation. Loaded </span>
<span class="sd">                    with load_Grid_Line().</span>

<span class="sd">        **Output**:</span>

<span class="sd">        line_Arr :  2-D sequence of floats</span>
<span class="sd">                    Flux density in arbitrary units. The first dimension matches</span>
<span class="sd">                    the dimension of the input configurations (e.g. V_Arr). The</span>
<span class="sd">                    second dimension matches x_Arr.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">lines_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="n">x_Arr</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">x_Arr</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">)</span> <span class="p">):</span>

        <span class="n">lines_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Interpolate_Lines_Arrays_3D_grid_MCMC</span><span class="p">(</span> <span class="n">V_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">logNH_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">logta_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">Grid_Dictionary</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">lines_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Interpolate_Lines_Arrays_3D_grid_MCMC"><a class="viewcode-back" href="../funcs.html#funcs.Interpolate_Lines_Arrays_3D_grid_MCMC">[docs]</a><span class="k">def</span> <span class="nf">Interpolate_Lines_Arrays_3D_grid_MCMC</span><span class="p">(</span> <span class="n">V_Value</span> <span class="p">,</span> <span class="n">logNH_Value</span> <span class="p">,</span> <span class="n">logta_Value</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">Grid_Dictionary</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the escape fraction using the line profiles grids for one</span>
<span class="sd">        configuration. This is usefull for the Thin_Shell, Galactic_Wind and</span>
<span class="sd">        Bicones configurations.</span>

<span class="sd">        **Input**:</span>

<span class="sd">        V_Value : float</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Value : float</span>
<span class="sd">                    Logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Value : float</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        x_Arr : 1-D sequence of floats</span>
<span class="sd">                    Frequency in Doppler units where the line prfile will be</span>
<span class="sd">                    evaluated.</span>

<span class="sd">        Grid_Dictionary : python dictionary</span>
<span class="sd">                    All the necessary information for the interpoation. Loaded </span>
<span class="sd">                    with load_Grid_Line().</span>

<span class="sd">        **Output**:</span>

<span class="sd">        axu_line_1 : 1-D sequence of floats</span>
<span class="sd">                    Flux density in arbitrary units. </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">Grid_Line</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;Grid&#39;</span><span class="p">]</span>

    <span class="n">V_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;V_Arr&#39;</span><span class="p">]</span>
    <span class="n">x_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;x_Arr&#39;</span><span class="p">]</span>

    <span class="n">logNH_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;logNH_Arr&#39;</span><span class="p">]</span>
    <span class="n">logta_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;logta_Arr&#39;</span><span class="p">]</span>

    <span class="n">Coor_Arr_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">V_Arr_Grid</span> <span class="p">,</span> <span class="n">logNH_Arr_Grid</span> <span class="p">,</span> <span class="n">logta_Arr_Grid</span> <span class="p">]</span>
     
    <span class="n">Coor_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">V_Value</span> <span class="p">,</span> <span class="n">logNH_Value</span> <span class="p">,</span> <span class="n">logta_Value</span> <span class="p">]</span>

    <span class="n">aux_line</span> <span class="o">=</span> <span class="n">Linear_ND_interpolator</span><span class="p">(</span> <span class="mi">3</span> <span class="p">,</span> <span class="n">Coor_list</span> <span class="p">,</span> <span class="n">Coor_Arr_list</span> <span class="p">,</span> <span class="n">Grid_Line</span> <span class="p">)</span>

    <span class="c1">#print( aux_line[0] , right=[-1] )</span>

    <span class="n">axu_line_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">x_Arr_Grid</span> <span class="p">,</span> <span class="n">aux_line</span> <span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">aux_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">aux_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

    <span class="n">Integral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">axu_line_1</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">)</span>

    <span class="n">axu_line_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span> <span class="n">axu_line_1</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">Integral</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">axu_line_1</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Interpolate_Lines_Arrays_5D_grid"><a class="viewcode-back" href="../funcs.html#funcs.Interpolate_Lines_Arrays_5D_grid">[docs]</a><span class="k">def</span> <span class="nf">Interpolate_Lines_Arrays_5D_grid</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">logta_Arr</span> <span class="p">,</span> <span class="n">logEW_Arr</span> <span class="p">,</span> <span class="n">Wi_Arr</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">Grid_Dictionary</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the escape fraction using the line profiles grids for many</span>
<span class="sd">        configurations. This is usefull for the Thin_Shell_Cont</span>

<span class="sd">        **Input**:</span>

<span class="sd">        V_Arr : 1-D sequence of floats</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Ar : 1-D sequence of floats</span>
<span class="sd">                    Logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Arr : 1-D sequence of floats</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        logEW_Arr : 1-D sequence of floats</span>
<span class="sd">                    Logarithm of the rest frame equivalent width [A]</span>

<span class="sd">        Wi_Arr : 1-D sequence of floats</span>
<span class="sd">                    Rest frame instrinc line width [A]</span>

<span class="sd">        x_Arr : 1-D sequence of floats</span>
<span class="sd">                    Frequency in Doppler units where the line prfile will be</span>
<span class="sd">                    evaluated.</span>

<span class="sd">        Grid_Dictionary : python dictionary</span>
<span class="sd">                    All the necessary information for the interpoation. Loaded </span>
<span class="sd">                    with load_Grid_Line().</span>

<span class="sd">        **Output**:</span>

<span class="sd">        linew_Arr : 2-D sequence of floats</span>
<span class="sd">                    Flux density in arbitrary units. The first dimension matches</span>
<span class="sd">                    the dimension of the input configurations (e.g. V_Arr). The</span>
<span class="sd">                    second dimension matches x_Arr.</span>
<span class="sd">                    Flux density in arbitrary units. </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">lines_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="n">x_Arr</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">x_Arr</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">)</span> <span class="p">):</span>

        <span class="n">lines_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Interpolate_Lines_Arrays_5D_grid_MCMC</span><span class="p">(</span> <span class="n">V_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">logNH_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">logta_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">logEW_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">Wi_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">Grid_Dictionary</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">lines_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Interpolate_Lines_Arrays_5D_grid_MCMC"><a class="viewcode-back" href="../funcs.html#funcs.Interpolate_Lines_Arrays_5D_grid_MCMC">[docs]</a><span class="k">def</span> <span class="nf">Interpolate_Lines_Arrays_5D_grid_MCMC</span><span class="p">(</span> <span class="n">V_Value</span> <span class="p">,</span> <span class="n">logNH_Value</span> <span class="p">,</span> <span class="n">logta_Value</span> <span class="p">,</span> <span class="n">logEW_Value</span> <span class="p">,</span> <span class="n">Wi_Value</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">Grid_Dictionary</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the escape fraction using the line profiles grids for many</span>
<span class="sd">        configurations. This is usefull for the Thin_Shell_Cont</span>

<span class="sd">        **Input**:</span>

<span class="sd">        V_Value : float</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Value : float</span>
<span class="sd">                    Logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Value : float</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        logEW_Value : float</span>
<span class="sd">                    Logarithm of the rest frame equivalent width [A]</span>

<span class="sd">        Wi_Value : float</span>
<span class="sd">                    Rest frame instrinc line width [A]</span>

<span class="sd">        x_Arr : 1-D sequence of floats</span>
<span class="sd">                    Frequency in Doppler units where the line prfile will be</span>
<span class="sd">                    evaluated.</span>

<span class="sd">        Grid_Dictionary : python dictionary</span>
<span class="sd">                    All the necessary information for the interpoation. Loaded </span>
<span class="sd">                    with load_Grid_Line().</span>

<span class="sd">        **Output**:</span>

<span class="sd">        axu_line_1 : 1-D sequence of floats</span>
<span class="sd">                    Flux density in arbitrary units. </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">Grid_Line</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;Grid&#39;</span><span class="p">]</span>

    <span class="n">V_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;V_Arr&#39;</span><span class="p">]</span>
    <span class="n">x_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;x_Arr&#39;</span><span class="p">]</span>

    <span class="n">Wi_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;Wi_Arr&#39;</span><span class="p">]</span>

    <span class="n">logNH_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;logNH_Arr&#39;</span><span class="p">]</span>
    <span class="n">logta_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;logta_Arr&#39;</span><span class="p">]</span>
    <span class="n">logEW_Arr_Grid</span> <span class="o">=</span> <span class="n">Grid_Dictionary</span><span class="p">[</span><span class="s1">&#39;logEW_Arr&#39;</span><span class="p">]</span>

    <span class="n">Coor_Arr_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">V_Arr_Grid</span> <span class="p">,</span> <span class="n">logNH_Arr_Grid</span> <span class="p">,</span> <span class="n">logta_Arr_Grid</span> <span class="p">,</span> <span class="n">logEW_Arr_Grid</span> <span class="p">,</span> <span class="n">Wi_Arr_Grid</span> <span class="p">]</span>

    <span class="n">Coor_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">V_Value</span> <span class="p">,</span> <span class="n">logNH_Value</span> <span class="p">,</span> <span class="n">logta_Value</span> <span class="p">,</span> <span class="n">logEW_Value</span> <span class="p">,</span> <span class="n">Wi_Value</span> <span class="p">]</span>

    <span class="n">aux_line</span> <span class="o">=</span> <span class="n">Linear_ND_interpolator</span><span class="p">(</span> <span class="mi">5</span> <span class="p">,</span> <span class="n">Coor_list</span> <span class="p">,</span> <span class="n">Coor_Arr_list</span> <span class="p">,</span> <span class="n">Grid_Line</span> <span class="p">)</span>

    <span class="n">aux_line</span> <span class="o">=</span> <span class="n">aux_line</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">x_Arr_Grid</span> <span class="o">=</span> <span class="n">x_Arr_Grid</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">axu_line_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">x_Arr_Grid</span> <span class="p">,</span> <span class="n">aux_line</span> <span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">aux_line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">aux_line</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

    <span class="n">Integral</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">axu_line_1</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">)</span>

    <span class="n">axu_line_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span> <span class="n">axu_line_1</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">Integral</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">axu_line_1</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="pre_treatment_Line_profile_MCMC"><a class="viewcode-back" href="../funcs.html#funcs.pre_treatment_Line_profile_MCMC">[docs]</a><span class="k">def</span> <span class="nf">pre_treatment_Line_profile_MCMC</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Value</span> <span class="p">,</span> <span class="n">logNH_Value</span> <span class="p">,</span> <span class="n">ta_Value</span> <span class="p">,</span> <span class="n">logEW_Value</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">Wi_Value</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks the inflow/outflow parameters before doing the proper computation.</span>

<span class="sd">        **Input**:</span>

<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>
<span class="sd">                                       , &#39;Bicone_X_Slab_In&#39; , &#39;Bicone_X_Slab_Out&#39;</span>
<span class="sd">                                         &#39;Thin_Shell_Cont&#39;</span>

<span class="sd">        V_Value : float</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Value : float</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Value : float</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        logEW_Value : Optinal float</span>
<span class="sd">                    Logarithm of rest frame equiavlent width [A]</span>
<span class="sd">                    Default = None</span>

<span class="sd">        Wi_Value : Optinal float</span>
<span class="sd">                    Intrinsic width line in the rest frame [A]</span>
<span class="sd">                    Default = None</span>

<span class="sd">        **Output**:</span>

<span class="sd">        Bool_good : 1-D sequence of bool</span>
<span class="sd">                    1 if the parameters are good, 0 if they are bad.  </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">bool1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span>     <span class="n">V_Value</span> <span class="p">)</span>
    <span class="n">bool2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span> <span class="n">logNH_Value</span> <span class="p">)</span>
    <span class="n">bool3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span>    <span class="n">ta_Value</span> <span class="p">)</span>

    <span class="n">Bool_good</span> <span class="o">=</span> <span class="n">bool1</span> <span class="o">*</span> <span class="n">bool2</span> <span class="o">*</span> <span class="n">bool3</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span><span class="p">:</span>

        <span class="c1">#print(&#39;Special treatment for a special geometry!&#39;)</span>

        <span class="n">bool4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span> <span class="n">logEW_Value</span> <span class="p">)</span>
        <span class="n">bool5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span>    <span class="n">Wi_Value</span> <span class="p">)</span>

        <span class="n">Bool_good</span> <span class="o">=</span> <span class="n">Bool_good</span> <span class="o">*</span> <span class="n">bool4</span> <span class="o">*</span> <span class="n">bool5</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Bool_good</span> <span class="p">:</span> <span class="k">return</span> <span class="n">Bool_good</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]:</span>

        <span class="k">if</span> <span class="n">V_Value</span> <span class="o">&lt;=</span> <span class="mf">100.0</span> <span class="ow">and</span> <span class="n">logNH_Value</span> <span class="o">&gt;=</span> <span class="mf">20.5</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span> <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]:</span>

        <span class="k">if</span> <span class="n">V_Value</span> <span class="o">&lt;=</span>   <span class="mf">10.0</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="k">if</span> <span class="n">V_Value</span> <span class="o">&gt;=</span> <span class="mf">1000.0</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 

        <span class="k">if</span> <span class="n">logNH_Value</span> <span class="o">&lt;=</span>   <span class="mf">17.0</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="k">if</span> <span class="n">logNH_Value</span> <span class="o">&gt;=</span>   <span class="mf">22.0</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 

        <span class="k">if</span> <span class="n">ta_Value</span> <span class="o">&lt;=</span>  <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">3.75</span> <span class="p">)</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="k">if</span> <span class="n">ta_Value</span> <span class="o">&gt;=</span>  <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.125</span><span class="p">)</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 

    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span> <span class="p">]:</span>

        <span class="k">if</span> <span class="n">V_Value</span> <span class="o">&lt;=</span>   <span class="mf">00.0</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="k">if</span> <span class="n">V_Value</span> <span class="o">&gt;=</span> <span class="mf">1000.0</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 

        <span class="k">if</span> <span class="n">logNH_Value</span> <span class="o">&lt;=</span>   <span class="mf">17.0</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="k">if</span> <span class="n">logNH_Value</span> <span class="o">&gt;=</span>   <span class="mf">21.5</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 

        <span class="k">if</span> <span class="n">ta_Value</span> <span class="o">&lt;=</span>  <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">4.00</span> <span class="p">)</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="k">if</span> <span class="n">ta_Value</span> <span class="o">&gt;=</span>  <span class="mi">10</span><span class="o">**</span><span class="p">(</span> <span class="mf">0.0</span>  <span class="p">)</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 

        <span class="k">if</span> <span class="n">logEW_Value</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">1.</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">logEW_Value</span> <span class="o">&gt;=</span>  <span class="mf">3.</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">Wi_Value</span> <span class="o">&lt;=</span> <span class="mf">0.01</span> <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span> 
        <span class="k">if</span> <span class="n">Wi_Value</span> <span class="o">&gt;=</span> <span class="mf">6.0</span>  <span class="p">:</span> <span class="n">Bool_good</span> <span class="o">=</span> <span class="kc">False</span>
 
    <span class="k">return</span> <span class="n">Bool_good</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Compute_Inflow_From_Outflow"><a class="viewcode-back" href="../funcs.html#funcs.Compute_Inflow_From_Outflow">[docs]</a><span class="k">def</span> <span class="nf">Compute_Inflow_From_Outflow</span><span class="p">(</span> <span class="n">w_Arr</span> <span class="p">,</span> <span class="n">f_out_Arr</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the line profile of an inflow from the line profiles of an</span>
<span class="sd">        outflow</span>

<span class="sd">        **Input**:</span>

<span class="sd">        w_Arr : 1-D sequence of floats</span>
<span class="sd">                    wavelength where the line profile is evaluated.</span>

<span class="sd">        f_out_Arr : float</span>
<span class="sd">                    Outflow flux density (line profile)</span>
<span class="sd">        </span>
<span class="sd">        **Output**:</span>

<span class="sd">        f_in_Arr : 1-D sequence of bool</span>
<span class="sd">                    Inflow flux density (line profile)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">w_Lya</span> <span class="o">=</span> <span class="mf">1215.67</span> <span class="o">*</span> <span class="mf">1e-10</span>

    <span class="n">Delta_Arr</span> <span class="o">=</span> <span class="n">w_Arr</span> <span class="o">-</span> <span class="n">w_Lya</span>

    <span class="n">f_in_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span> <span class="n">Delta_Arr</span> <span class="p">,</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">Delta_Arr</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="n">f_out_Arr</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">f_in_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="RT_Line_Profile_MCMC"><a class="viewcode-back" href="../funcs.html#funcs.RT_Line_Profile_MCMC">[docs]</a><span class="k">def</span> <span class="nf">RT_Line_Profile_MCMC</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">V_Value</span> <span class="p">,</span> <span class="n">logNH_Value</span> <span class="p">,</span> <span class="n">ta_Value</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">logEW_Value</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">Wi_Value</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return one and only one Lyman alpha line profile for a given outflow properties.</span>
<span class="sd">        This function is especial to run MCMCs or PSO.</span>

<span class="sd">        **Input**:</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   The outflow geometry to use: Options: &#39;Thins_Shell&#39;,</span>
<span class="sd">                   &#39;Galactic_Wind&#39; , &#39;Bicone_X_Slab&#39;, &#39;Thin_Shell_Cont&#39;</span>

<span class="sd">        wavelength_Arr : 1-D sequence of floats</span>
<span class="sd">                         Array with the wavelength vales where the line</span>
<span class="sd">                         profile is computed. The units are meters, i.e.,</span>
<span class="sd">                         amstrongs * 1.e-10.</span>

<span class="sd">        V_Value : float</span>
<span class="sd">                  Value of the expansion velocity of the outflow. The unit</span>
<span class="sd">                  are km/s. </span>

<span class="sd">        logNH_Value : float</span>
<span class="sd">                      Value of the logarithim of the outflow neutral hydrogen</span>
<span class="sd">                      column density. The units of the colum density are in c.g.s,</span>
<span class="sd">                      i.e, cm**-2. </span>

<span class="sd">        ta_Value : float</span>
<span class="sd">                 Value of the dust optic depth of the outflow. </span>

<span class="sd">        DATA_LyaRT : Dictionay</span>
<span class="sd">                     This dictonary have all the information of the grid.</span>
<span class="sd">                     This dictionary can be loaded with the function : </span>
<span class="sd">                     load_Grid_Line, for example:</span>

<span class="sd">                     DATA_LyaRT = load_Grid_Line( &#39;Thin_Shell&#39; ) </span>

<span class="sd">        **Output**:</span>

<span class="sd">        lines_Arr : 1-D sequence of float</span>
<span class="sd">                    The Lyman alpha line profile. </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">Bool_good</span> <span class="o">=</span> <span class="n">pre_treatment_Line_profile_MCMC</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span> <span class="n">V_Value</span> <span class="p">)</span> <span class="p">,</span> <span class="n">logNH_Value</span> <span class="p">,</span> <span class="n">ta_Value</span> <span class="p">,</span> <span class="n">logEW_Value</span><span class="o">=</span><span class="n">logEW_Value</span> <span class="p">,</span> <span class="n">Wi_Value</span><span class="o">=</span><span class="n">Wi_Value</span> <span class="p">)</span>

    <span class="n">x_Arr</span> <span class="o">=</span> <span class="n">convert_lamda_into_x</span><span class="p">(</span> <span class="n">wavelength_Arr</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">Bool_good</span> <span class="p">:</span>
        <span class="n">logta_Value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">ta_Value</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span> <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span><span class="p">]:</span>

            <span class="n">line_Arr</span> <span class="o">=</span> <span class="n">Interpolate_Lines_Arrays_3D_grid_MCMC</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span> <span class="n">V_Value</span> <span class="p">)</span> <span class="p">,</span> <span class="n">logNH_Value</span> <span class="p">,</span> <span class="n">logta_Value</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span> <span class="p">]:</span>

            <span class="n">line_Arr</span> <span class="o">=</span> <span class="n">Interpolate_Lines_Arrays_5D_grid_MCMC</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span> <span class="n">V_Value</span> <span class="p">)</span>  <span class="p">,</span> <span class="n">logNH_Value</span> <span class="p">,</span> <span class="n">logta_Value</span> <span class="p">,</span> <span class="n">logEW_Value</span> <span class="p">,</span> <span class="n">Wi_Value</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Bool_good</span> <span class="p">:</span>

        <span class="n">line_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_Arr</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="c1">###########################################</span>
    <span class="n">CORRECT_FLAT_X</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">CORRECT_FLAT_X</span><span class="p">:</span>

        <span class="n">tmp_line_Arr</span> <span class="o">=</span> <span class="n">line_Arr</span> <span class="o">*</span> <span class="n">wavelength_Arr</span> <span class="o">**</span><span class="mi">2</span> 

        <span class="n">line_Arr</span> <span class="o">=</span> <span class="n">tmp_line_Arr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">line_Arr</span> <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">tmp_line_Arr</span> <span class="p">)</span>
    <span class="c1">###########################################</span>

    <span class="k">if</span> <span class="n">V_Value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">:</span>

        <span class="n">line_Arr</span> <span class="o">=</span> <span class="n">Compute_Inflow_From_Outflow</span><span class="p">(</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">line_Arr</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">line_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="pre_treatment_Line_profile"><a class="viewcode-back" href="../funcs.html#funcs.pre_treatment_Line_profile">[docs]</a><span class="k">def</span> <span class="nf">pre_treatment_Line_profile</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">logEW_Arr</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">Wi_Arr</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Checks the inflow/outflow parameters before doing the proper computation.</span>

<span class="sd">        **Input**:</span>

<span class="sd">        Geometry : String</span>
<span class="sd">                    Outflow configuration to use: &#39;Thin_Shell&#39;  , &#39;Galactic_Wind&#39;  </span>
<span class="sd">                                       , &#39;Bicone_X_Slab_In&#39; , &#39;Bicone_X_Slab_Out&#39;,</span>
<span class="sd">                                         &#39;Thin_Shell_Cont&#39;</span>

<span class="sd">        V_Value : 1-D sequence of bool</span>
<span class="sd">                    Outflow bulk velocity [km/s] </span>
<span class="sd">        </span>
<span class="sd">        logNH_Value : 1-D sequence of bool</span>
<span class="sd">                    logarithm of the neutral hydrogen column density [cm**-2] </span>

<span class="sd">        ta_Value : 1-D sequence of bool</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        logEW_Value : Optional 1-D sequence of bool</span>
<span class="sd">                    Logarithm of rest frame equiavlent width [A]</span>
<span class="sd">                    Default = None</span>

<span class="sd">        Wi_Value : Optional 1-D sequence of bool</span>
<span class="sd">                    Intrinsic width line in the rest frame [A]</span>
<span class="sd">                    Default = None</span>

<span class="sd">        **Output**:</span>

<span class="sd">        Bool_good : 1-D sequence of bool</span>
<span class="sd">                    1 if the parameters are good, 0 if they are bad.  </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">V_Arr</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>     <span class="n">V_Arr</span> <span class="p">)</span>
    <span class="n">logNH_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span> <span class="n">logNH_Arr</span> <span class="p">)</span>
    <span class="n">ta_Arr</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>    <span class="n">ta_Arr</span> <span class="p">)</span>

    <span class="n">V_Arr</span>     <span class="o">=</span>     <span class="n">V_Arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">logNH_Arr</span> <span class="o">=</span> <span class="n">logNH_Arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">ta_Arr</span>    <span class="o">=</span>    <span class="n">ta_Arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

    <span class="n">bool1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span> <span class="n">V_Arr</span>     <span class="p">)</span>
    <span class="n">bool2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span> <span class="n">logNH_Arr</span> <span class="p">)</span>
    <span class="n">bool3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span> <span class="n">ta_Arr</span>    <span class="p">)</span>

    <span class="n">mask_good</span> <span class="o">=</span> <span class="n">bool1</span> <span class="o">*</span> <span class="n">bool2</span> <span class="o">*</span> <span class="n">bool3</span>

    <span class="k">assert</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">mask_good</span> <span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">,</span> <span class="s1">&#39;All the V-logNH-ta combinations are np.nan, -np.inf or np.inf&#39;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="p">):</span>

        <span class="n">tmp_bool</span> <span class="o">=</span> <span class="n">pre_treatment_Line_profile_MCMC</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">logNH_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">ta_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">logEW_Value</span><span class="o">=</span><span class="n">logEW_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">Wi_Value</span><span class="o">=</span><span class="n">Wi_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>

        <span class="n">mask_good</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_bool</span>

    <span class="c1">#return V_Arr_used , logNH_Arr_used , ta_Arr_used , In_Bool_used , mask_good</span>
    <span class="k">return</span> <span class="n">mask_good</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="RT_Line_Profile"><a class="viewcode-back" href="../funcs.html#funcs.RT_Line_Profile">[docs]</a><span class="k">def</span> <span class="nf">RT_Line_Profile</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">logEW_Arr</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">Wi_Arr</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">MODE_CONT</span><span class="o">=</span><span class="s1">&#39;FULL&#39;</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return the Lyman alpha line profile for a given outflow properties.</span>
<span class="sd">        </span>
<span class="sd">        **Input**:</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   The outflow geometry to use: Options: &#39;Thins_Shell&#39;,</span>
<span class="sd">                   &#39;Galactic_Wind&#39; , &#39;Bicone_X_Slab&#39;, &#39;Thin_Shell_Cont&#39;</span>
<span class="sd">        </span>
<span class="sd">        wavelength_Arr : 1-D sequence of floats</span>
<span class="sd">                         Array with the wavelength vales where the line </span>
<span class="sd">                         profile is computed. The units are meters, i.e.,</span>
<span class="sd">                         amstrongs * 1.e-10.</span>
<span class="sd">        </span>
<span class="sd">        V_Arr : 1-D sequence of float </span>
<span class="sd">                Array with the expansion velocity of the outflow. The unit</span>
<span class="sd">                are km/s. </span>
<span class="sd">        </span>
<span class="sd">        logNH_Arr : 1-D sequence of float</span>
<span class="sd">                    Array with the logarithim of the outflow neutral hydrogen </span>
<span class="sd">                    column density. The units of the colum density are in c.g.s,</span>
<span class="sd">                    i.e, cm**-2. </span>
<span class="sd">        </span>
<span class="sd">        ta_Arr : 1-D sequence of float</span>
<span class="sd">                 Array with the dust optic depth of the outflow. </span>

<span class="sd">        ta_Value : 1-D sequence of bool</span>
<span class="sd">                    Dust optical depth [no dimensions]</span>

<span class="sd">        logEW_Value : Optional 1-D sequence of bool</span>
<span class="sd">                    Logarithm of rest frame equiavlent width [A]</span>
<span class="sd">                    Default = None</span>

<span class="sd">        Wi_Value : Optional 1-D sequence of bool</span>
<span class="sd">                    Intrinsic width line in the rest frame [A]</span>
<span class="sd">                    Default = None</span>

<span class="sd">        MODE : optinal string.</span>
<span class="sd">               For the &#39;Thin_Shell_Cont&#39; ONLY. Defines the grid to be loaded.</span>
<span class="sd">               MODE_CONT=&#39;FULL&#39;  loads a very dense  grid. ~12GB of RAM.</span>
<span class="sd">               MODE_CONT=&#39;LIGHT&#39; loads a more sparse grid. ~ 2GB of RAM.</span>

<span class="sd">        **Output**:</span>

<span class="sd">        lines_Arr : 2-D sequence of float</span>
<span class="sd">                    The Lyman alpha line profiles. lines_Arr[i] is the line profile </span>
<span class="sd">                    computed at the wavelengths wavelength_Arr for wich V_Arr[i] , </span>
<span class="sd">                    logNH_Arr[i] , ta_Arr[i] , Inside_Bicone_Arr[i].</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">assert</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span> <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">,</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span><span class="p">]</span> <span class="p">,</span> <span class="s1">&#39;The requested geoemtry &#39;</span> <span class="o">+</span> <span class="n">Geometry</span> <span class="o">+</span> <span class="s1">&#39; is not available. The geometries supported are : Thin_Shell , Galactic_Wind , Bicone_X_Slab&#39;</span>

    <span class="n">V_Arr</span>             <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>     <span class="n">V_Arr</span> <span class="p">)</span>
    <span class="n">logNH_Arr</span>         <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span> <span class="n">logNH_Arr</span> <span class="p">)</span>
    <span class="n">ta_Arr</span>            <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>    <span class="n">ta_Arr</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="o">==</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span><span class="p">:</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">logEW_Arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">,</span> <span class="s1">&#39;logEW_Arr can not be non if Geometry == Thin_Shell_Cont&#39;</span>
        <span class="k">assert</span> <span class="ow">not</span>    <span class="n">Wi_Arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">,</span> <span class="s1">&#39;Wi_Arr    can not be non if Geometry == Thin_Shell_Cont&#39;</span>

        <span class="n">logEW_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span> <span class="n">logEW_Arr</span> <span class="p">)</span>
        <span class="n">Wi_Arr</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span>    <span class="n">Wi_Arr</span> <span class="p">)</span>

    <span class="n">x_Arr</span> <span class="o">=</span> <span class="n">convert_lamda_into_x</span><span class="p">(</span> <span class="n">wavelength_Arr</span> <span class="p">)</span>

    <span class="n">lines_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="n">x_Arr</span> <span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">x_Arr</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
       
    <span class="n">mask_good</span> <span class="o">=</span> <span class="n">pre_treatment_Line_profile</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="n">ta_Arr</span> <span class="p">,</span> <span class="n">logEW_Arr</span><span class="o">=</span><span class="n">logEW_Arr</span> <span class="p">,</span> <span class="n">Wi_Arr</span><span class="o">=</span><span class="n">Wi_Arr</span> <span class="p">)</span>

    <span class="n">logta_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">ta_Arr</span> <span class="p">)</span>

    <span class="c1">##############################</span>

    <span class="n">DATA_LyaRT</span> <span class="o">=</span> <span class="n">load_Grid_Line</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">MODE_CONT</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span>  <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]</span> <span class="p">:</span>

        <span class="n">tmp_lines_Arr</span> <span class="o">=</span> <span class="n">Interpolate_Lines_Arrays_3D_grid</span><span class="p">(</span> <span class="n">V_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">logNH_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">logta_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">Geometry</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span> <span class="p">]</span> <span class="p">:</span>

        <span class="n">tmp_lines_Arr</span> <span class="o">=</span> <span class="n">Interpolate_Lines_Arrays_5D_grid</span><span class="p">(</span> <span class="n">V_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">logNH_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">logta_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">logEW_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">Wi_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="p">,</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">)</span>

    <span class="c1">##############################</span>

    <span class="n">lines_Arr</span><span class="p">[</span> <span class="n">mask_good</span> <span class="p">]</span> <span class="o">=</span> <span class="n">tmp_lines_Arr</span>

    <span class="k">return</span> <span class="n">lines_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Test_1"><a class="viewcode-back" href="../funcs.html#funcs.Test_1">[docs]</a><span class="k">def</span> <span class="nf">Test_1</span><span class="p">(</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Script to test if everything is working fine.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Let us check every different configuration for computing the escape fraction and the line profiles.&#39;</span><span class="p">)</span>
 
    <span class="n">Geometry_set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span> <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">,</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span><span class="p">]</span>
    
    <span class="n">ML_codes_set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Tree&#39;</span> <span class="p">,</span> <span class="s1">&#39;Forest&#39;</span> <span class="p">,</span> <span class="s1">&#39;KN&#39;</span> <span class="p">]</span>
    
    <span class="n">MODE_set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Parametrization&#39;</span> <span class="p">,</span> <span class="s1">&#39;Raw&#39;</span> <span class="p">,</span> <span class="s1">&#39;Analytic&#39;</span> <span class="p">]</span>
    
    <span class="n">Algorithm_set</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;Intrepolation&#39;</span> <span class="p">,</span> <span class="s1">&#39;Machine_Learning&#39;</span> <span class="p">]</span>
    
    <span class="c1"># Primero vamos a checkear que funciona las fracciones de escape</span>
    
    <span class="n">N_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="mf">1e4</span> <span class="p">)</span>
    
    <span class="n">V_Arr</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_points</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">989</span> <span class="o">+</span> <span class="mf">10.0</span>
    <span class="n">logNH_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_points</span> <span class="p">)</span> <span class="o">*</span>   <span class="mi">5</span> <span class="o">+</span> <span class="mf">17.0</span>
    <span class="n">logta_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_points</span> <span class="p">)</span> <span class="o">*</span>   <span class="mi">2</span> <span class="o">-</span> <span class="mf">2.5</span>  
   
    <span class="n">mask_bad_bicone</span> <span class="o">=</span> <span class="p">(</span> <span class="n">V_Arr</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">logNH_Arr</span> <span class="o">&gt;=</span> <span class="mf">20.5</span> <span class="p">)</span> 

    <span class="n">V_Arr</span>     <span class="o">=</span>     <span class="n">V_Arr</span><span class="p">[</span> <span class="o">~</span><span class="n">mask_bad_bicone</span> <span class="p">]</span>
    <span class="n">logNH_Arr</span> <span class="o">=</span> <span class="n">logNH_Arr</span><span class="p">[</span> <span class="o">~</span><span class="n">mask_bad_bicone</span> <span class="p">]</span>
    <span class="n">logta_Arr</span> <span class="o">=</span> <span class="n">logta_Arr</span><span class="p">[</span> <span class="o">~</span><span class="n">mask_bad_bicone</span> <span class="p">]</span>
 
    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Computing&#39;</span><span class="p">,</span> <span class="n">N_points</span> <span class="p">,</span> <span class="s1">&#39;random configurations of escape fraction with each algorithms...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">Geo</span> <span class="ow">in</span> <span class="n">Geometry_set</span><span class="p">:</span>
   
        <span class="k">if</span> <span class="n">Geo</span> <span class="o">==</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span> <span class="p">:</span> <span class="k">continue</span>
 
        <span class="k">for</span> <span class="n">Mod</span> <span class="ow">in</span> <span class="n">MODE_set</span> <span class="p">:</span>
    
            <span class="k">if</span> <span class="ow">not</span> <span class="n">Mod</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Analytic&#39;</span> <span class="p">]:</span>
    
                <span class="k">for</span> <span class="n">Algo</span> <span class="ow">in</span> <span class="n">Algorithm_set</span><span class="p">:</span>
    
                    <span class="k">if</span> <span class="n">Algo</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Intrepolation&#39;</span> <span class="p">,</span> <span class="s1">&#39;Machine_Learning&#39;</span> <span class="p">]:</span>
    
                        <span class="k">if</span> <span class="n">Algo</span> <span class="o">==</span> <span class="s1">&#39;Machine_Learning&#39;</span> <span class="p">:</span>
    
                            <span class="k">for</span> <span class="n">machine</span> <span class="ow">in</span> <span class="n">ML_codes_set</span> <span class="p">:</span>
    
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;      Running : &#39;</span> <span class="p">,</span> <span class="n">Geo</span> <span class="p">,</span> <span class="n">Mod</span> <span class="p">,</span> <span class="n">Algo</span> <span class="p">,</span> <span class="n">machine</span> <span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span>
                                    <span class="n">fff</span> <span class="o">=</span> <span class="n">RT_f_esc</span><span class="p">(</span> <span class="n">Geo</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">logta_Arr</span> <span class="p">,</span> <span class="n">MODE</span><span class="o">=</span><span class="n">Mod</span> <span class="p">,</span> <span class="n">Algorithm</span><span class="o">=</span><span class="n">Algo</span> <span class="p">,</span> <span class="n">Machine_Learning_Algorithm</span><span class="o">=</span><span class="n">machine</span><span class="p">)</span>
                                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span> <span class="n">fff</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;--&gt; Success!!&#39;</span><span class="p">)</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;--&gt; ERROR.. MISMATCH!!&#39;</span><span class="p">)</span>
    
                        <span class="k">if</span> <span class="n">Algo</span> <span class="o">!=</span> <span class="s1">&#39;Machine_Learning&#39;</span> <span class="p">:</span>
    
    
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;      Running : &#39;</span> <span class="p">,</span> <span class="n">Geo</span> <span class="p">,</span> <span class="n">Mod</span> <span class="p">,</span> <span class="n">Algo</span> <span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span>
                                    <span class="n">fff</span> <span class="o">=</span> <span class="n">RT_f_esc</span><span class="p">(</span> <span class="n">Geo</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">logta_Arr</span> <span class="p">,</span> <span class="n">MODE</span><span class="o">=</span><span class="n">Mod</span> <span class="p">,</span> <span class="n">Algorithm</span><span class="o">=</span><span class="n">Algo</span> <span class="p">)</span>
                                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span> <span class="n">fff</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;--&gt; Success!!&#39;</span><span class="p">)</span>
    
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;--&gt; ERROR. MISMATCH!!&#39;</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="n">Mod</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Analytic&#39;</span> <span class="p">]:</span>
    
    
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;      Running : &#39;</span> <span class="p">,</span> <span class="n">Geo</span> <span class="p">,</span> <span class="n">Mod</span> <span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span>
                                    <span class="n">fff</span> <span class="o">=</span> <span class="n">RT_f_esc</span><span class="p">(</span> <span class="n">Geo</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">logta_Arr</span> <span class="p">,</span> <span class="n">MODE</span><span class="o">=</span><span class="n">Mod</span> <span class="p">)</span>
                                    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span> <span class="n">fff</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;--&gt; Success!!&#39;</span><span class="p">)</span>
    
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;--&gt; ERROR. MISMATCH!!&#39;</span><span class="p">)</span>
    
    
    
    <span class="n">N_points</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="mf">1e3</span> <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Computing&#39;</span><span class="p">,</span> <span class="n">N_points</span> <span class="p">,</span> <span class="s1">&#39;random configurations of line profile  with each algorithms...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    
    <span class="n">V_Arr</span>     <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_points</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">900</span>  <span class="o">+</span> <span class="mi">100</span>
    <span class="n">logNH_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_points</span> <span class="p">)</span> <span class="o">*</span>   <span class="mf">4.5</span> <span class="o">+</span> <span class="mf">17.0</span>
    <span class="n">logta_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_points</span> <span class="p">)</span> <span class="o">*</span>   <span class="mf">2.</span>  <span class="o">-</span>  <span class="mf">2.5</span>
   
    <span class="n">logEW_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_points</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">-</span> <span class="mf">1.</span>
    <span class="n">Wi_Arr</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_points</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mf">0.1</span> 
 
    <span class="n">wavelength_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="mf">1215.68</span> <span class="o">-</span> <span class="mi">20</span> <span class="p">,</span> <span class="mf">1215.68</span> <span class="o">+</span> <span class="mi">20</span> <span class="p">,</span> <span class="mi">1000</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">1e-10</span>
    
    <span class="n">RUN_TEST_Lines</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">RUN_TEST_Lines</span> <span class="p">:</span>
        <span class="k">for</span> <span class="n">Geo</span> <span class="ow">in</span> <span class="n">Geometry_set</span><span class="p">:</span>
    
            <span class="k">try</span><span class="p">:</span> 
                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;      Running : &#39;</span> <span class="p">,</span> <span class="n">Geo</span> <span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="p">)</span>

                <span class="n">qq</span> <span class="o">=</span> <span class="n">RT_Line_Profile</span><span class="p">(</span> <span class="n">Geo</span> <span class="p">,</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">logta_Arr</span> <span class="p">,</span> <span class="n">logEW_Arr</span><span class="o">=</span><span class="n">logEW_Arr</span> <span class="p">,</span> <span class="n">Wi_Arr</span><span class="o">=</span><span class="n">Wi_Arr</span> <span class="p">)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span> <span class="n">qq</span> <span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;--&gt; Success!!&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;--&gt; ERROR. MISMATCH!!&#39;</span> <span class="p">)</span>

    <span class="k">return</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Test_2"><a class="viewcode-back" href="../funcs.html#funcs.Test_2">[docs]</a><span class="k">def</span> <span class="nf">Test_2</span><span class="p">(</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Script to test if everything looks fine.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Let us make some plots. This will show you just a glimpse of what LyaRT;Grid can do. Just wait for it...&#39;</span><span class="p">)</span>

    <span class="c1"># Plot some nice line profiles</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Plotting some line profiles...&#39;</span><span class="p">)</span>

    <span class="n">wavelength_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="mf">1215.68</span> <span class="o">-</span> <span class="mi">20</span> <span class="p">,</span> <span class="mf">1215.68</span> <span class="o">+</span> <span class="mi">20</span> <span class="p">,</span> <span class="mi">1000</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">1e-10</span>

    <span class="n">V_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="mi">10</span> <span class="p">,</span> <span class="mi">50</span> <span class="p">,</span> <span class="mi">100</span> <span class="p">,</span> <span class="mi">200</span> <span class="p">,</span> <span class="mi">300</span> <span class="p">]</span> <span class="p">)</span>

    <span class="n">logNH_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="mf">20.0</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">logta_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="o">-</span><span class="mf">1.</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">Wi_Arr</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="mf">0.4</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">logEW_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="mf">1.5</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">Inside_Bicone_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="n">cm</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span> <span class="s1">&#39;rainbow&#39;</span> <span class="p">)</span>
    
    <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span> <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">,</span> <span class="s1">&#39;Thin_Shell_Cont&#39;</span> <span class="p">]:</span>

        <span class="n">qq</span> <span class="o">=</span> <span class="n">RT_Line_Profile</span><span class="p">(</span> <span class="n">geo</span> <span class="p">,</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">V_Arr</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="mf">10.</span><span class="o">**</span><span class="n">logta_Arr</span> <span class="p">,</span> <span class="n">logEW_Arr</span><span class="o">=</span><span class="n">logEW_Arr</span> <span class="p">,</span> <span class="n">Wi_Arr</span><span class="o">=</span><span class="n">Wi_Arr</span> <span class="p">)</span> 

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="n">ax_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span><span class="nb">len</span><span class="p">(</span> <span class="n">V_Arr</span> <span class="p">)</span> <span class="p">):</span>

            <span class="n">ax_ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span> <span class="n">wavelength_Arr</span><span class="o">*</span><span class="mf">1e10</span> <span class="p">,</span> <span class="n">qq</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cm</span><span class="p">(</span> <span class="n">i</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span> <span class="p">)</span>

        <span class="n">ax_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;Flux [a.u.]&#39;</span> <span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span> <span class="p">)</span>
        <span class="n">ax_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;Wavelength [AA]&#39;</span> <span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span> <span class="p">)</span>

        <span class="n">ax_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;Geometry = &#39;</span> <span class="o">+</span> <span class="n">geo</span> <span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span> <span class="p">)</span>

        <span class="n">ax_ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span> <span class="mf">1212.5</span> <span class="p">,</span> <span class="mf">1222.5</span> <span class="p">)</span>

        <span class="n">ax_ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    Plotting some escape fractions...&#39;</span><span class="p">)</span>

    <span class="n">logta_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="o">-</span><span class="mi">2</span> <span class="p">,</span> <span class="mf">0.5</span> <span class="p">,</span> <span class="mi">20</span> <span class="p">)</span>

    <span class="n">logNH_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="mf">20.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="n">logta_Arr</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">geo</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Thin_Shell&#39;</span> <span class="p">,</span> <span class="s1">&#39;Galactic_Wind&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_In&#39;</span> <span class="p">,</span> <span class="s1">&#39;Bicone_X_Slab_Out&#39;</span> <span class="p">]</span>  <span class="p">:</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>

        <span class="n">ax_ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="p">):</span>

            <span class="n">V_Arr_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="n">V_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span> <span class="n">logta_Arr</span> <span class="p">)</span> <span class="p">)</span>

            <span class="n">f_esc</span> <span class="o">=</span> <span class="n">RT_f_esc</span><span class="p">(</span> <span class="n">geo</span> <span class="p">,</span> <span class="n">V_Arr_tmp</span> <span class="p">,</span> <span class="n">logNH_Arr</span> <span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">logta_Arr</span> <span class="p">)</span>

            <span class="n">ax_ax</span><span class="o">.</span><span class="n">semilogy</span><span class="p">(</span> <span class="n">logta_Arr</span> <span class="p">,</span> <span class="n">f_esc</span> <span class="p">,</span> <span class="s1">&#39;--&#39;</span> <span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">cm</span><span class="p">(</span> <span class="n">i</span><span class="o">*</span><span class="mf">1.</span><span class="o">/</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">V_Arr</span><span class="p">)</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span> <span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span> <span class="p">)</span>

        <span class="n">ax_ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;log tau a&#39;</span> <span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span> <span class="p">)</span>
        <span class="n">ax_ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;f esc Ly alpha &#39;</span> <span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span> <span class="p">)</span>

        <span class="n">ax_ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span> <span class="sa">r</span><span class="s1">&#39;Geometry = &#39;</span> <span class="o">+</span> <span class="n">geo</span> <span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span> <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span> <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#</span>
<span class="c1">#           CODE  FOR  THE  NEW  VERSION    !!!          YEEEY</span>
<span class="c1">#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="convert_gaussian_FWHM_to_sigma"><a class="viewcode-back" href="../funcs.html#funcs.convert_gaussian_FWHM_to_sigma">[docs]</a><span class="k">def</span> <span class="nf">convert_gaussian_FWHM_to_sigma</span><span class="p">(</span> <span class="n">FWHM_Arr</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function computes the sigma of a gaussian from its FWHM.</span>

<span class="sd">        **Input**</span>

<span class="sd">        FWHM_Arr : 1-D sequence of float</span>
<span class="sd">                   Array with the Full Width Half Maximum that you </span>
<span class="sd">                   want to convert</span>

<span class="sd">        **Output**</span>

<span class="sd">        sigma_Arr : 1-D sequence of float</span>
<span class="sd">                    The width of the FWHM_Arr</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sigma_Arr</span> <span class="o">=</span> <span class="n">FWHM_Arr</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">2.3548</span>

    <span class="k">return</span> <span class="n">sigma_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="dilute_line_changing_FWHM"><a class="viewcode-back" href="../funcs.html#funcs.dilute_line_changing_FWHM">[docs]</a><span class="k">def</span> <span class="nf">dilute_line_changing_FWHM</span><span class="p">(</span> <span class="n">wave_Arr</span> <span class="p">,</span> <span class="n">Spec_Arr</span> <span class="p">,</span> <span class="n">FWHM_Arr</span> <span class="p">,</span> <span class="n">same_norm</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This functions dilutes a given spectrum by convolving with a gaussian </span>
<span class="sd">        filter.</span>

<span class="sd">        **Input**</span>

<span class="sd">        wave_Arr : 1-D sequence of float</span>
<span class="sd">                   Array with the Wavelength where the spectrum is evaluated.</span>
<span class="sd">                   Same units as FWHM_Arr. This has to be sorted.</span>
<span class="sd">        </span>
<span class="sd">        Spec_Arr : 1-D sequence of float</span>
<span class="sd">                   Arrays with the flux of the spectrum.</span>

<span class="sd">        FWHM_Arr : 1-D sequence of float</span>
<span class="sd">                   Array with the Full width half maximuum of of the gaussian</span>
<span class="sd">                   to convolve. </span>
<span class="sd">                   If FWHM_Arr is a single value, it uses the same value across</span>
<span class="sd">                   the x_Arr range.</span>
<span class="sd">                   If FWHM is a 1-D sequence, a different value of width of</span>
<span class="sd">                   the gaussian is used. In this case, the length of this array</span>
<span class="sd">                   has to be the same as wave_Arr and Spec_Arr.</span>

<span class="sd">        same_norm : optional bool.</span>
<span class="sd">                    If true return a line with the same normalization as the input</span>

<span class="sd">        **Output**</span>

<span class="sd">        new_Line : 1-D sequence of float</span>
<span class="sd">                   Spectrum after the convolution</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="n">my_sigma_Arr</span> <span class="o">=</span> <span class="n">convert_gaussian_FWHM_to_sigma</span><span class="p">(</span> <span class="n">FWHM_Arr</span> <span class="p">)</span>

    <span class="n">new_Line</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span> <span class="n">wave_Arr</span> <span class="p">,</span> <span class="n">Spec_Arr</span> <span class="p">,</span> <span class="n">my_sigma_Arr</span> <span class="p">,</span><span class="n">same_norm</span><span class="o">=</span><span class="n">same_norm</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_Line</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="dilute_line"><a class="viewcode-back" href="../funcs.html#funcs.dilute_line">[docs]</a><span class="k">def</span> <span class="nf">dilute_line</span><span class="p">(</span> <span class="n">wave_Arr</span> <span class="p">,</span> <span class="n">Spec_Arr</span> <span class="p">,</span> <span class="n">FWHM</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This functions dilutes a given spectrum by convolving with a gaussian</span>
<span class="sd">        filter.</span>

<span class="sd">        **Input**</span>

<span class="sd">        wave_Arr : 1-D sequence of float</span>
<span class="sd">                   Array with the Wavelength where the spectrum is evaluated.</span>
<span class="sd">                   Same units as FWHM_Arr. This has to be sorted.</span>

<span class="sd">        Spec_Arr : 1-D sequence of float</span>
<span class="sd">                   Arrays with the flux of the spectrum.</span>

<span class="sd">        FWHM_Arr : 1-D sequence of float</span>
<span class="sd">                   Array with the Full width half maximuum of of the gaussian</span>
<span class="sd">                   to convolve.</span>
<span class="sd">                   If FWHM_Arr is a single value, it uses the same value across</span>
<span class="sd">                   the x_Arr range.</span>
<span class="sd">                   If FWHM is a 1-D sequence, a different value of width of</span>
<span class="sd">                   the gaussian is used. In this case, the length of this array</span>
<span class="sd">                   has to be the same as wave_Arr and Spec_Arr.</span>

<span class="sd">        same_norm : optional bool.</span>
<span class="sd">                    If true return a line with the same normalization as the input</span>

<span class="sd">        **Output**</span>

<span class="sd">        new_Line : 1-D sequence of float</span>
<span class="sd">                   Spectrum after the convolution</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">sigma</span> <span class="o">=</span> <span class="n">convert_gaussian_FWHM_to_sigma</span><span class="p">(</span> <span class="n">FWHM</span> <span class="p">)</span>

    <span class="n">bin_size</span> <span class="o">=</span> <span class="n">wave_Arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">wave_Arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 

    <span class="n">new_Line</span> <span class="o">=</span> <span class="n">gaussian_filter1d</span><span class="p">(</span> <span class="n">Spec_Arr</span> <span class="p">,</span> <span class="n">sigma</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">bin_size</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">new_Line</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="bin_one_line"><a class="viewcode-back" href="../funcs.html#funcs.bin_one_line">[docs]</a><span class="k">def</span> <span class="nf">bin_one_line</span><span class="p">(</span> <span class="n">wave_Arr_line</span> <span class="p">,</span> <span class="n">Line_Prob_Arr</span> <span class="p">,</span> <span class="n">new_wave_Arr</span> <span class="p">,</span> <span class="n">Bin</span> <span class="p">,</span> <span class="n">same_norm</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This functions bins the line profile mimicking the pixelization in a CCD.</span>

<span class="sd">        **Input**</span>

<span class="sd">        wave_Arr_line : 1-D sequence of float</span>
<span class="sd">                   Array with the Wavelength where the spectrum is evaluated.</span>
<span class="sd">                   Same units as Bin. This has to be sorted.</span>

<span class="sd">        Line_Prob_Arr : 1-D sequence of float</span>
<span class="sd">                   Arrays with the flux of the spectrum.</span>

<span class="sd">        new_wave_Arr : 1-D sequence of float</span>
<span class="sd">                   Array with the nex wavelgnth where the fline profile will be</span>
<span class="sd">                   interpolated </span>

<span class="sd">        Bin : float</span>
<span class="sd">                   Bin size.</span>

<span class="sd">        same_norm : optional bool.</span>
<span class="sd">                    If true return a line with the same normalization as the input</span>

<span class="sd">        **Output**</span>

<span class="sd">        binned_line : 1-D sequence of float</span>
<span class="sd">                   Spectrum after the convolution</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">RES</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="n">binned_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">new_wave_Arr</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">new_wave_Arr</span><span class="p">)</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">wave_low</span> <span class="o">=</span> <span class="n">new_wave_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">Bin</span><span class="o">*</span><span class="mf">0.5</span>
        <span class="n">wave_top</span> <span class="o">=</span> <span class="n">new_wave_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">Bin</span><span class="o">*</span><span class="mf">0.5</span>

        <span class="n">High_res_wave_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="n">wave_low</span> <span class="p">,</span> <span class="n">wave_top</span> <span class="p">,</span> <span class="n">RES</span> <span class="p">)</span>

        <span class="n">High_res_line_in_bin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span> <span class="n">High_res_wave_Arr</span> <span class="p">,</span> <span class="n">wave_Arr_line</span> <span class="p">,</span> <span class="n">Line_Prob_Arr</span> <span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">Line_Prob_Arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">Line_Prob_Arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

        <span class="n">binned_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">High_res_line_in_bin</span> <span class="p">)</span>

    <span class="c1">#print( &#39;binnec_line = &#39; , binned_line )</span>

    <span class="k">if</span> <span class="n">same_norm</span><span class="p">:</span>

        <span class="n">I_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">Line_Prob_Arr</span> <span class="p">,</span> <span class="n">wave_Arr_line</span> <span class="p">)</span>

        <span class="n">I_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">binned_line</span> <span class="p">,</span> <span class="n">new_wave_Arr</span> <span class="p">)</span>

        <span class="n">binned_line</span> <span class="o">=</span> <span class="n">binned_line</span> <span class="o">*</span> <span class="n">I_init</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">I_pix</span>

    <span class="k">return</span> <span class="n">binned_line</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="plot_a_rebinned_line"><a class="viewcode-back" href="../funcs.html#funcs.plot_a_rebinned_line">[docs]</a><span class="k">def</span> <span class="nf">plot_a_rebinned_line</span><span class="p">(</span> <span class="n">new_wave_Arr</span> <span class="p">,</span> <span class="n">binned_line</span> <span class="p">,</span> <span class="n">Bin</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This functions is used to plot line profiles. It transforms the line</span>
<span class="sd">        line in a histogram.</span>

<span class="sd">        **Input**</span>

<span class="sd">        new_wave_Arr : 1-D sequence of float</span>
<span class="sd">                   Array with the Wavelength where the spectrum is evaluated.</span>

<span class="sd">        binned_line : 1-D sequence of float</span>
<span class="sd">                   Arrays with the flux of the spectrum.</span>

<span class="sd">        Bin : float</span>
<span class="sd">                   Bin size.</span>

<span class="sd">        **Output**</span>

<span class="sd">        XX_Arr : 1-D sequence of float</span>
<span class="sd">                   Wavelength where the new line is evaluated</span>

<span class="sd">        YY_Arr : 1-D sequence of float</span>
<span class="sd">                   Flux density array</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">DD</span> <span class="o">=</span> <span class="n">Bin</span>  <span class="o">*</span> <span class="mf">1e-10</span>

    <span class="n">XX_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">new_wave_Arr</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">)</span>
    <span class="n">YY_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">new_wave_Arr</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span> <span class="n">new_wave_Arr</span> <span class="p">)</span> <span class="p">):</span>

        <span class="n">i_0</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span>
        <span class="n">i_1</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">XX_Arr</span><span class="p">[</span> <span class="n">i_0</span> <span class="p">]</span> <span class="o">=</span> <span class="n">new_wave_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Bin</span> <span class="o">+</span> <span class="n">DD</span>
        <span class="n">XX_Arr</span><span class="p">[</span> <span class="n">i_1</span> <span class="p">]</span> <span class="o">=</span> <span class="n">new_wave_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">Bin</span>

        <span class="n">YY_Arr</span><span class="p">[</span> <span class="n">i_0</span> <span class="p">]</span> <span class="o">=</span> <span class="n">binned_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">YY_Arr</span><span class="p">[</span> <span class="n">i_1</span> <span class="p">]</span> <span class="o">=</span> <span class="n">binned_line</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">XX_Arr</span> <span class="p">,</span> <span class="n">YY_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Add_noise_to_line"><a class="viewcode-back" href="../funcs.html#funcs.Add_noise_to_line">[docs]</a><span class="k">def</span> <span class="nf">Add_noise_to_line</span><span class="p">(</span> <span class="n">wave_Arr_line</span> <span class="p">,</span> <span class="n">Line_Prob_Arr</span> <span class="p">,</span> <span class="n">SN</span> <span class="p">,</span> <span class="n">same_norm</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This functions adds noise to a line profile.</span>

<span class="sd">        **Input**</span>

<span class="sd">        wave_Arr_line : 1-D sequence of float</span>
<span class="sd">                   Array with the Wavelength where the spectrum is evaluated.</span>
<span class="sd">                   Same units as Bin. This has to be sorted.</span>

<span class="sd">        Line_Prob_Arr : 1-D sequence of float</span>
<span class="sd">                   Arrays with the flux of the spectrum.</span>

<span class="sd">        SN : float</span>
<span class="sd">                   Signal to noise of the desire line.</span>

<span class="sd">        same_norm : optional bool.</span>
<span class="sd">                    If true return a line with the same normalization as the input</span>

<span class="sd">        **Output**</span>

<span class="sd">         Noisy_Line_Arr : 1-D sequence of float</span>
<span class="sd">                   Spectrum with the noise</span>

<span class="sd">        Noise_Arr : 1-D sequence of float</span>
<span class="sd">                   Particular flux density of the noise applyed</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">Line_Prob_Arr</span> <span class="o">&gt;</span> <span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">Line_Prob_Arr</span> <span class="p">)</span>

    <span class="n">SS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">Line_Prob_Arr</span><span class="p">[</span> <span class="n">mask</span> <span class="p">]</span> <span class="p">)</span>

    <span class="n">Noise_level</span> <span class="o">=</span> <span class="n">SS</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">SN</span> 

    <span class="n">Noise_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">Line_Prob_Arr</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">Noise_level</span> 

    <span class="n">Noisy_Line_Arr</span> <span class="o">=</span> <span class="n">Line_Prob_Arr</span> <span class="o">+</span> <span class="n">Noise_Arr</span>

    <span class="k">if</span> <span class="n">same_norm</span> <span class="p">:</span>

        <span class="n">I_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">Line_Prob_Arr</span> <span class="p">,</span> <span class="n">wave_Arr_line</span> <span class="p">)</span>

        <span class="n">I_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">Noisy_Line_Arr</span> <span class="p">,</span> <span class="n">wave_Arr_line</span> <span class="p">)</span>

        <span class="n">Noisy_Line_Arr</span> <span class="o">=</span> <span class="n">Noisy_Line_Arr</span> <span class="o">*</span> <span class="n">I_init</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">I_noise</span> 

    <span class="k">return</span> <span class="n">Noisy_Line_Arr</span> <span class="p">,</span> <span class="n">Noise_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="gaus"><a class="viewcode-back" href="../funcs.html#funcs.gaus">[docs]</a><span class="k">def</span> <span class="nf">gaus</span><span class="p">(</span> <span class="n">x_Arr</span> <span class="p">,</span> <span class="n">A</span> <span class="p">,</span> <span class="n">mu</span> <span class="p">,</span> <span class="n">sigma</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Retruns a gaussian evaluated in x_Arr.</span>
<span class="sd">        </span>
<span class="sd">        **Input**</span>
<span class="sd">        </span>
<span class="sd">        x_Arr : 1-D sequence of float</span>
<span class="sd">                   Where the gaussian has to be evaluated.</span>
<span class="sd">        </span>
<span class="sd">        A : float</span>
<span class="sd">            Amplitude</span>
<span class="sd">        </span>
<span class="sd">        mu : float</span>
<span class="sd">            Mean</span>
<span class="sd">        </span>
<span class="sd">        sigma : float</span>
<span class="sd">            width</span>
<span class="sd">        </span>
<span class="sd">        **Output**</span>
<span class="sd">        </span>
<span class="sd">        gauss_Arr : 1-D sequence of float</span>
<span class="sd">                   Gaussian</span>
<span class="sd">    &#39;&#39;&#39;</span>
    
    <span class="n">gauss_Arr</span> <span class="o">=</span>  <span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span> <span class="n">x_Arr</span> <span class="o">-</span> <span class="n">mu</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">gauss_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Signal_to_noise_estimator"><a class="viewcode-back" href="../funcs.html#funcs.Signal_to_noise_estimator">[docs]</a><span class="k">def</span> <span class="nf">Signal_to_noise_estimator</span><span class="p">(</span> <span class="n">w_Arr</span> <span class="p">,</span> <span class="n">Line_Arr</span> <span class="p">,</span> <span class="n">w_line</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Estimates the signal to noise of a line profile</span>

<span class="sd">        **Input**</span>

<span class="sd">        w_Arr : 1-D sequence of float</span>
<span class="sd">                wavelgnth array</span>

<span class="sd">        Line_Arr : 1-D sequence float</span>
<span class="sd">                   Flux density of the line profile.</span>

<span class="sd">        w_line : float</span>
<span class="sd">                 wavelgnth of the line</span>

<span class="sd">        **Output**</span>

<span class="sd">        SNR : float</span>
<span class="sd">              Signal to noise ratio.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">popt</span> <span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span> <span class="n">gaus</span> <span class="p">,</span> <span class="n">w_Arr</span> <span class="p">,</span> <span class="n">Line_Arr</span> <span class="p">,</span> <span class="n">p0</span><span class="o">=</span><span class="p">[</span> <span class="mf">1e-17</span> <span class="p">,</span> <span class="n">w_line</span> <span class="p">,</span> <span class="mf">5.0</span> <span class="p">]</span> <span class="p">)</span>

    <span class="n">sigma_line</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">mask_line</span> <span class="o">=</span> <span class="p">(</span> <span class="n">w_Arr</span> <span class="o">&gt;</span> <span class="n">w_line</span> <span class="o">-</span> <span class="mf">2.30</span><span class="o">*</span><span class="n">sigma_line</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">w_Arr</span> <span class="o">&lt;</span> <span class="n">w_line</span> <span class="o">+</span> <span class="mf">2.30</span><span class="o">*</span><span class="n">sigma_line</span> <span class="p">)</span>

    <span class="n">RMS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">Line_Arr</span><span class="p">[</span> <span class="o">~</span><span class="n">mask_line</span> <span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">SS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">Line_Arr</span><span class="p">[</span> <span class="n">mask_line</span> <span class="p">]</span> <span class="p">)</span>

    <span class="n">SNR</span> <span class="o">=</span> <span class="n">SS</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">RMS</span>

    <span class="k">return</span> <span class="n">SNR</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="generate_a_obs_line"><a class="viewcode-back" href="../funcs.html#funcs.generate_a_obs_line">[docs]</a><span class="k">def</span> <span class="nf">generate_a_obs_line</span><span class="p">(</span> <span class="n">z_f</span> <span class="p">,</span> <span class="n">V_f</span> <span class="p">,</span> <span class="n">logNH_f</span> <span class="p">,</span> <span class="n">ta_f</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">logEW_f</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">Wi_f</span><span class="o">=</span><span class="kc">None</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Moves in redshift a line profile.</span>

<span class="sd">        **Input**</span>

<span class="sd">        z_f : float</span>
<span class="sd">              Redshift</span>

<span class="sd">        V_f : float</span>
<span class="sd">              Outflow expansion velocity [km/s]</span>

<span class="sd">        logNH_f : float</span>
<span class="sd">                  logarithmic of the neutral hydrogen column density in cm**-2</span>

<span class="sd">        ta_f : float</span>
<span class="sd">               Dust optical depth</span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information. </span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>

<span class="sd">        logEW_f : optional, float</span>
<span class="sd">                  Logarithmic of the rest frame intrisic equivalent width of the line [A]</span>
<span class="sd">                  Requiered if Geometry == &#39;Thin_Shell_Cont&#39; </span>

<span class="sd">        Wi_f : optional, float</span>
<span class="sd">               Rest frame intrisic width of the Lyman-alpha line [A]</span>
<span class="sd">               Requiered if Geometry == &#39;Thin_Shell_Cont&#39; </span>

<span class="sd">        **Output**</span>

<span class="sd">        w_rest_Arr : 1-D sequence of float</span>
<span class="sd">                     Wavelgnth array where the line is evaluated in the rest frame.</span>

<span class="sd">        wavelength_Arr : 1-D sequence of float</span>
<span class="sd">                     Wavelgnth array where the line is evaluated in the observed frame.</span>

<span class="sd">        line_Arr : 1-D sequence of float</span>
<span class="sd">                   Line profile flux density in arbitrary units.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">w_Lya</span> <span class="o">=</span> <span class="mf">1215.67</span>

    <span class="n">w_rest_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="mf">1215.68</span> <span class="o">-</span> <span class="mi">30</span> <span class="p">,</span> <span class="mf">1215.68</span> <span class="o">+</span> <span class="mi">30</span> <span class="p">,</span> <span class="mi">2000</span> <span class="p">)</span>

    <span class="n">line_Arr</span> <span class="o">=</span> <span class="n">RT_Line_Profile_MCMC</span><span class="p">(</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">w_rest_Arr</span><span class="o">*</span><span class="mf">1e-10</span><span class="p">,</span> <span class="n">V_f</span> <span class="p">,</span> <span class="n">logNH_f</span> <span class="p">,</span> <span class="n">ta_f</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">logEW_Value</span><span class="o">=</span><span class="n">logEW_f</span> <span class="p">,</span> <span class="n">Wi_Value</span><span class="o">=</span><span class="n">Wi_f</span> <span class="p">)</span>

    <span class="n">wavelength_Arr</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">z_f</span> <span class="p">)</span> <span class="o">*</span> <span class="n">w_rest_Arr</span>

    <span class="k">return</span> <span class="n">w_rest_Arr</span> <span class="p">,</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">line_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="generate_a_REAL_line_Noise_w"><a class="viewcode-back" href="../funcs.html#funcs.generate_a_REAL_line_Noise_w">[docs]</a><span class="k">def</span> <span class="nf">generate_a_REAL_line_Noise_w</span><span class="p">(</span> <span class="n">z_f</span> <span class="p">,</span> <span class="n">V_f</span> <span class="p">,</span> <span class="n">logNH_f</span> <span class="p">,</span> <span class="n">ta_f</span> <span class="p">,</span> <span class="n">F_line_f</span> <span class="p">,</span> <span class="n">logEW_f</span> <span class="p">,</span> <span class="n">Wi_f</span> <span class="p">,</span> <span class="n">Noise_w_Arr</span> <span class="p">,</span> <span class="n">Noise_Arr</span> <span class="p">,</span> <span class="n">FWHM_f</span> <span class="p">,</span> <span class="n">PIX_f</span> <span class="p">,</span> <span class="n">w_min</span> <span class="p">,</span> <span class="n">w_max</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Makes a mock line profile for the Thin_Shell_Cont geometry.</span>

<span class="sd">        **Input**</span>

<span class="sd">        z_f : float</span>
<span class="sd">              Redshift</span>

<span class="sd">        V_f : float</span>
<span class="sd">              Outflow expansion velocity [km/s]</span>

<span class="sd">        logNH_f : float</span>
<span class="sd">                  logarithmic of the neutral hydrogen column density in cm**-2</span>

<span class="sd">        ta_f : float</span>
<span class="sd">               Dust optical depth</span>

<span class="sd">        logEW_f : optional, float</span>
<span class="sd">                  Logarithmic of the rest frame intrisic equivalent width of the line [A]</span>
<span class="sd">                  Requiered if Geometry == &#39;Thin_Shell_Cont&#39;</span>

<span class="sd">        Wi_f : optional, float</span>
<span class="sd">               Rest frame intrisic width of the Lyman-alpha line [A]</span>
<span class="sd">               Requiered if Geometry == &#39;Thin_Shell_Cont&#39;</span>

<span class="sd">        Noise_w_Arr : 1-D sequence of float</span>
<span class="sd">                      wavelength array where the noise pattern is evaluated.</span>

<span class="sd">        Noise_Arr : 1-D sequence of float</span>
<span class="sd">                    Noise pattern. Evolution of the noise as a function of wavelength (Noise_w_Arr)</span>
<span class="sd">       </span>
<span class="sd">        FWHM_f : float</span>
<span class="sd">                 Full width half maximum [A] of the experiment. This dilutes the line profile.  </span>

<span class="sd">        PIX_f : float</span>
<span class="sd">                Pixel size in wavelgnth [A] of the experiment. This binnes the line profile.  </span>

<span class="sd">        w_min : float</span>
<span class="sd">                minimum wavelength in the observed frame [A] to use. This matches the minimum</span>
<span class="sd">                wavelgnth of wave_pix_Arr (see below).</span>

<span class="sd">        w_max : float</span>
<span class="sd">                maximum  wavelength in the observed frame [A] to use. This might not be exactly</span>
<span class="sd">                the maximum wavelgnth of wave_pix_Arr (see below) due to pixelization. </span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information.</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>

<span class="sd">        **Output**</span>

<span class="sd">        wave_pix_Arr : 1-D sequence of float</span>
<span class="sd">                     Wavelgnth array where the line is evaluated in the observed frame.</span>

<span class="sd">        noisy_Line_Arr : 1-D sequence of float</span>
<span class="sd">                   Line profile flux density in arbitrary units.</span>

<span class="sd">        dic : python dictionaty.</span>
<span class="sd">              Contains all the meta data used to get the line profiles:</span>
<span class="sd">                &#39;w_rest&#39;    : restframe wavelength of line before reducing quality</span>
<span class="sd">                &#39;w_obs&#39;     : wavelength of line before reducing quality</span>
<span class="sd">                &#39;Intrinsic&#39; : line profile before quality reduction</span>
<span class="sd">                &#39;Diluted&#39;   : Line profile after the FWHM has been applyed.</span>
<span class="sd">                &#39;Pixelated&#39; : Line profile after the FWHM and PIX have been applyed</span>
<span class="sd">                &#39;Noise&#39;     : Particular noise patern used.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">w_rest_Arr</span> <span class="p">,</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">line_Arr</span> <span class="o">=</span> <span class="n">generate_a_obs_line</span><span class="p">(</span> <span class="n">z_f</span> <span class="p">,</span> <span class="n">V_f</span> <span class="p">,</span> <span class="n">logNH_f</span> <span class="p">,</span> <span class="n">ta_f</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">logEW_f</span><span class="o">=</span><span class="n">logEW_f</span> <span class="p">,</span> <span class="n">Wi_f</span><span class="o">=</span><span class="n">Wi_f</span> <span class="p">)</span>

    <span class="n">diluted_Arr</span> <span class="o">=</span> <span class="n">dilute_line</span><span class="p">(</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">line_Arr</span> <span class="p">,</span> <span class="n">FWHM_f</span> <span class="p">)</span>

    <span class="n">wave_pix_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">w_min</span> <span class="p">,</span> <span class="n">w_max</span> <span class="p">,</span> <span class="n">PIX_f</span> <span class="p">)</span>

    <span class="n">pixled_Arr</span> <span class="o">=</span> <span class="n">bin_one_line</span><span class="p">(</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">diluted_Arr</span> <span class="p">,</span> <span class="n">wave_pix_Arr</span> <span class="p">,</span> <span class="n">PIX_f</span> <span class="p">)</span>

    <span class="n">F_lambda_Arr</span> <span class="o">=</span> <span class="n">pixled_Arr</span> <span class="o">*</span> <span class="n">F_line_f</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">pixled_Arr</span> <span class="p">,</span> <span class="n">wave_pix_Arr</span> <span class="p">)</span>

    <span class="n">noise_in_my_w_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span> <span class="n">pixled_Arr</span> <span class="p">,</span> <span class="n">Noise_w_Arr</span> <span class="p">,</span> <span class="n">Noise_Arr</span> <span class="p">)</span>

    <span class="n">noise_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">pixled_Arr</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">noise_in_my_w_Arr</span>

    <span class="n">noisy_Line_Arr</span> <span class="o">=</span> <span class="n">F_lambda_Arr</span> <span class="o">+</span> <span class="n">noise_Arr</span>

    <span class="c1"># Other usful things :</span>

    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;w_rest&#39;</span>    <span class="p">]</span> <span class="o">=</span> <span class="n">w_rest_Arr</span>
    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;w_obs&#39;</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">wavelength_Arr</span>
    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;Intrinsic&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">line_Arr</span>
    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;Diluted&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">diluted_Arr</span>
    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;Pixelated&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">F_lambda_Arr</span>
    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;Noise&#39;</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">noise_Arr</span>

    <span class="k">return</span> <span class="n">wave_pix_Arr</span> <span class="p">,</span> <span class="n">noisy_Line_Arr</span> <span class="p">,</span> <span class="n">dic</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Generate_a_real_line"><a class="viewcode-back" href="../funcs.html#funcs.Generate_a_real_line">[docs]</a><span class="k">def</span> <span class="nf">Generate_a_real_line</span><span class="p">(</span> <span class="n">z_t</span> <span class="p">,</span> <span class="n">V_t</span><span class="p">,</span> <span class="n">log_N_t</span><span class="p">,</span> <span class="n">t_t</span><span class="p">,</span> <span class="n">F_t</span><span class="p">,</span> <span class="n">log_EW_t</span><span class="p">,</span> <span class="n">W_t</span> <span class="p">,</span> <span class="n">PNR_t</span><span class="p">,</span> <span class="n">FWHM_t</span><span class="p">,</span> <span class="n">PIX_t</span><span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="p">,</span> <span class="n">Geometry</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Makes a mock line profile for the Thin_Shell_Cont geometry.</span>

<span class="sd">        **Input**</span>

<span class="sd">        z_t : float</span>
<span class="sd">              Redshift</span>

<span class="sd">        V_t : float</span>
<span class="sd">              Outflow expansion velocity [km/s]</span>

<span class="sd">        log_N_t : float</span>
<span class="sd">                  logarithmic of the neutral hydrogen column density in cm**-2</span>

<span class="sd">        t_t : float</span>
<span class="sd">              Dust optical depth</span>

<span class="sd">        F_t : float</span>
<span class="sd">              Total flux of the line. You can pass 1.</span>

<span class="sd">        log_EW_t : optional, float</span>
<span class="sd">                   Logarithmic of the rest frame intrisic equivalent width of the line [A]</span>
<span class="sd">                   Requiered if Geometry == &#39;Thin_Shell_Cont&#39;</span>

<span class="sd">        W_t : optional, float</span>
<span class="sd">               Rest frame intrisic width of the Lyman-alpha line [A]</span>
<span class="sd">               Requiered if Geometry == &#39;Thin_Shell_Cont&#39;</span>

<span class="sd">        PNR_t : float</span>
<span class="sd">                Signal to noise ratio of the global maximum of the line profile.</span>

<span class="sd">        FWHM_t : float</span>
<span class="sd">                 Full width half maximum [A] of the experiment. This dilutes the line profile.</span>

<span class="sd">        PIX_t : float</span>
<span class="sd">                Pixel size in wavelgnth [A] of the experiment. This binnes the line profile.</span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information.</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>

<span class="sd">        **Output**</span>

<span class="sd">        w_Arr : 1-D sequence of float</span>
<span class="sd">                     Wavelgnth array where the line is evaluated in the observed frame.</span>

<span class="sd">        f_Arr : 1-D sequence of float</span>
<span class="sd">                   Line profile flux density in arbitrary units.</span>

<span class="sd">        noise_Amplitude_Arr : 1-D sequence of float</span>
<span class="sd">                              1-sigma level of the applyed noise.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">w_min</span> <span class="o">=</span> <span class="p">(</span> <span class="mf">1215.67</span> <span class="o">-</span> <span class="mf">25.5</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">z_t</span> <span class="p">)</span>
    <span class="n">w_max</span> <span class="o">=</span> <span class="p">(</span> <span class="mf">1215.67</span> <span class="o">+</span> <span class="mf">25.5</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">z_t</span> <span class="p">)</span>

    <span class="n">w_Noise_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="n">w_min</span> <span class="p">,</span> <span class="n">w_max</span> <span class="p">,</span> <span class="mi">10</span> <span class="p">)</span>

    <span class="n">tmp_Noise_Arr</span> <span class="o">=</span> <span class="n">w_Noise_Arr</span> <span class="o">*</span> <span class="mf">0.0</span>

    <span class="n">w_Arr</span> <span class="p">,</span> <span class="n">f_noiseless_Arr</span> <span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generate_a_REAL_line_Noise_w</span><span class="p">(</span> <span class="n">z_t</span><span class="p">,</span> <span class="n">V_t</span><span class="p">,</span> <span class="n">log_N_t</span><span class="p">,</span> <span class="n">t_t</span> <span class="p">,</span> <span class="n">F_t</span> <span class="p">,</span> <span class="n">log_EW_t</span> <span class="p">,</span> <span class="n">W_t</span><span class="p">,</span> <span class="n">w_Noise_Arr</span><span class="p">,</span> <span class="n">tmp_Noise_Arr</span> <span class="p">,</span> <span class="n">FWHM_t</span> <span class="p">,</span> <span class="n">PIX_t</span> <span class="p">,</span>  <span class="n">w_min</span><span class="p">,</span> <span class="n">w_max</span><span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>

    <span class="n">noise_Amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_noiseless_Arr</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">PNR_t</span>

    <span class="n">noise_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">w_Arr</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">noise_Amplitude</span>

    <span class="n">noise_Amplitude_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">w_Arr</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">noise_Amplitude</span>

    <span class="n">f_Arr</span> <span class="o">=</span> <span class="n">f_noiseless_Arr</span> <span class="o">+</span> <span class="n">noise_Arr</span>

    <span class="k">return</span> <span class="n">w_Arr</span> <span class="p">,</span> <span class="n">f_Arr</span> <span class="p">,</span> <span class="n">noise_Amplitude_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Define_wavelength_for_NN"><a class="viewcode-back" href="../funcs.html#funcs.Define_wavelength_for_NN">[docs]</a><span class="k">def</span> <span class="nf">Define_wavelength_for_NN</span><span class="p">(</span> <span class="n">Delta_min</span><span class="o">=-</span><span class="mf">18.5</span> <span class="p">,</span> <span class="n">Delta_max</span><span class="o">=</span><span class="mf">18.5</span> <span class="p">,</span> <span class="n">Nbins_tot</span><span class="o">=</span><span class="mi">1000</span> <span class="p">,</span> <span class="n">Denser_Center</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        This function defines the wavelength used in for the neural netwroks.</span>

<span class="sd">        **Input**</span>

<span class="sd">        Delta_min : optional float</span>
<span class="sd">              Defines the minimum rest frame wavelegnth with respecto to Lyman-alpha.</span>

<span class="sd">              Default = -18.5</span>

<span class="sd">        Delta_min : optional float</span>
<span class="sd">              Defines the maximum rest frame wavelegnth with respecto to Lyman-alpha.</span>

<span class="sd">              Default = +18.5</span>

<span class="sd">        Nbins_tot : optional int</span>
<span class="sd">              Total number of wvelgnths bins.</span>
<span class="sd">              </span>
<span class="sd">              Default = 1000</span>

<span class="sd">        Denser_Center : optional bool</span>
<span class="sd">              Populates denser the regions close to Lyman-alpha</span>
<span class="sd">              </span>
<span class="sd">              Default = True</span>

<span class="sd">        **Output**</span>

<span class="sd">        rest_w_Arr : 1-D sequence of float</span>
<span class="sd">                     Wavelgnth array where the line is evaluated in the rest frame.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Denser_Center</span><span class="p">:</span>
    
        <span class="n">rest_w_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="mf">1215.67</span><span class="o">+</span><span class="n">Delta_min</span> <span class="p">,</span> <span class="mf">1215.67</span><span class="o">+</span><span class="n">Delta_max</span> <span class="p">,</span> <span class="n">Nbins_tot</span> <span class="p">)</span>
    
    <span class="k">else</span> <span class="p">:</span>
    
        <span class="n">Delta_core</span> <span class="o">=</span> <span class="mf">4.0</span>
    
        <span class="n">ratio_bin_size_core</span> <span class="o">=</span> <span class="mi">5</span>
    
        <span class="n">L_core</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">Delta_core</span>
        <span class="n">L_wing</span> <span class="o">=</span> <span class="n">Delta_max</span> <span class="o">-</span> <span class="n">Delta_min</span> <span class="o">-</span> <span class="n">L_core</span>
    
        <span class="n">ratio_Ls</span> <span class="o">=</span> <span class="n">L_core</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">L_wing</span>
    
        <span class="n">N_c</span> <span class="o">=</span> <span class="n">ratio_bin_size_core</span> <span class="o">*</span> <span class="n">ratio_Ls</span> <span class="o">*</span> <span class="n">Nbins_tot</span> <span class="o">/</span>  <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">ratio_bin_size_core</span> <span class="o">*</span> <span class="n">ratio_Ls</span> <span class="p">)</span>
    
        <span class="n">N_w</span> <span class="o">=</span> <span class="n">Nbins_tot</span> <span class="o">-</span> <span class="n">N_c</span>
    
        <span class="n">N_c</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">N_c</span> <span class="p">)</span>
        <span class="n">N_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">N_w</span> <span class="p">)</span>
    
        <span class="n">N_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">N_w</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
    
        <span class="k">while</span> <span class="n">N_c</span><span class="o">+</span><span class="n">N_w</span><span class="o">&lt;</span><span class="n">Nbins_tot</span> <span class="p">:</span> <span class="n">N_c</span> <span class="o">+=</span> <span class="mi">1</span>
    
        <span class="c1">#print( N_c , N_w )</span>
    
        <span class="n">Delta_c</span> <span class="o">=</span> <span class="n">L_core</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">N_c</span>
    
        <span class="n">low_wing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="n">Delta_min</span>          <span class="p">,</span> <span class="o">-</span><span class="n">Delta_core</span><span class="o">-</span><span class="n">Delta_c</span> <span class="p">,</span> <span class="nb">int</span><span class="p">(</span> <span class="n">N_w</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
        <span class="n">top_wing</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="n">Delta_core</span><span class="o">+</span><span class="n">Delta_c</span> <span class="p">,</span>  <span class="n">Delta_max</span>          <span class="p">,</span> <span class="nb">int</span><span class="p">(</span> <span class="n">N_w</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">)</span>
    
        <span class="n">core</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="o">-</span><span class="n">Delta_core</span> <span class="p">,</span> <span class="n">Delta_core</span> <span class="p">,</span> <span class="n">N_c</span> <span class="p">)</span>
    
        <span class="n">rest_w_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span> <span class="n">low_wing</span> <span class="p">,</span> <span class="n">core</span> <span class="p">,</span> <span class="n">top_wing</span> <span class="p">])</span> <span class="o">+</span> <span class="mf">1215.67</span>

    <span class="k">return</span> <span class="n">rest_w_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Treat_A_Line_To_NN_Input"><a class="viewcode-back" href="../funcs.html#funcs.Treat_A_Line_To_NN_Input">[docs]</a><span class="k">def</span> <span class="nf">Treat_A_Line_To_NN_Input</span><span class="p">(</span> <span class="n">w_Arr</span> <span class="p">,</span> <span class="n">f_Arr</span> <span class="p">,</span> <span class="n">PIX</span> <span class="p">,</span> <span class="n">FWHM</span> <span class="p">,</span> <span class="n">Delta_min</span><span class="o">=-</span><span class="mf">18.5</span> <span class="p">,</span> <span class="n">Delta_max</span><span class="o">=</span><span class="mf">18.5</span> <span class="p">,</span> <span class="n">Nbins_tot</span><span class="o">=</span><span class="mi">1000</span> <span class="p">,</span> <span class="n">Denser_Center</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convert a line profile and the usefull information into the INPUT of the NN.</span>

<span class="sd">        **Input**</span>

<span class="sd">        w_Arr : 1-D sequence of floats</span>
<span class="sd">              Wavelgnth of the line profile in the observed frame. [A]</span>

<span class="sd">        f_Arr : 1-D sequence of floats</span>
<span class="sd">              Flux density of the observed line profile in arbitrary units.</span>

<span class="sd">        FWHM : float</span>
<span class="sd">              Full width half maximum [A] of the experiment.</span>

<span class="sd">        PIX : float</span>
<span class="sd">              Pixel size in wavelgnth [A] of the experiment. </span>
<span class="sd">        </span>

<span class="sd">        Delta_min : optional float</span>
<span class="sd">              Defines the minimum rest frame wavelegnth with respecto to Lyman-alpha.</span>

<span class="sd">              Default = -18.5</span>

<span class="sd">        Delta_min : optional float</span>
<span class="sd">              Defines the maximum rest frame wavelegnth with respecto to Lyman-alpha.</span>

<span class="sd">              Default = +18.5</span>

<span class="sd">        Nbins_tot : optional int</span>
<span class="sd">              Total number of wvelgnths bins.</span>

<span class="sd">              Default = 1000</span>

<span class="sd">        Denser_Center : optional bool</span>
<span class="sd">              Populates denser the regions close to Lyman-alpha</span>

<span class="sd">              Default = True</span>

<span class="sd">        normed : optional bool</span>
<span class="sd">              If True, nomalizes the line profile.</span>

<span class="sd">        scaled : optinal bool</span>
<span class="sd">              If True, divides the line profile by its maximum.</span>

<span class="sd">        **Output**</span>

<span class="sd">        rest_w_Arr : 1-D sequence of float</span>
<span class="sd">              Wavelgnth array where the line is evaluated in the rest frame.</span>

<span class="sd">        NN_line : 1-D sequence of float</span>
<span class="sd">              Line profile evaluated in rest_w_Arr after normalization or scaling.</span>

<span class="sd">        z_max_i : float</span>
<span class="sd">              Redshift of the source if the global maximum of the spectrum is the</span>
<span class="sd">              Lyman-alpha wavelegth.</span>

<span class="sd">        INPUT: 1-D secuence of float</span>
<span class="sd">              The actuall input to use in the Neural networks.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">rest_w_Arr</span> <span class="o">=</span> <span class="n">Define_wavelength_for_NN</span><span class="p">(</span> <span class="n">Delta_min</span><span class="o">=</span><span class="n">Delta_min</span> <span class="p">,</span> <span class="n">Delta_max</span><span class="o">=</span><span class="n">Delta_max</span> <span class="p">,</span> <span class="n">Nbins_tot</span><span class="o">=</span><span class="n">Nbins_tot</span> <span class="p">,</span> <span class="n">Denser_Center</span><span class="o">=</span><span class="n">Denser_Center</span> <span class="p">)</span> 

    <span class="n">w_r_i_Arr</span> <span class="p">,</span> <span class="n">Delta_r_i_Arr</span> <span class="p">,</span> <span class="n">f_r_i_Arr</span> <span class="p">,</span> <span class="n">z_max_i</span> <span class="o">=</span> <span class="n">NN_convert_Obs_Line_to_proxy_rest_line</span><span class="p">(</span> <span class="n">w_Arr</span><span class="p">,</span> <span class="n">f_Arr</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="n">normed</span> <span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="n">scaled</span><span class="p">)</span>

    <span class="n">NN_line</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span> <span class="n">rest_w_Arr</span> <span class="p">,</span> <span class="n">w_r_i_Arr</span> <span class="p">,</span> <span class="n">f_r_i_Arr</span> <span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="n">f_r_i_Arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">f_r_i_Arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>

    <span class="n">NN_line</span> <span class="o">=</span> <span class="n">NN_line</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">NN_line</span> <span class="p">)</span>

    <span class="n">INPUT</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span> <span class="p">(</span> <span class="n">NN_line</span> <span class="p">,</span> <span class="n">z_max_i</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">FWHM</span> <span class="p">)</span>  <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">PIX</span> <span class="p">)</span>  <span class="p">)</span> <span class="p">)</span> <span class="p">]</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">rest_w_Arr</span> <span class="p">,</span> <span class="n">NN_line</span> <span class="p">,</span> <span class="n">z_max_i</span> <span class="p">,</span> <span class="n">INPUT</span> </div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Generate_a_line_for_training"><a class="viewcode-back" href="../funcs.html#funcs.Generate_a_line_for_training">[docs]</a><span class="k">def</span> <span class="nf">Generate_a_line_for_training</span><span class="p">(</span> <span class="n">z_t</span> <span class="p">,</span> <span class="n">V_t</span><span class="p">,</span> <span class="n">log_N_t</span><span class="p">,</span> <span class="n">t_t</span><span class="p">,</span> <span class="n">F_t</span><span class="p">,</span> <span class="n">log_EW_t</span><span class="p">,</span> <span class="n">W_t</span><span class="p">,</span> <span class="n">PNR_t</span><span class="p">,</span> <span class="n">FWHM_t</span><span class="p">,</span> <span class="n">PIX_t</span><span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="p">,</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">Delta_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">18.5</span> <span class="p">,</span> <span class="n">Delta_max</span><span class="o">=</span><span class="mf">18.5</span> <span class="p">,</span> <span class="n">Denser_Center</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span> <span class="n">Nbins_tot</span><span class="o">=</span><span class="mi">1000</span> <span class="p">):</span>
    
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates a mock line profile at the desired redshift and returns all the NN</span>
<span class="sd">        products.</span>

<span class="sd">        **Input**</span>

<span class="sd">        z_t : float</span>
<span class="sd">              Redshift</span>

<span class="sd">        V_t : float</span>
<span class="sd">              Outflow expansion velocity [km/s]</span>

<span class="sd">        log_N_t : float</span>
<span class="sd">                  logarithmic of the neutral hydrogen column density in cm**-2</span>

<span class="sd">        t_t : float</span>
<span class="sd">              Dust optical depth</span>

<span class="sd">        F_t : float</span>
<span class="sd">              Total flux of the line. You can pass 1.</span>

<span class="sd">        log_EW_t : optional, float</span>
<span class="sd">                   Logarithmic of the rest frame intrisic equivalent width of the line [A]</span>
<span class="sd">                   Requiered if Geometry == &#39;Thin_Shell_Cont&#39;</span>

<span class="sd">        W_t : optional, float</span>
<span class="sd">               Rest frame intrisic width of the Lyman-alpha line [A]</span>
<span class="sd">               Requiered if Geometry == &#39;Thin_Shell_Cont&#39;</span>

<span class="sd">        PNR_t : float</span>
<span class="sd">                Signal to noise ratio of the global maximum of the line profile.</span>

<span class="sd">        FWHM_t : float</span>
<span class="sd">                 Full width half maximum [A] of the experiment. This dilutes the line profile.</span>

<span class="sd">        PIX_t : float</span>
<span class="sd">                Pixel size in wavelgnth [A] of the experiment. This binnes the line profile.</span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information.</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>

<span class="sd">        Delta_min : optional float</span>
<span class="sd">              Defines the minimum rest frame wavelegnth with respecto to Lyman-alpha.</span>

<span class="sd">              Default = -18.5</span>

<span class="sd">        Delta_min : optional float</span>
<span class="sd">              Defines the maximum rest frame wavelegnth with respecto to Lyman-alpha.</span>

<span class="sd">              Default = +18.5</span>

<span class="sd">        Nbins_tot : optional int</span>
<span class="sd">              Total number of wvelgnths bins.</span>

<span class="sd">              Default = 1000</span>

<span class="sd">        Denser_Center : optional bool</span>
<span class="sd">              Populates denser the regions close to Lyman-alpha</span>

<span class="sd">              Default = True</span>

<span class="sd">        normed : optional bool</span>
<span class="sd">              If True, nomalizes the line profile.</span>

<span class="sd">        scaled : optinal bool</span>
<span class="sd">              If True, divides the line profile by its maximum.</span>

<span class="sd">        **Output**</span>

<span class="sd">        rest_w_Arr : 1-D sequence of float</span>
<span class="sd">              Wavelgnth array where the line is evaluated in the rest frame.</span>

<span class="sd">        train_line : 1-D sequence of float</span>
<span class="sd">              Line profile.</span>

<span class="sd">        z_max_i : float</span>
<span class="sd">              Redshift of the source if the global maximum of the spectrum is the</span>
<span class="sd">              Lyman-alpha wavelegth.</span>

<span class="sd">        INPUT: 1-D secuence of float</span>
<span class="sd">              The actuall input to use in the Neural networks.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">w_t_Arr</span> <span class="p">,</span> <span class="n">f_t_Arr</span> <span class="p">,</span> <span class="n">Noise_t_Arr</span> <span class="o">=</span> <span class="n">Generate_a_real_line</span><span class="p">(</span> <span class="n">z_t</span> <span class="p">,</span> <span class="n">V_t</span><span class="p">,</span> <span class="n">log_N_t</span><span class="p">,</span> <span class="n">t_t</span><span class="p">,</span> <span class="n">F_t</span><span class="p">,</span> <span class="n">log_EW_t</span><span class="p">,</span> <span class="n">W_t</span> <span class="p">,</span> <span class="n">PNR_t</span><span class="p">,</span> <span class="n">FWHM_t</span><span class="p">,</span> <span class="n">PIX_t</span><span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>

    <span class="n">rest_w_Arr</span> <span class="p">,</span> <span class="n">train_line</span> <span class="p">,</span> <span class="n">z_max_i</span> <span class="p">,</span> <span class="n">INPUT</span> <span class="o">=</span> <span class="n">Treat_A_Line_To_NN_Input</span><span class="p">(</span> <span class="n">w_t_Arr</span> <span class="p">,</span> <span class="n">f_t_Arr</span> <span class="p">,</span> <span class="n">PIX_t</span> <span class="p">,</span> <span class="n">FWHM_t</span> <span class="p">,</span> <span class="n">Delta_min</span><span class="o">=</span><span class="n">Delta_min</span> <span class="p">,</span> <span class="n">Delta_max</span><span class="o">=</span><span class="n">Delta_max</span> <span class="p">,</span> <span class="n">Nbins_tot</span><span class="o">=</span><span class="n">Nbins_tot</span> <span class="p">,</span> <span class="n">Denser_Center</span><span class="o">=</span><span class="n">Denser_Center</span> <span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="n">normed</span> <span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="n">scaled</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">rest_w_Arr</span> <span class="p">,</span> <span class="n">train_line</span> <span class="p">,</span> <span class="n">z_max_i</span> <span class="p">,</span> <span class="n">INPUT</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="generate_a_REAL_line_SN"><a class="viewcode-back" href="../funcs.html#funcs.generate_a_REAL_line_SN">[docs]</a><span class="k">def</span> <span class="nf">generate_a_REAL_line_SN</span><span class="p">(</span> <span class="n">z_f</span> <span class="p">,</span> <span class="n">V_f</span> <span class="p">,</span> <span class="n">logNH_f</span> <span class="p">,</span> <span class="n">ta_f</span> <span class="p">,</span> <span class="n">F_line_f</span> <span class="p">,</span> <span class="n">SN_f</span> <span class="p">,</span> <span class="n">FWHM_f</span> <span class="p">,</span> <span class="n">PIX_f</span> <span class="p">,</span> <span class="n">w_min</span> <span class="p">,</span> <span class="n">w_max</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Makes a mock line profile for the other geometries that are not Thin_Shell_Cont geometry.</span>

<span class="sd">        **Input**</span>

<span class="sd">        z_t : float</span>
<span class="sd">              Redshift</span>

<span class="sd">        V_t : float</span>
<span class="sd">              Outflow expansion velocity [km/s]</span>

<span class="sd">        log_N_t : float</span>
<span class="sd">                  logarithmic of the neutral hydrogen column density in cm**-2</span>

<span class="sd">        t_t : float</span>
<span class="sd">              Dust optical depth</span>

<span class="sd">        F_line_f : float</span>
<span class="sd">              Total flux of the line. You can pass 1.</span>

<span class="sd">        SN_t : float</span>
<span class="sd">                Signal to noise ratio.</span>

<span class="sd">        FWHM_t : float</span>
<span class="sd">                 Full width half maximum [A] of the experiment. This dilutes the line profile.</span>

<span class="sd">        PIX_t : float</span>
<span class="sd">                Pixel size in wavelgnth [A] of the experiment. This binnes the line profile.</span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information.</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>

<span class="sd">        **Output**</span>

<span class="sd">        wave_pix_Arr : 1-D sequence of float</span>
<span class="sd">                     Wavelgnth array where the line is evaluated in the observed frame.</span>

<span class="sd">        noisy_Line_Arr : 1-D sequence of float</span>
<span class="sd">                   Line profile flux density in arbitrary units.</span>

<span class="sd">        dic : python dictionaty.</span>
<span class="sd">              Contains all the meta data used to get the line profiles:</span>
<span class="sd">                &#39;w_rest&#39;    : restframe wavelength of line before reducing quality</span>
<span class="sd">                &#39;w_obs&#39;     : wavelength of line before reducing quality</span>
<span class="sd">                &#39;Intrinsic&#39; : line profile before quality reduction</span>
<span class="sd">                &#39;Diluted&#39;   : Line profile after the FWHM has been applyed.</span>
<span class="sd">                &#39;Pixelated&#39; : Line profile after the FWHM and PIX have been applyed</span>
<span class="sd">                &#39;Noise&#39;     : Particular noise patern used.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">w_rest_Arr</span> <span class="p">,</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">line_Arr</span> <span class="o">=</span> <span class="n">generate_a_obs_line</span><span class="p">(</span> <span class="n">z_f</span> <span class="p">,</span> <span class="n">V_f</span> <span class="p">,</span> <span class="n">logNH_f</span> <span class="p">,</span> <span class="n">ta_f</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>

    <span class="n">diluted_Arr</span> <span class="o">=</span> <span class="n">dilute_line</span><span class="p">(</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">line_Arr</span> <span class="p">,</span> <span class="n">FWHM_f</span> <span class="p">)</span>

    <span class="n">wave_pix_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">w_min</span> <span class="p">,</span> <span class="n">w_max</span> <span class="p">,</span> <span class="n">PIX_f</span> <span class="p">)</span>

    <span class="n">pixled_Arr</span> <span class="o">=</span> <span class="n">bin_one_line</span><span class="p">(</span> <span class="n">wavelength_Arr</span> <span class="p">,</span> <span class="n">diluted_Arr</span> <span class="p">,</span> <span class="n">wave_pix_Arr</span> <span class="p">,</span> <span class="n">PIX_f</span> <span class="p">)</span>

    <span class="n">pixled_Arr</span> <span class="o">=</span> <span class="n">pixled_Arr</span> <span class="o">*</span> <span class="n">F_line_f</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">pixled_Arr</span> <span class="p">,</span> <span class="n">wave_pix_Arr</span> <span class="p">)</span>

    <span class="n">noisy_Line_Arr</span> <span class="p">,</span> <span class="n">noise_Arr</span> <span class="o">=</span> <span class="n">Add_noise_to_line</span><span class="p">(</span> <span class="n">wave_pix_Arr</span> <span class="p">,</span> <span class="n">pixled_Arr</span> <span class="p">,</span> <span class="n">SN_f</span> <span class="p">,</span> <span class="n">same_norm</span><span class="o">=</span><span class="kc">False</span> <span class="p">)</span>

    <span class="c1"># Other usful things :</span>

    <span class="n">dic</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;w_rest&#39;</span>    <span class="p">]</span> <span class="o">=</span> <span class="n">w_rest_Arr</span>
    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;w_obs&#39;</span>     <span class="p">]</span> <span class="o">=</span> <span class="n">wavelength_Arr</span>
    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;Intrinsic&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">line_Arr</span>
    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;Diluted&#39;</span>   <span class="p">]</span> <span class="o">=</span> <span class="n">diluted_Arr</span>
    <span class="n">dic</span><span class="p">[</span> <span class="s1">&#39;Pixelated&#39;</span> <span class="p">]</span> <span class="o">=</span> <span class="n">pixled_Arr</span>

    <span class="k">return</span> <span class="n">wave_pix_Arr</span> <span class="p">,</span> <span class="n">noisy_Line_Arr</span> <span class="p">,</span> <span class="n">dic</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>

<span class="c1">## MCMC section</span>

<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="log_likelihood"><a class="viewcode-back" href="../funcs.html#funcs.log_likelihood">[docs]</a><span class="k">def</span> <span class="nf">log_likelihood</span><span class="p">(</span> <span class="n">w_obs_Arr</span> <span class="p">,</span> <span class="n">f_obs_Arr</span> <span class="p">,</span> <span class="n">s_obs_Arr</span> <span class="p">,</span> <span class="n">w_model_Arr</span> <span class="p">,</span> <span class="n">f_model_Arr</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Logarithm of the likelihood between an observed spectrum and a model spectrum.</span>

<span class="sd">        **Input**</span>

<span class="sd">        w_obs_Arr : 1-D sequence of float</span>
<span class="sd">                    wavelength where the observed density flux is evaluated.</span>

<span class="sd">        f_obs_Arr : 1-D sequence of float</span>
<span class="sd">                    Observed flux density</span>

<span class="sd">        s_obs_Arr : 1-D sequence of float</span>
<span class="sd">                    Uncertanty in the observed flux density.</span>

<span class="sd">        w_model_Arr : 1-D sequence of float</span>
<span class="sd">                      wavelength where the model density flux is evaluated</span>

<span class="sd">        f_model_Arr : 1-D sequence of float</span>
<span class="sd">                      Model flux density</span>

<span class="sd">        **Output**</span>

<span class="sd">        log_like : float</span>
<span class="sd">                   Logarithm of the likelihood</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">f_my_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span> <span class="n">w_obs_Arr</span> <span class="p">,</span> <span class="n">w_model_Arr</span> <span class="p">,</span> <span class="n">f_model_Arr</span> <span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span> <span class="n">f_my_Arr</span> <span class="p">)</span>

    <span class="n">sigma2</span> <span class="o">=</span> <span class="n">s_obs_Arr</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">cc</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">f_my_Arr</span>     <span class="o">=</span> <span class="n">f_my_Arr</span><span class="p">[</span>  <span class="n">mask</span> <span class="p">]</span>
    <span class="n">sigma2</span>       <span class="o">=</span> <span class="n">sigma2</span><span class="p">[</span>    <span class="n">mask</span> <span class="p">]</span>
    <span class="n">my_f_obs_Arr</span> <span class="o">=</span> <span class="n">f_obs_Arr</span><span class="p">[</span> <span class="n">mask</span> <span class="p">]</span>

    <span class="n">log_like</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">cc</span> <span class="o">*</span><span class="p">(</span> <span class="n">my_f_obs_Arr</span> <span class="o">-</span> <span class="n">f_my_Arr</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">sigma2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sigma2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">log_like</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Prior_f"><a class="viewcode-back" href="../funcs.html#funcs.Prior_f">[docs]</a><span class="k">def</span> <span class="nf">Prior_f</span><span class="p">(</span> <span class="n">theta</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Decides when a walker from the MCMC is out for the Thin_Shell,</span>
<span class="sd">        Galactic wind and bicones.</span>

<span class="sd">        **Input**</span>

<span class="sd">        theta : 1-D sequence of float</span>
<span class="sd">                Contains the parameters of the mode:</span>
<span class="sd">                    theta[0] = logarithim of the expansion velocity</span>
<span class="sd">                    theta[1] = logarithim of the neutral hydrogen column density</span>
<span class="sd">                    theta[2] = logarithim of the dust optical depth</span>

<span class="sd">        **Output**</span>

<span class="sd">        True  if the walker is  inside</span>
<span class="sd">        False if the walker is outside</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">log_V</span> <span class="p">,</span> <span class="n">log_N</span> <span class="p">,</span> <span class="n">log_t</span> <span class="p">,</span> <span class="n">redshift</span> <span class="o">=</span> <span class="n">theta</span>

    <span class="n">log_V_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> 
    <span class="n">log_V_max</span> <span class="o">=</span>  <span class="mf">3.</span> 

    <span class="n">log_N_min</span> <span class="o">=</span> <span class="mf">17.0</span> 
    <span class="n">log_N_max</span> <span class="o">=</span> <span class="mf">21.5</span>

    <span class="n">log_t_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.75</span>
    <span class="n">log_t_max</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.125</span>

    <span class="n">z_min</span> <span class="o">=</span>   <span class="mf">0.0</span>
    <span class="n">z_max</span> <span class="o">=</span> <span class="mf">100.0</span>

    <span class="c1">#if log_V &lt; np.log10( 40 ) : log_N_max = 20.5</span>
 
    <span class="k">if</span> <span class="n">log_V</span> <span class="o">&lt;</span> <span class="n">log_V_min</span> <span class="ow">or</span> <span class="n">log_V</span> <span class="o">&gt;</span> <span class="n">log_V_max</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">log_N</span> <span class="o">&lt;</span> <span class="n">log_N_min</span> <span class="ow">or</span> <span class="n">log_N</span> <span class="o">&gt;</span> <span class="n">log_N_max</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">log_t</span> <span class="o">&lt;</span> <span class="n">log_t_min</span> <span class="ow">or</span> <span class="n">log_t</span> <span class="o">&gt;</span> <span class="n">log_t_max</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">redshift</span> <span class="o">&lt;</span> <span class="n">z_min</span> <span class="ow">or</span> <span class="n">redshift</span> <span class="o">&gt;</span> <span class="n">z_max</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Prior_f_5"><a class="viewcode-back" href="../funcs.html#funcs.Prior_f_5">[docs]</a><span class="k">def</span> <span class="nf">Prior_f_5</span><span class="p">(</span> <span class="n">theta</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Decides when a walker from the MCMC is out for the Thin_Shell_Cont,</span>

<span class="sd">        **Input**</span>

<span class="sd">        theta : 1-D sequence of float</span>
<span class="sd">                Contains the parameters of the mode:</span>
<span class="sd">                    theta[0] = logarithim of the expansion velocity</span>
<span class="sd">                    theta[1] = logarithim of the neutral hydrogen column density</span>
<span class="sd">                    theta[2] = logarithim of the dust optical depth</span>
<span class="sd">                    theta[3] = redshift</span>
<span class="sd">                    theta[4] = logarithm of the intrinsic equivalent width</span>
<span class="sd">                    theta[5] = intrinsic width</span>

<span class="sd">        **Output**</span>

<span class="sd">        True  if the walker is  inside</span>
<span class="sd">        False if the walker is outside</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">log_V</span> <span class="p">,</span> <span class="n">log_N</span> <span class="p">,</span> <span class="n">log_t</span> <span class="p">,</span> <span class="n">redshift</span> <span class="p">,</span> <span class="n">log_EW</span> <span class="p">,</span> <span class="n">Wi</span> <span class="o">=</span> <span class="n">theta</span>

    <span class="n">log_V_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> 
    <span class="n">log_V_max</span> <span class="o">=</span>  <span class="mf">3.</span> 

    <span class="n">log_N_min</span> <span class="o">=</span> <span class="mf">17.0</span> 
    <span class="n">log_N_max</span> <span class="o">=</span> <span class="mf">21.5</span>

    <span class="n">log_t_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.00</span>
    <span class="n">log_t_max</span> <span class="o">=</span>  <span class="mf">0.000</span>

    <span class="n">log_EW_min</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
    <span class="n">log_EW_max</span> <span class="o">=</span>  <span class="mf">3.</span>

    <span class="n">Wi_min</span> <span class="o">=</span>  <span class="mf">0.01</span>
    <span class="n">Wi_max</span> <span class="o">=</span>  <span class="mf">6.</span>

    <span class="n">z_min</span> <span class="o">=</span>   <span class="mf">0.0</span>
    <span class="n">z_max</span> <span class="o">=</span>   <span class="mf">7.0</span>

    <span class="k">if</span> <span class="n">log_V</span>  <span class="o">&lt;</span> <span class="n">log_V_min</span>  <span class="ow">or</span> <span class="n">log_V</span>  <span class="o">&gt;</span> <span class="n">log_V_max</span>  <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">log_N</span>  <span class="o">&lt;</span> <span class="n">log_N_min</span>  <span class="ow">or</span> <span class="n">log_N</span>  <span class="o">&gt;</span> <span class="n">log_N_max</span>  <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">log_t</span>  <span class="o">&lt;</span> <span class="n">log_t_min</span>  <span class="ow">or</span> <span class="n">log_t</span>  <span class="o">&gt;</span> <span class="n">log_t_max</span>  <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">log_EW</span> <span class="o">&lt;</span> <span class="n">log_EW_min</span> <span class="ow">or</span> <span class="n">log_EW</span> <span class="o">&gt;</span> <span class="n">log_EW_max</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">Wi</span>     <span class="o">&lt;</span>     <span class="n">Wi_min</span> <span class="ow">or</span>     <span class="n">Wi</span> <span class="o">&gt;</span>     <span class="n">Wi_max</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">redshift</span> <span class="o">&lt;</span> <span class="n">z_min</span> <span class="ow">or</span> <span class="n">redshift</span> <span class="o">&gt;</span> <span class="n">z_max</span> <span class="p">:</span> <span class="k">return</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="kc">True</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="log_likeliehood_of_model_5"><a class="viewcode-back" href="../funcs.html#funcs.log_likeliehood_of_model_5">[docs]</a><span class="k">def</span> <span class="nf">log_likeliehood_of_model_5</span><span class="p">(</span> <span class="n">theta</span> <span class="p">,</span> <span class="n">w_obs_Arr</span> <span class="p">,</span> <span class="n">f_obs_Arr</span> <span class="p">,</span> <span class="n">s_obs_Arr</span> <span class="p">,</span> <span class="n">FWHM</span><span class="p">,</span> <span class="n">PIX</span><span class="p">,</span> <span class="n">w_min</span><span class="p">,</span> <span class="n">w_max</span><span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="p">,</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">z_in</span> <span class="p">,</span> <span class="n">FORCE_z</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Logarithm of the likelihood between an observed spectrum and a model </span>
<span class="sd">        configuration defined in theta</span>

<span class="sd">        **Input**</span>

<span class="sd">        theta : 1-D sequence of float</span>
<span class="sd">                Contains the parameters of the mode:</span>
<span class="sd">                    theta[0] = logarithim of the expansion velocity</span>
<span class="sd">                    theta[1] = logarithim of the neutral hydrogen column density</span>
<span class="sd">                    theta[2] = logarithim of the dust optical depth</span>
<span class="sd">                    theta[3] = redshift</span>
<span class="sd">                    theta[4] = logarithm of the intrinsic equivalent width</span>
<span class="sd">                    theta[5] = intrinsic width</span>

<span class="sd">        w_obs_Arr : 1-D sequence of float</span>
<span class="sd">                    wavelength where the observed density flux is evaluated.</span>

<span class="sd">        f_obs_Arr : 1-D sequence of float</span>
<span class="sd">                    Observed flux density</span>

<span class="sd">        s_obs_Arr : 1-D sequence of float</span>
<span class="sd">                    Uncertanty in the observed flux density.</span>

<span class="sd">        FWHM : float</span>
<span class="sd">              Full width half maximum [A] of the experiment.</span>

<span class="sd">        PIX : float</span>
<span class="sd">              Pixel size in wavelgnth [A] of the experiment.</span>

<span class="sd">        w_min : float</span>
<span class="sd">                minimum wavelength in the observed frame [A] to use. This matches the minimum</span>
<span class="sd">                wavelgnth of wave_pix_Arr (see below).</span>

<span class="sd">        w_max : float</span>
<span class="sd">                maximum  wavelength in the observed frame [A] to use. This might not be exactly</span>
<span class="sd">                the maximum wavelgnth of wave_pix_Arr (see below) due to pixelization.</span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information.</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>

<span class="sd">        z_in : 1-D sequence of floats.</span>
<span class="sd">               Redshift range to be considered. In principle the redshift can be outside</span>
<span class="sd">               z_in[0] is the minimum redshift </span>
<span class="sd">               z_in[1] is the maximum redshift </span>

<span class="sd">        FORCE_z : optional bool</span>
<span class="sd">                  If True, force the redshift to be inside z_in </span>

<span class="sd">        **Output**</span>

<span class="sd">        log_like : float</span>
<span class="sd">                   Logarithm of the likelihood</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Prior_f_5</span><span class="p">(</span> <span class="n">theta</span> <span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="n">log_V</span> <span class="p">,</span> <span class="n">log_N</span> <span class="p">,</span> <span class="n">log_t</span> <span class="p">,</span> <span class="n">redshift</span> <span class="p">,</span> <span class="n">log_EW</span> <span class="p">,</span> <span class="n">Wi</span> <span class="o">=</span> <span class="n">theta</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">z_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">FORCE_z</span> <span class="p">:</span>
       <span class="k">if</span> <span class="n">redshift</span> <span class="o">&lt;</span> <span class="n">z_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">:</span> <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> 
       <span class="k">if</span> <span class="n">redshift</span> <span class="o">&gt;</span> <span class="n">z_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span> <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> 

    <span class="n">V_f</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">log_V</span>
    <span class="n">t_f</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">log_t</span>

    <span class="n">FF</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="n">w_model_Arr</span> <span class="p">,</span> <span class="n">f_model_Arr</span> <span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generate_a_REAL_line_Noise_w</span><span class="p">(</span> <span class="n">redshift</span><span class="p">,</span> <span class="n">V_f</span><span class="p">,</span> <span class="n">log_N</span><span class="p">,</span> <span class="n">t_f</span><span class="p">,</span> <span class="n">FF</span> <span class="p">,</span> <span class="n">log_EW</span> <span class="p">,</span> <span class="n">Wi</span> <span class="p">,</span> <span class="n">w_obs_Arr</span> <span class="p">,</span> <span class="n">s_obs_Arr</span><span class="o">*</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">FWHM</span><span class="p">,</span> <span class="n">PIX</span><span class="p">,</span> <span class="n">w_min</span><span class="p">,</span> <span class="n">w_max</span><span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>

    <span class="n">f_model_Arr</span> <span class="o">=</span> <span class="n">f_model_Arr</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_model_Arr</span> <span class="p">)</span> 

    <span class="n">f_obs_Arr</span> <span class="o">=</span> <span class="n">f_obs_Arr</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_obs_Arr</span> <span class="p">)</span>
    <span class="n">s_obs_Arr</span> <span class="o">=</span> <span class="n">s_obs_Arr</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_obs_Arr</span> <span class="p">)</span>

    <span class="n">log_like</span> <span class="o">=</span> <span class="n">log_likelihood</span><span class="p">(</span> <span class="n">w_obs_Arr</span> <span class="p">,</span> <span class="n">f_obs_Arr</span> <span class="p">,</span> <span class="n">s_obs_Arr</span> <span class="p">,</span> <span class="n">w_model_Arr</span> <span class="p">,</span> <span class="n">f_model_Arr</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">log_like</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="init_walkers_5"><a class="viewcode-back" href="../funcs.html#funcs.init_walkers_5">[docs]</a><span class="k">def</span> <span class="nf">init_walkers_5</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">,</span> <span class="n">log_V_in</span> <span class="p">,</span> <span class="n">log_N_in</span> <span class="p">,</span> <span class="n">log_t_in</span> <span class="p">,</span> <span class="n">z_in</span> <span class="p">,</span> <span class="n">log_E_in</span> <span class="p">,</span> <span class="n">W_in</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Creates the initial position for the walkers</span>

<span class="sd">        **Input**</span>

<span class="sd">        N_walkers : int</span>
<span class="sd">                    Number of walkers</span>

<span class="sd">        N_dim : int</span>
<span class="sd">                Number of dimensions (6)</span>
<span class="sd">        </span>
<span class="sd">        log_V_in : 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the bulk velocity</span>
<span class="sd">               log_V_in[0] is the minimum </span>
<span class="sd">               log_V_in[1] is the maximum</span>

<span class="sd">        log_N_in : 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the neutral hydrogen column density</span>
<span class="sd">               log_N_in[0] is the minimum </span>
<span class="sd">               log_N_in[1] is the maximum</span>
<span class="sd"> </span>
<span class="sd">        log_t_in : 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the dust optical depth</span>
<span class="sd">               log_t_in[0] is the minimum </span>
<span class="sd">               log_t_in[1] is the maximum</span>

<span class="sd">        z_in : 1-D sequence of floats.</span>
<span class="sd">               Redshift range to be considered. </span>
<span class="sd">               z_in[0] is the minimum redshift</span>
<span class="sd">               z_in[1] is the maximum redshift</span>

<span class="sd">        log_E_in : 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the intrinsic equivalent width</span>
<span class="sd">               log_E_in[0] is the minimum </span>
<span class="sd">               log_E_in[1] is the maximum</span>

<span class="sd">        W_in : 1-D sequence of floats.</span>
<span class="sd">               Instrinsic line width range to be considered. </span>
<span class="sd">               W_in[0] is the minimum redshift</span>
<span class="sd">               W_in[1] is the maximum redshift</span>

<span class="sd">        **Output**</span>

<span class="sd">        theta_0 : 1-D sequence of float</span>
<span class="sd">                Contains the parameters of the mode:</span>
<span class="sd">                    theta_0[:,0] = logarithim of the expansion velocity</span>
<span class="sd">                    theta_0[:,1] = logarithim of the neutral hydrogen column density</span>
<span class="sd">                    theta_0[:,2] = logarithim of the dust optical depth</span>
<span class="sd">                    theta_0[:,3] = redshift</span>
<span class="sd">                    theta_0[:,4] = logarithm of the intrinsic equivalent width</span>
<span class="sd">                    theta_0[:,5] = intrinsic width</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">init_V_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_N_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_t_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_E_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_z_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span>     <span class="n">z_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>     <span class="n">z_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span>     <span class="n">z_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_W_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span>     <span class="n">W_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>     <span class="n">W_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span>     <span class="n">W_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">Theta_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="o">*</span> <span class="n">N_dim</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">)</span>

    <span class="n">Theta_0</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="n">init_V_Arr</span>
    <span class="n">Theta_0</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="n">init_N_Arr</span>
    <span class="n">Theta_0</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="n">init_t_Arr</span>
    <span class="n">Theta_0</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="n">init_z_Arr</span>
    <span class="n">Theta_0</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="n">init_E_Arr</span>
    <span class="n">Theta_0</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="n">init_W_Arr</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="n">Theta_0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">Prior_f_5</span><span class="p">(</span> <span class="n">theta</span> <span class="p">)</span> <span class="p">:</span>

            <span class="n">Theta_0</span><span class="p">[</span> <span class="n">i</span> <span class="p">,</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Theta_0</span><span class="p">[</span> <span class="n">i</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="n">Theta_0</span><span class="p">[</span> <span class="n">i</span> <span class="p">,</span> <span class="mi">2</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="n">Theta_0</span><span class="p">[</span> <span class="n">i</span> <span class="p">,</span> <span class="mi">3</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span>     <span class="n">z_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>     <span class="n">z_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span>     <span class="n">z_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">Theta_0</span><span class="p">[</span> <span class="n">i</span> <span class="p">,</span> <span class="mi">4</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
            <span class="n">Theta_0</span><span class="p">[</span> <span class="n">i</span> <span class="p">,</span> <span class="mi">5</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span>     <span class="n">W_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span>     <span class="n">W_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span>     <span class="n">W_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 

            <span class="n">theta</span> <span class="o">=</span> <span class="n">Theta_0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">Theta_0</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="MCMC_get_region_6D"><a class="viewcode-back" href="../funcs.html#funcs.MCMC_get_region_6D">[docs]</a><span class="k">def</span> <span class="nf">MCMC_get_region_6D</span><span class="p">(</span> <span class="n">MODE</span> <span class="p">,</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_tar_Arr</span> <span class="p">,</span> <span class="n">s_tar_Arr</span> <span class="p">,</span> <span class="n">FWHM</span> <span class="p">,</span> <span class="n">PIX</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">Geometry_Mode</span><span class="o">=</span><span class="s1">&#39;Outflow&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Computes the region of where the walkers are initialize</span>

<span class="sd">        **Input**</span>

<span class="sd">        MODE : string</span>
<span class="sd">               Method, DNN or PSO</span>

<span class="sd">        w_tar_Arr : 1-D sequence of floats</span>
<span class="sd">                    wavelength where the densit flux is evaluated</span>

<span class="sd">        f_tar_Arr : 1-D sequence of floats</span>
<span class="sd">                    Densit flux is evaluated</span>

<span class="sd">        s_tar_Arr : 1-D sequence of floats</span>
<span class="sd">                    Uncertainty of the densit flux is evaluated</span>

<span class="sd">        FWHM : float</span>
<span class="sd">              Full width half maximum [A] of the experiment.</span>

<span class="sd">        PIX : float</span>
<span class="sd">              Pixel size in wavelgnth [A] of the experiment.</span>

<span class="sd">        w_min : float</span>
<span class="sd">                minimum wavelength in the observed frame [A] to use. This matches the minimum</span>
<span class="sd">                wavelgnth of wave_pix_Arr (see below).</span>

<span class="sd">        w_max : float</span>
<span class="sd">                maximum  wavelength in the observed frame [A] to use. This might not be exactly</span>
<span class="sd">                the maximum wavelgnth of wave_pix_Arr (see below) due to pixelization.</span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information.</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>


<span class="sd">        Geometry_Mode : optinal string</span>
<span class="sd">                        Changes from inflow (&#39;Inflow&#39;) to outflow (&#39;Outflow&#39;)</span>
<span class="sd">                        Default: &#39;Outflow&#39;</span>

<span class="sd">        **Output**</span>

<span class="sd">        log_V_in : 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the bulk velocity</span>
<span class="sd">               log_V_in[0] is the minimum</span>
<span class="sd">               log_V_in[1] is the maximum</span>

<span class="sd">        log_N_in : 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the neutral hydrogen column density</span>
<span class="sd">               log_N_in[0] is the minimum</span>
<span class="sd">               log_N_in[1] is the maximum</span>

<span class="sd">        log_t_in : 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the dust optical depth</span>
<span class="sd">               log_t_in[0] is the minimum</span>
<span class="sd">               log_t_in[1] is the maximum</span>

<span class="sd">        z_in : 1-D sequence of floats.</span>
<span class="sd">               Redshift range to be considered.</span>
<span class="sd">               z_in[0] is the minimum redshift</span>
<span class="sd">               z_in[1] is the maximum redshift</span>

<span class="sd">        log_E_in : 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the intrinsic equivalent width</span>
<span class="sd">               log_E_in[0] is the minimum</span>
<span class="sd">               log_E_in[1] is the maximum</span>

<span class="sd">        W_in : 1-D sequence of floats.</span>
<span class="sd">               Instrinsic line width range to be considered.</span>
<span class="sd">               W_in[0] is the minimum redshift</span>
<span class="sd">               W_in[1] is the maximum redshift</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;PSO&#39;</span> <span class="p">:</span>

        <span class="n">n_particles</span> <span class="o">=</span> <span class="mi">400</span>
        <span class="n">n_iters</span>     <span class="o">=</span> <span class="mi">100</span>

        <span class="n">cost</span> <span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">PSO_Analysis</span><span class="p">(</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_tar_Arr</span> <span class="p">,</span> <span class="n">FWHM</span> <span class="p">,</span> <span class="n">PIX</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">n_particles</span> <span class="p">,</span> <span class="n">n_iters</span> <span class="p">)</span>

        <span class="n">log_V_in</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">0.999</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="mf">1.001</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">log_N_in</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">0.999</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">,</span> <span class="mf">1.001</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">log_t_in</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">0.999</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">,</span> <span class="mf">1.001</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">log_E_in</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">0.999</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">,</span> <span class="mf">1.001</span> <span class="o">*</span> <span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">]</span>

        <span class="n">z_in</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">0.999</span> <span class="o">*</span>       <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="mf">1.001</span> <span class="o">*</span>       <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span>
        <span class="n">W_in</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">0.999</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">pos</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">,</span> <span class="mf">1.001</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">pos</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">]</span>

        <span class="n">Best</span> <span class="o">=</span> <span class="p">[</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">pos</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="p">)</span> <span class="p">]</span>

    <span class="k">if</span> <span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;DNN&#39;</span><span class="p">:</span>

        <span class="n">machine_data</span> <span class="o">=</span> <span class="n">Load_NN_model</span><span class="p">(</span> <span class="n">Geometry_Mode</span> <span class="p">)</span>

        <span class="n">loaded_model</span> <span class="o">=</span> <span class="n">machine_data</span><span class="p">[</span><span class="s1">&#39;Machine&#39;</span><span class="p">]</span>

        <span class="n">w_rest_Machine_Arr</span> <span class="o">=</span> <span class="n">machine_data</span><span class="p">[</span><span class="s1">&#39;w_rest&#39;</span><span class="p">]</span>

        <span class="n">_</span> <span class="p">,</span> <span class="n">_</span> <span class="p">,</span> <span class="n">log_V_sol_Arr</span> <span class="p">,</span> <span class="n">log_N_sol_Arr</span> <span class="p">,</span> <span class="n">log_t_sol_Arr</span> <span class="p">,</span> <span class="n">z_sol_Arr</span> <span class="p">,</span> <span class="n">log_E_sol_Arr</span> <span class="p">,</span> <span class="n">log_W_sol_Arr</span> <span class="o">=</span> <span class="n">NN_measure</span><span class="p">(</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_tar_Arr</span> <span class="p">,</span> <span class="n">s_tar_Arr</span> <span class="p">,</span> <span class="n">FWHM</span> <span class="p">,</span> <span class="n">PIX</span> <span class="p">,</span> <span class="n">loaded_model</span> <span class="p">,</span> <span class="n">w_rest_Machine_Arr</span> <span class="p">,</span> <span class="n">N_iter</span><span class="o">=</span><span class="mi">1000</span> <span class="p">)</span>

        <span class="n">log_V_in</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_V_sol_Arr</span> <span class="p">,</span>  <span class="mi">5</span> <span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_V_sol_Arr</span> <span class="p">,</span> <span class="mi">95</span> <span class="p">)</span> <span class="p">]</span>
        <span class="n">log_N_in</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_N_sol_Arr</span> <span class="p">,</span>  <span class="mi">5</span> <span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_N_sol_Arr</span> <span class="p">,</span> <span class="mi">95</span> <span class="p">)</span> <span class="p">]</span>
        <span class="n">log_t_in</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_t_sol_Arr</span> <span class="p">,</span>  <span class="mi">5</span> <span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_t_sol_Arr</span> <span class="p">,</span> <span class="mi">95</span> <span class="p">)</span> <span class="p">]</span>
        <span class="n">log_E_in</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_E_sol_Arr</span> <span class="p">,</span>  <span class="mi">5</span> <span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_E_sol_Arr</span> <span class="p">,</span> <span class="mi">95</span> <span class="p">)</span> <span class="p">]</span>
        <span class="n">log_W_in</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_W_sol_Arr</span> <span class="p">,</span>  <span class="mi">5</span> <span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_W_sol_Arr</span> <span class="p">,</span> <span class="mi">95</span> <span class="p">)</span> <span class="p">]</span>

        <span class="n">z_in</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">z_sol_Arr</span> <span class="p">,</span>  <span class="mi">5</span> <span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">z_sol_Arr</span> <span class="p">,</span> <span class="mi">95</span> <span class="p">)</span> <span class="p">]</span>

        <span class="n">W_in</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="n">log_W_in</span> <span class="p">)</span>

        <span class="n">Best</span> <span class="o">=</span> <span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">z_sol_Arr</span> <span class="p">,</span> <span class="mi">50</span> <span class="p">)</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_V_sol_Arr</span> <span class="p">,</span> <span class="mi">50</span> <span class="p">)</span> <span class="p">,</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_N_sol_Arr</span> <span class="p">,</span> <span class="mi">50</span> <span class="p">)</span> <span class="p">,</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_t_sol_Arr</span> <span class="p">,</span> <span class="mi">50</span> <span class="p">)</span> <span class="p">,</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_E_sol_Arr</span> <span class="p">,</span> <span class="mi">50</span> <span class="p">)</span> <span class="p">,</span>
                                                   <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">log_W_sol_Arr</span> <span class="p">,</span> <span class="mi">50</span> <span class="p">)</span> <span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">MODE</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;PSO&#39;</span> <span class="p">,</span> <span class="s1">&#39;DNN&#39;</span> <span class="p">]</span> <span class="p">:</span>

        <span class="n">log_V_in</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">log_N_in</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">log_t_in</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">log_E_in</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">W_in</span>     <span class="o">=</span> <span class="kc">None</span>

        <span class="n">w_f_max</span> <span class="o">=</span> <span class="n">w_tar_Arr</span><span class="p">[</span> <span class="n">f_tar_Arr</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">f_tar_Arr</span><span class="p">)</span> <span class="p">]</span>

        <span class="n">z_f_max</span> <span class="o">=</span> <span class="n">w_f_max</span> <span class="o">/</span> <span class="mf">1215.67</span> <span class="o">-</span> <span class="mf">1.</span>

        <span class="n">z_in</span> <span class="o">=</span> <span class="p">[</span> <span class="n">z_f_max</span><span class="o">*</span><span class="mf">0.99</span> <span class="p">,</span> <span class="n">z_f_max</span><span class="o">*</span><span class="mf">1.01</span> <span class="p">]</span>

        <span class="n">Best</span> <span class="o">=</span> <span class="p">[</span> <span class="n">z_f_max</span> <span class="p">,</span> <span class="kc">None</span> <span class="p">,</span> <span class="kc">None</span> <span class="p">,</span> <span class="kc">None</span> <span class="p">,</span> <span class="kc">None</span> <span class="p">,</span> <span class="kc">None</span> <span class="p">]</span>

    <span class="k">return</span> <span class="n">log_V_in</span> <span class="p">,</span> <span class="n">log_N_in</span> <span class="p">,</span> <span class="n">log_t_in</span> <span class="p">,</span> <span class="n">log_E_in</span> <span class="p">,</span> <span class="n">W_in</span> <span class="p">,</span> <span class="n">z_in</span> <span class="p">,</span> <span class="n">Best</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="MCMC_Analysis_sampler_5"><a class="viewcode-back" href="../funcs.html#funcs.MCMC_Analysis_sampler_5">[docs]</a><span class="k">def</span> <span class="nf">MCMC_Analysis_sampler_5</span><span class="p">(</span> <span class="n">w_target_Arr</span> <span class="p">,</span> <span class="n">f_target_Arr</span> <span class="p">,</span> <span class="n">s_target_Arr</span> <span class="p">,</span> <span class="n">FWHM</span> <span class="p">,</span> <span class="n">N_walkers</span> <span class="p">,</span> <span class="n">N_burn</span> <span class="p">,</span> <span class="n">N_steps</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">log_V_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">log_N_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">log_t_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">z_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">log_E_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">W_in</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span> <span class="p">,</span> <span class="n">FORCE_z</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Full MCMC anaylsis for the Thin_Shell_Cont</span>

<span class="sd">        **Input**</span>

<span class="sd">        w_tar_Arr : 1-D sequence of floats</span>
<span class="sd">                    wavelength where the densit flux is evaluated</span>

<span class="sd">        f_tar_Arr : 1-D sequence of floats</span>
<span class="sd">                    Densit flux is evaluated</span>

<span class="sd">        s_tar_Arr : 1-D sequence of floats</span>
<span class="sd">                    Uncertainty of the densit flux is evaluated</span>

<span class="sd">        FWHM : float</span>
<span class="sd">              Full width half maximum [A] of the experiment.</span>

<span class="sd">        N_walkers : int</span>
<span class="sd">                    Number of walkers</span>

<span class="sd">        N_dim : int</span>
<span class="sd">                Number of dimensions (6)</span>

<span class="sd">        N_burn : int</span>
<span class="sd">                 Number of steps in the burnin-in phase</span>

<span class="sd">        N_steps : int</span>
<span class="sd">                  Number of steps </span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information.</span>

<span class="sd">        Geometry_Mode : optinal string</span>
<span class="sd">                        Changes from inflow (&#39;Inflow&#39;) to outflow (&#39;Outflow&#39;)</span>
<span class="sd">                        Default: &#39;Outflow&#39;</span>

<span class="sd">        log_V_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the bulk velocity</span>
<span class="sd">               log_V_in[0] is the minimum</span>
<span class="sd">               log_V_in[1] is the maximum</span>

<span class="sd">        log_N_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the neutral hydrogen column density</span>
<span class="sd">               log_N_in[0] is the minimum</span>
<span class="sd">               log_N_in[1] is the maximum</span>

<span class="sd">        log_t_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the dust optical depth</span>
<span class="sd">               log_t_in[0] is the minimum</span>
<span class="sd">               log_t_in[1] is the maximum</span>

<span class="sd">        z_in : optional 1-D sequence of floats.</span>
<span class="sd">               Redshift range to be considered.</span>
<span class="sd">               z_in[0] is the minimum redshift</span>
<span class="sd">               z_in[1] is the maximum redshift</span>

<span class="sd">        log_E_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the intrinsic equivalent width</span>
<span class="sd">               log_E_in[0] is the minimum</span>
<span class="sd">               log_E_in[1] is the maximum</span>

<span class="sd">        W_in : optional 1-D sequence of floats.</span>
<span class="sd">               Instrinsic line width range to be considered.</span>
<span class="sd">               W_in[0] is the minimum redshift</span>
<span class="sd">               W_in[1] is the maximum redshift</span>

<span class="sd">        progress : optional bool</span>
<span class="sd">              If True shows the MCMC progress.</span>
<span class="sd">              Default True</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        FORCE_z : optional bool</span>
<span class="sd">                  If True, force the redshift to be inside z_in</span>

<span class="sd">        **Output**</span>

<span class="sd">        samples : emcee python packge object.</span>
<span class="sd">                  Contains the information of the MCMC.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">N_dim</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="k">if</span> <span class="n">log_V_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="n">log_V_in</span> <span class="o">=</span>  <span class="p">[</span>  <span class="mf">1.</span>   <span class="p">,</span>  <span class="mf">3.</span>  <span class="p">]</span>
    <span class="k">if</span> <span class="n">log_N_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="n">log_N_in</span> <span class="o">=</span>  <span class="p">[</span> <span class="mf">17.</span>   <span class="p">,</span> <span class="mf">22.</span>  <span class="p">]</span>
    <span class="k">if</span> <span class="n">log_t_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="n">log_t_in</span> <span class="o">=</span>  <span class="p">[</span> <span class="o">-</span><span class="mf">0.2</span>  <span class="p">,</span> <span class="o">-</span><span class="mf">3.</span>  <span class="p">]</span>
    <span class="k">if</span> <span class="n">log_E_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span> <span class="n">log_E_in</span> <span class="o">=</span>  <span class="p">[</span>  <span class="o">-</span><span class="mf">1.</span>  <span class="p">,</span>  <span class="mf">3.</span>  <span class="p">]</span>
    <span class="k">if</span>     <span class="n">z_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>     <span class="n">z_in</span> <span class="o">=</span>  <span class="p">[</span>  <span class="mf">0.0</span>  <span class="p">,</span> <span class="mf">10.</span>  <span class="p">]</span>
    <span class="k">if</span>     <span class="n">W_in</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>     <span class="n">W_in</span> <span class="o">=</span>  <span class="p">[</span>  <span class="mf">0.01</span>  <span class="p">,</span> <span class="mf">6.</span> <span class="p">]</span>

    <span class="n">Theta_0</span> <span class="o">=</span> <span class="n">init_walkers_5</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">,</span> <span class="n">log_V_in</span> <span class="p">,</span> <span class="n">log_N_in</span> <span class="p">,</span> <span class="n">log_t_in</span> <span class="p">,</span> <span class="n">z_in</span> <span class="p">,</span> <span class="n">log_E_in</span> <span class="p">,</span> <span class="n">W_in</span> <span class="p">)</span>

    <span class="n">PIX</span> <span class="o">=</span> <span class="n">w_target_Arr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">w_target_Arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">w_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span> <span class="n">w_target_Arr</span> <span class="p">)</span>
    <span class="n">w_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">w_target_Arr</span> <span class="p">)</span>

    <span class="n">my_args</span> <span class="o">=</span> <span class="p">(</span> <span class="n">w_target_Arr</span> <span class="p">,</span> <span class="n">f_target_Arr</span> <span class="p">,</span> <span class="n">s_target_Arr</span> <span class="p">,</span> <span class="n">FWHM</span><span class="p">,</span> <span class="n">PIX</span><span class="p">,</span> <span class="n">w_min</span><span class="p">,</span> <span class="n">w_max</span><span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="p">,</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">z_in</span> <span class="p">,</span> <span class="n">FORCE_z</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">progress</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;defining samples&#39;</span> <span class="p">)</span>

    <span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="o">.</span><span class="n">EnsembleSampler</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">,</span> <span class="n">N_dim</span><span class="p">,</span> <span class="n">log_likeliehood_of_model_5</span> <span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">my_args</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">progress</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;burning in&#39;</span> <span class="p">)</span>

    <span class="n">state</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span> <span class="n">Theta_0</span> <span class="p">,</span> <span class="n">N_burn</span> <span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span> <span class="p">)</span>
    <span class="n">sampler</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">progress</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Running main MCMC&#39;</span> <span class="p">)</span>

    <span class="n">sampler</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">N_steps</span> <span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="n">progress</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">progress</span> <span class="p">:</span> <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Done&#39;</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">sampler</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="get_solutions_from_sampler"><a class="viewcode-back" href="../funcs.html#funcs.get_solutions_from_sampler">[docs]</a><span class="k">def</span> <span class="nf">get_solutions_from_sampler</span><span class="p">(</span> <span class="n">sampler</span> <span class="p">,</span> <span class="n">N_walkers</span> <span class="p">,</span> <span class="n">N_burn</span> <span class="p">,</span> <span class="n">N_steps</span> <span class="p">,</span> <span class="n">Q_Arr</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        function to get the solution from the emcee sampler sin some given</span>
<span class="sd">        percentiles.</span>

<span class="sd">        **Input**</span>

<span class="sd">        sampler : emcee python packge object.</span>
<span class="sd">                  Contains the information of the MCMC.</span>

<span class="sd">        N_walkers : int</span>
<span class="sd">                    Number of walkers</span>

<span class="sd">        N_burn : int</span>
<span class="sd">                 Number of steps in the burnin-in phase</span>

<span class="sd">        N_steps : int</span>
<span class="sd">                  Number of steps</span>

<span class="sd">        Q_Arr : 1-D list of floats</span>
<span class="sd">                List of the percentiles that will be computed, for </span>
<span class="sd">                example [ 16.0 , 50.0 , 84.0 ]</span>

<span class="sd">        **Output**</span>

<span class="sd">        matrix_sol: 2-D sequence of floats</span>
<span class="sd">                    The percentiles of each of the 6 properties.</span>

<span class="sd">        flat_samples : 2-D sequence of floats</span>
<span class="sd">                       The MCMC chains but flat.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chains</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;chains_shape = &#39;</span> <span class="p">,</span> <span class="n">chains</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>

    <span class="n">log_probs</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_log_prob</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;log_probs_shape = &#39;</span> <span class="p">,</span> <span class="n">log_probs</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>

    <span class="n">N_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">chains</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>

    <span class="n">flat_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="o">*</span> <span class="n">N_steps</span> <span class="o">*</span> <span class="n">N_dim</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="o">*</span> <span class="n">N_steps</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">)</span>

    <span class="n">flat_log_prob</span> <span class="o">=</span> <span class="n">log_probs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">):</span>
    
        <span class="n">flat_samples</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;flat_samples shape = &#39;</span> <span class="p">,</span> <span class="n">flat_samples</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;flat_log_prob shape = &#39;</span> <span class="p">,</span> <span class="n">flat_log_prob</span><span class="o">.</span><span class="n">shape</span> <span class="p">)</span>

    <span class="n">N_Q</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">Q_Arr</span> <span class="p">)</span>
    
    <span class="n">matrix_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_dim</span> <span class="o">*</span> <span class="n">N_Q</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">N_dim</span> <span class="p">,</span> <span class="n">N_Q</span> <span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_Q</span> <span class="p">):</span>

            <span class="n">matrix_sol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">flat_samples</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span> <span class="p">,</span> <span class="n">Q_Arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">matrix_sol</span> <span class="p">,</span> <span class="n">flat_samples</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="get_solutions_from_sampler_mean"><a class="viewcode-back" href="../funcs.html#funcs.get_solutions_from_sampler_mean">[docs]</a><span class="k">def</span> <span class="nf">get_solutions_from_sampler_mean</span><span class="p">(</span> <span class="n">sampler</span> <span class="p">,</span> <span class="n">N_walkers</span> <span class="p">,</span> <span class="n">N_burn</span> <span class="p">,</span> <span class="n">N_steps</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        function to get the solution from the emcee sampler as the mean.</span>

<span class="sd">        **Input**</span>

<span class="sd">        sampler : emcee python packge object.</span>
<span class="sd">                  Contains the information of the MCMC.</span>

<span class="sd">        N_walkers : int</span>
<span class="sd">                    Number of walkers</span>

<span class="sd">        N_burn : int</span>
<span class="sd">                 Number of steps in the burnin-in phase</span>

<span class="sd">        N_steps : int</span>
<span class="sd">                  Number of steps</span>

<span class="sd">        **Output**</span>

<span class="sd">        matrix_sol: 1-D sequence of floats</span>
<span class="sd">                    Mean of each of the 6 properties.</span>

<span class="sd">        flat_samples : 2-D sequence of floats</span>
<span class="sd">                       The MCMC chains but flat.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chains</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()</span>

    <span class="n">N_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">chains</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>

    <span class="n">flat_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="o">*</span> <span class="n">N_steps</span> <span class="o">*</span> <span class="n">N_dim</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="o">*</span> <span class="n">N_steps</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">):</span>
    
        <span class="n">flat_samples</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1">#N_Q = len( Q_Arr )</span>
    
    <span class="n">matrix_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_dim</span> <span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">):</span>
    
            <span class="n">matrix_sol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">flat_samples</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">matrix_sol</span> <span class="p">,</span> <span class="n">flat_samples</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="get_solutions_from_sampler_peak"><a class="viewcode-back" href="../funcs.html#funcs.get_solutions_from_sampler_peak">[docs]</a><span class="k">def</span> <span class="nf">get_solutions_from_sampler_peak</span><span class="p">(</span> <span class="n">sampler</span> <span class="p">,</span> <span class="n">N_walkers</span> <span class="p">,</span> <span class="n">N_burn</span> <span class="p">,</span> <span class="n">N_steps</span> <span class="p">,</span> <span class="n">N_hist_steps</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        function to get the solution from the emcee sampler as the</span>
<span class="sd">        global maximum of the distribution of the posteriors.</span>

<span class="sd">        **Input**</span>

<span class="sd">        sampler : emcee python packge object.</span>
<span class="sd">                  Contains the information of the MCMC.</span>

<span class="sd">        N_walkers : int</span>
<span class="sd">                    Number of walkers</span>

<span class="sd">        N_burn : int</span>
<span class="sd">                 Number of steps in the burnin-in phase</span>

<span class="sd">        N_steps : int</span>
<span class="sd">                  Number of steps</span>

<span class="sd">        N_hist_steps : int </span>
<span class="sd">                     Number of bins to sample the PDF of all properties</span>
<span class="sd">        **Output**</span>

<span class="sd">        matrix_sol: 1-D sequence of floats</span>
<span class="sd">                    Mean of each of the 6 properties.</span>

<span class="sd">        flat_samples : 2-D sequence of floats</span>
<span class="sd">                       The MCMC chains but flat.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">chains</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()</span>

    <span class="n">N_dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">chains</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>

    <span class="n">flat_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="o">*</span> <span class="n">N_steps</span> <span class="o">*</span> <span class="n">N_dim</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="o">*</span> <span class="n">N_steps</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">):</span>

        <span class="n">flat_samples</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">chains</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="c1">#N_Q = len( Q_Arr )</span>

    <span class="n">matrix_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_dim</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">):</span>

            <span class="c1">#matrix_sol[i] = np.mean( flat_samples[ : , i ] )</span>

            <span class="n">H_1</span> <span class="p">,</span> <span class="n">edges_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span> <span class="n">flat_samples</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span> <span class="p">,</span> <span class="n">N_hist_steps</span> <span class="p">)</span> 

            <span class="n">H_1</span> <span class="o">=</span> <span class="n">H_1</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">H_1</span> <span class="p">)</span>

            <span class="n">centers_1</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">edges_1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges_1</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">)</span>

            <span class="n">tmp_edges</span> <span class="o">=</span> <span class="n">centers_1</span><span class="p">[</span> <span class="n">H_1</span> <span class="o">&gt;</span> <span class="mf">0.01</span> <span class="p">]</span>

            <span class="n">v_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span> <span class="n">tmp_edges</span> <span class="p">)</span>
            <span class="n">v_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span> <span class="n">tmp_edges</span> <span class="p">)</span>

            <span class="n">H_2</span> <span class="p">,</span> <span class="n">edges_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span> <span class="n">flat_samples</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span> <span class="p">,</span> <span class="n">N_hist_steps</span> <span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span> <span class="n">v_min</span> <span class="p">,</span> <span class="n">v_max</span> <span class="p">]</span> <span class="p">)</span>

            <span class="n">centers</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">edges_2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">edges_2</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="p">)</span>

            <span class="n">matrix_sol</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">centers</span><span class="p">[</span> <span class="n">H_2</span><span class="o">==</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">H_2</span><span class="p">)</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">matrix_sol</span> <span class="p">,</span> <span class="n">flat_samples</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="get_solutions_from_flat_chain"><a class="viewcode-back" href="../funcs.html#funcs.get_solutions_from_flat_chain">[docs]</a><span class="k">def</span> <span class="nf">get_solutions_from_flat_chain</span><span class="p">(</span> <span class="n">flat_chains</span> <span class="p">,</span> <span class="n">Q_Arr</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        function to get the solution from the emcee sampler sin some given</span>
<span class="sd">        percentiles.</span>

<span class="sd">        **Input**</span>

<span class="sd">        flat_samples : 2-D sequence of floats</span>
<span class="sd">                       The MCMC chains but flat.</span>

<span class="sd">        Q_Arr : 1-D list of floats</span>
<span class="sd">                List of the percentiles that will be computed, for</span>
<span class="sd">                example [ 16.0 , 50.0 , 84.0 ]</span>

<span class="sd">        **Output**</span>

<span class="sd">        matrix_sol: 2-D sequence of floats</span>
<span class="sd">                    The percentiles of each of the 6 properties.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">N_dim</span> <span class="o">=</span> <span class="n">flat_chains</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">N_Q</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span> <span class="n">Q_Arr</span> <span class="p">)</span>

    <span class="n">matrix_sol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_dim</span> <span class="o">*</span> <span class="n">N_Q</span> <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span> <span class="n">N_dim</span> <span class="p">,</span> <span class="n">N_Q</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_dim</span> <span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_Q</span> <span class="p">):</span>

            <span class="n">matrix_sol</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span> <span class="n">flat_chains</span><span class="p">[</span> <span class="p">:</span> <span class="p">,</span> <span class="n">i</span> <span class="p">]</span> <span class="p">,</span> <span class="n">Q_Arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">matrix_sol</span> </div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>

<span class="c1"># NN</span>

<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="Load_NN_model"><a class="viewcode-back" href="../funcs.html#funcs.Load_NN_model">[docs]</a><span class="k">def</span> <span class="nf">Load_NN_model</span><span class="p">(</span> <span class="n">Mode</span> <span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="mi">1</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Loads the saved parameters of the deep neural networks</span>

<span class="sd">        **Input**</span>

<span class="sd">        Mode : string</span>
<span class="sd">               &#39;Inflow&#39; or &#39;Outflow&#39;</span>

<span class="sd">        iteration : optional int</span>
<span class="sd">                    Number of the iteration. Currently only 1</span>
<span class="sd">                    Default 1</span>

<span class="sd">        **Output**</span>

<span class="sd">        machine_data : python dictionaty</span>
<span class="sd">                       Contains all the info for the DNN</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">this_dir</span><span class="p">,</span> <span class="n">this_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span> 

    <span class="k">if</span> <span class="n">Mode</span> <span class="o">==</span> <span class="s1">&#39;Inflow&#39;</span> <span class="p">:</span> <span class="n">my_str</span> <span class="o">=</span> <span class="s1">&#39;INFLOWS&#39;</span>
    <span class="k">if</span> <span class="n">Mode</span> <span class="o">==</span> <span class="s1">&#39;Outflow&#39;</span><span class="p">:</span> <span class="n">my_str</span> <span class="o">=</span> <span class="s1">&#39;OUTFLOW&#39;</span>

    <span class="n">machine_name</span> <span class="o">=</span> <span class="s1">&#39;nn_&#39;</span><span class="o">+</span><span class="n">my_str</span><span class="o">+</span><span class="s1">&#39;_N_2500000_Npix_1000_Dl_-18.5_18.5_Dc_True_nor_False_sca_True_256_256_256_256_256_it_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.sav&#39;</span>
  
    <span class="n">extra_dir</span> <span class="o">=</span> <span class="s1">&#39;/DATA/&#39;</span>

    <span class="n">machine_data</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span> <span class="n">this_dir</span> <span class="o">+</span> <span class="n">extra_dir</span> <span class="o">+</span>  <span class="n">machine_name</span> <span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
 
    <span class="k">return</span> <span class="n">machine_data</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="NN_convert_Obs_Line_to_proxy_rest_line"><a class="viewcode-back" href="../funcs.html#funcs.NN_convert_Obs_Line_to_proxy_rest_line">[docs]</a><span class="k">def</span> <span class="nf">NN_convert_Obs_Line_to_proxy_rest_line</span><span class="p">(</span> <span class="n">w_obs_Arr</span> <span class="p">,</span> <span class="n">f_obs_Arr</span> <span class="p">,</span> <span class="n">s_obs_Arr</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Converts an observed line profile to the rest frame of the maximum</span>
<span class="sd">        of the line profile.</span>

<span class="sd">        **Input**</span>

<span class="sd">        w_obs_Arr : 1-D sequence of floats</span>
<span class="sd">                    wavelength where the line profile is evaluated.</span>

<span class="sd">        f_obs_Arr : 1-D sequence of floats</span>
<span class="sd">                    Flux density of the observed line profile.</span>

<span class="sd">        s_obs_Arr : optional 1-D sequence of floats</span>
<span class="sd">                    Uncertainty in the flux density of the observed line profile.</span>

<span class="sd">        normed : optional bool</span>
<span class="sd">              If True, nomalizes the line profile.</span>

<span class="sd">        scaled : optinal bool</span>
<span class="sd">              If True, divides the line profile by its maximum.</span>

<span class="sd">        **Output**</span>

<span class="sd">        w_rest_Arr : 1-D sequence of floats</span>
<span class="sd">                    wavelength where the line profile is evaluated in the rest frame</span>
<span class="sd">                    of the global maximum</span>

<span class="sd">        Delta_rest_Arr : 1-D sequence of floats</span>
<span class="sd">                         w_rest_Arr - Lyman-alpha.</span>

<span class="sd">        f_rest_Arr : 1-D sequence of floats</span>
<span class="sd">                    Flux density in the rest frame of the global maximum</span>

<span class="sd">        z_max : float</span>
<span class="sd">                Redshift if the global maximum is the Lyaman-alpha wavelength</span>

<span class="sd">        if s_obs_Arr is not None it also returns:</span>
<span class="sd">        s_rest_Arr : 1-D sequence of floats</span>
<span class="sd">                    Uncertainty of the flux density in the rest frame of the global maximum</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">w_Lya</span> <span class="o">=</span> <span class="mf">1215.67</span>

    <span class="n">w_obs_max</span> <span class="o">=</span> <span class="n">w_obs_Arr</span><span class="p">[</span> <span class="n">f_obs_Arr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_obs_Arr</span> <span class="p">)</span> <span class="p">]</span>

    <span class="n">z_max</span> <span class="o">=</span> <span class="n">w_obs_max</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">w_Lya</span> <span class="o">-</span> <span class="mf">1.</span>

    <span class="c1">########</span>
    <span class="n">z_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span> <span class="n">z_max</span> <span class="p">)</span>

    <span class="n">z_max</span> <span class="o">=</span> <span class="n">z_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#######</span>
    <span class="c1">#print( &#39;z_max = &#39; , z_max )</span>

    <span class="n">w_rest_Arr</span> <span class="o">=</span> <span class="n">w_obs_Arr</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">z_max</span> <span class="p">)</span>

    <span class="n">Delta_rest_Arr</span> <span class="o">=</span> <span class="n">w_rest_Arr</span> <span class="o">-</span> <span class="n">w_Lya</span>

    <span class="k">if</span> <span class="n">normed</span> <span class="p">:</span>

        <span class="n">II</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trapz</span><span class="p">(</span> <span class="n">f_obs_Arr</span> <span class="p">,</span> <span class="n">w_rest_Arr</span> <span class="p">)</span>

        <span class="n">f_rest_Arr</span> <span class="o">=</span> <span class="n">f_obs_Arr</span> <span class="o">/</span> <span class="n">II</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s_obs_Arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">s_rest_Arr</span> <span class="o">=</span> <span class="n">s_obs_Arr</span> <span class="o">/</span> <span class="n">II</span>

    <span class="k">if</span> <span class="n">scaled</span> <span class="p">:</span>

        <span class="n">f_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_obs_Arr</span> <span class="p">)</span>

        <span class="n">f_rest_Arr</span> <span class="o">=</span> <span class="n">f_obs_Arr</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">f_max</span> 

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s_obs_Arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">s_rest_Arr</span> <span class="o">=</span> <span class="n">s_obs_Arr</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">f_max</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">scaled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">normed</span><span class="p">:</span>

        <span class="n">f_rest_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="n">f_obs_Arr</span> <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">s_obs_Arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">s_rest_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span> <span class="n">s_obs_Arr</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">s_obs_Arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">w_rest_Arr</span> <span class="p">,</span> <span class="n">Delta_rest_Arr</span> <span class="p">,</span> <span class="n">f_rest_Arr</span> <span class="p">,</span> <span class="n">z_max</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">s_obs_Arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">w_rest_Arr</span> <span class="p">,</span> <span class="n">Delta_rest_Arr</span> <span class="p">,</span> <span class="n">f_rest_Arr</span> <span class="p">,</span> <span class="n">z_max</span> <span class="p">,</span> <span class="n">s_rest_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="NN_generate_random_outflow_props"><a class="viewcode-back" href="../funcs.html#funcs.NN_generate_random_outflow_props">[docs]</a><span class="k">def</span> <span class="nf">NN_generate_random_outflow_props</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">,</span> <span class="n">log_V_in</span> <span class="p">,</span> <span class="n">log_N_in</span> <span class="p">,</span> <span class="n">log_t_in</span> <span class="p">,</span> <span class="n">Allow_Inflows</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generates random poperties for the Thin_Shell, Galactic_Wind, etc. </span>
<span class="sd">        (Not for Thin_Shell_Cont)        </span>

<span class="sd">        **Input**</span>

<span class="sd">        N_walkers : int</span>
<span class="sd">                    Number of walkers</span>

<span class="sd">        log_V_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the bulk velocity</span>
<span class="sd">               log_V_in[0] is the minimum</span>
<span class="sd">               log_V_in[1] is the maximum</span>

<span class="sd">        log_N_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the neutral hydrogen column density</span>
<span class="sd">               log_N_in[0] is the minimum</span>
<span class="sd">               log_N_in[1] is the maximum</span>

<span class="sd">        log_t_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the dust optical depth</span>
<span class="sd">               log_t_in[0] is the minimum</span>
<span class="sd">               log_t_in[1] is the maximum</span>

<span class="sd">        Allow_Inflows : optional Bool</span>
<span class="sd">               If True it also return negative values of V in the same range.</span>
<span class="sd">               Default True           </span>
<span class="sd"> </span>
<span class="sd">        **Output**</span>

<span class="sd">        init_V_Arr : 1-D sequence of floats</span>
<span class="sd">                     Expansion velocity</span>

<span class="sd">        init_log_N_Arr : 1-D sequence of floats</span>
<span class="sd">                     Logarithms of the column density  </span>

<span class="sd">        init_log_t_Arr : 1-D sequence of floats</span>
<span class="sd">                     Logarithms of the dust optical depth</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">init_log_V_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_log_N_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_log_t_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="p">[</span> <span class="n">init_log_V_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_N_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_t_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">]</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">Prior_f</span><span class="p">(</span> <span class="n">theta</span> <span class="p">)</span> <span class="p">:</span>

            <span class="n">init_log_V_Arr</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">init_log_N_Arr</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">init_log_t_Arr</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">theta</span> <span class="o">=</span> <span class="p">[</span> <span class="n">init_log_V_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_N_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_t_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">]</span>

    <span class="k">if</span> <span class="n">Allow_Inflows</span><span class="p">:</span>

        <span class="n">V_sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span> 
        <span class="n">V_sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span>

    <span class="n">init_V_Arr</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">init_log_V_Arr</span> <span class="o">*</span> <span class="n">V_sign</span> 

    <span class="k">return</span> <span class="n">init_V_Arr</span> <span class="p">,</span> <span class="n">init_log_N_Arr</span> <span class="p">,</span> <span class="n">init_log_t_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="NN_generate_random_outflow_props_5D"><a class="viewcode-back" href="../funcs.html#funcs.NN_generate_random_outflow_props_5D">[docs]</a><span class="k">def</span> <span class="nf">NN_generate_random_outflow_props_5D</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">,</span> <span class="n">log_V_in</span> <span class="p">,</span> <span class="n">log_N_in</span> <span class="p">,</span> <span class="n">log_t_in</span> <span class="p">,</span> <span class="n">log_E_in</span> <span class="p">,</span> <span class="n">log_W_in</span> <span class="p">,</span> <span class="n">MODE</span><span class="o">=</span><span class="s1">&#39;Outflow&#39;</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generates random poperties for the Thin_Shell_Cont</span>

<span class="sd">        **Input**</span>

<span class="sd">        N_walkers : int</span>
<span class="sd">                    Number of walkers</span>

<span class="sd">        log_V_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the bulk velocity</span>
<span class="sd">               log_V_in[0] is the minimum</span>
<span class="sd">               log_V_in[1] is the maximum</span>

<span class="sd">        log_N_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the neutral hydrogen column density</span>
<span class="sd">               log_N_in[0] is the minimum</span>
<span class="sd">               log_N_in[1] is the maximum</span>

<span class="sd">        log_t_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the dust optical depth</span>
<span class="sd">               log_t_in[0] is the minimum</span>
<span class="sd">               log_t_in[1] is the maximum</span>

<span class="sd">        log_E_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the instrinsic equivalent width</span>
<span class="sd">               log_E_in[0] is the minimum</span>
<span class="sd">               log_E_in[1] is the maximum</span>

<span class="sd">        log_W_in : optional 1-D sequence of floats.</span>
<span class="sd">               Range of the logarithm of the intrinsic width of the line</span>
<span class="sd">               log_W_in[0] is the minimum</span>
<span class="sd">               log_W_in[1] is the maximum</span>

<span class="sd">        MODE : optional string</span>
<span class="sd">               &#39;Outflow&#39; for outflows &#39;Inflow&#39; for inflows</span>

<span class="sd">        **Output**</span>

<span class="sd">        init_V_Arr : 1-D sequence of floats</span>
<span class="sd">                     Expansion velocity</span>

<span class="sd">        init_log_N_Arr : 1-D sequence of floats</span>
<span class="sd">                     Logarithms of the column density</span>

<span class="sd">        init_log_t_Arr : 1-D sequence of floats</span>
<span class="sd">                     Logarithms of the dust optical depth</span>

<span class="sd">        init_log_E_Arr : 1-D sequence of floats</span>
<span class="sd">                     Logarithms of the instrinsic equivalent width</span>

<span class="sd">        init_log_W_Arr : 1-D sequence of floats</span>
<span class="sd">                     Logarithms of the intrinsic width of the line</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">MODE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span> <span class="s1">&#39;Outflow&#39;</span> <span class="p">,</span> <span class="s1">&#39;Inflow&#39;</span> <span class="p">,</span> <span class="s1">&#39;Mixture&#39;</span> <span class="p">]:</span>

        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;    -&gt; Wrong MODE when generating gas properties, using only outflows&#39;</span> <span class="p">)</span>

    <span class="n">init_log_V_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_log_N_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_log_t_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_log_E_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">init_log_W_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_W_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_W_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="p">:</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="p">[</span> <span class="n">init_log_V_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_N_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_t_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_E_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_W_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">]</span>

        <span class="k">while</span> <span class="ow">not</span> <span class="n">Prior_f_5</span><span class="p">(</span> <span class="n">theta</span> <span class="p">)</span> <span class="p">:</span>

            <span class="n">init_log_V_Arr</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_V_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">init_log_N_Arr</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_N_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">init_log_t_Arr</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_t_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">init_log_E_Arr</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_E_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">init_log_W_Arr</span><span class="p">[</span> <span class="n">i</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">log_W_in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_W_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">+</span> <span class="n">log_W_in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">theta</span> <span class="o">=</span> <span class="p">[</span> <span class="n">init_log_V_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_N_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_t_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_E_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">init_log_W_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">]</span>

    <span class="k">if</span> <span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;Mixture&#39;</span> <span class="p">:</span>

        <span class="n">V_sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;Inflow&#39;</span><span class="p">:</span>

        <span class="n">V_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> 

    <span class="k">if</span> <span class="n">MODE</span> <span class="o">==</span> <span class="s1">&#39;Outflow&#39;</span><span class="p">:</span>

        <span class="n">V_sign</span> <span class="o">=</span>       <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span> <span class="n">N_walkers</span> <span class="p">)</span> 


    <span class="n">init_V_Arr</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">init_log_V_Arr</span> <span class="o">*</span> <span class="n">V_sign</span> 

    <span class="k">return</span> <span class="n">init_V_Arr</span> <span class="p">,</span> <span class="n">init_log_N_Arr</span> <span class="p">,</span> <span class="n">init_log_t_Arr</span> <span class="p">,</span> <span class="n">init_log_E_Arr</span> <span class="p">,</span> <span class="n">init_log_W_Arr</span> </div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="NN_measure"><a class="viewcode-back" href="../funcs.html#funcs.NN_measure">[docs]</a><span class="k">def</span> <span class="nf">NN_measure</span><span class="p">(</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_tar_Arr</span> <span class="p">,</span> <span class="n">s_tar_Arr</span> <span class="p">,</span> <span class="n">FWHM_tar</span> <span class="p">,</span> <span class="n">PIX_tar</span> <span class="p">,</span> <span class="n">loaded_model</span> <span class="p">,</span> <span class="n">w_rest_Machine_Arr</span> <span class="p">,</span> <span class="n">N_iter</span><span class="o">=</span><span class="kc">None</span> <span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">False</span> <span class="p">,</span> <span class="n">Delta_min</span><span class="o">=-</span><span class="mf">18.5</span> <span class="p">,</span> <span class="n">Delta_max</span><span class="o">=</span><span class="mf">18.5</span> <span class="p">,</span> <span class="n">Nbins_tot</span><span class="o">=</span><span class="mi">1000</span> <span class="p">,</span> <span class="n">Denser_Center</span><span class="o">=</span><span class="kc">True</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Generates random poperties for the Thin_Shell_Cont</span>

<span class="sd">        **Input**</span>

<span class="sd">        w_tar_Arr : 1-D sequence of floats</span>
<span class="sd">                    wavelength where the densit flux is evaluated</span>

<span class="sd">        f_tar_Arr : 1-D sequence of floats</span>
<span class="sd">                    Densit flux is evaluated</span>

<span class="sd">        s_tar_Arr : 1-D sequence of floats</span>
<span class="sd">                    Uncertainty of the densit flux is evaluated</span>

<span class="sd">        FWHM : float</span>
<span class="sd">              Full width half maximum [A] of the experiment.</span>

<span class="sd">        PIX_tar : float</span>
<span class="sd">                  Pixelization of the line profiles due to the experiment [A]</span>

<span class="sd">        loaded_model : python dictionaty</span>
<span class="sd">                       Contains all the info for the DNN form Load_NN_model()</span>

<span class="sd">        w_rest_Machine_Arr : 1-D sequence of floats</span>
<span class="sd">                             wavelength used by the INPUT of the DNN       </span>
<span class="sd">                           </span>
<span class="sd">        N_iter : optional int</span>
<span class="sd">                 Number of Monte Carlo iterations of the observed espectrum.</span>
<span class="sd">                 If None, no iteration is done.</span>
<span class="sd">                 Default None</span>
<span class="sd"> </span>
<span class="sd">        Delta_min : optional float</span>
<span class="sd">              Defines the minimum rest frame wavelegnth with respecto to Lyman-alpha.</span>

<span class="sd">              Default = -18.5</span>

<span class="sd">        Delta_min : optional float</span>
<span class="sd">              Defines the maximum rest frame wavelegnth with respecto to Lyman-alpha.</span>

<span class="sd">              Default = +18.5</span>

<span class="sd">        Nbins_tot : optional int</span>
<span class="sd">              Total number of wvelgnths bins.</span>

<span class="sd">              Default = 1000</span>

<span class="sd">        Denser_Center : optional bool</span>
<span class="sd">              Populates denser the regions close to Lyman-alpha</span>

<span class="sd">              Default = True</span>

<span class="sd">        normed : optional bool</span>
<span class="sd">              If True, nomalizes the line profile.</span>

<span class="sd">        scaled : optinal bool</span>
<span class="sd">              If True, divides the line profile by its maximum. </span>

<span class="sd">        **Output**</span>

<span class="sd">        if N_iter is None: </span>
<span class="sd">            Sol : 1-D sequence of float</span>
<span class="sd">                  Array with the solution of the observed spectrum. No Monte Carlo perturbation.</span>

<span class="sd">            z_Sol : float</span>
<span class="sd">                    Best resdhift</span>

<span class="sd">        if N_iter is a float:</span>
<span class="sd">            Sol and z_sol and</span>

<span class="sd">            log_V_sol_2_Arr : 1-D sequence</span>
<span class="sd">                              Logarithm of the expasion velocity</span>

<span class="sd">            log_N_sol_2_Arr : 1-D sequence</span>
<span class="sd">                              Logarithm of the neutral hydrogen column density</span>

<span class="sd">            log_t_sol_2_Arr : 1-D sequence</span>
<span class="sd">                              Logarithm of the dust optical depth</span>

<span class="sd">            z_sol_2_Arr : 1-D sequence</span>
<span class="sd">                              redshift</span>

<span class="sd">            log_E_sol_2_Arr : 1-D sequence</span>
<span class="sd">                              Logarithm of the intrinsic equivalent width</span>

<span class="sd">            log_W_sol_2_Arr : 1-D sequence</span>
<span class="sd">                              Logarithm of the instrinsic width of the line</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">w_rest_tar_Arr</span> <span class="p">,</span> <span class="n">f_rest_tar_Arr</span> <span class="p">,</span> <span class="n">z_max_tar</span> <span class="p">,</span> <span class="n">INPUT</span> <span class="o">=</span> <span class="n">Treat_A_Line_To_NN_Input</span><span class="p">(</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_tar_Arr</span> <span class="p">,</span> <span class="n">PIX_tar</span> <span class="p">,</span> <span class="n">FWHM_tar</span> <span class="p">,</span> <span class="n">Delta_min</span><span class="o">=</span><span class="n">Delta_min</span> <span class="p">,</span> <span class="n">Delta_max</span><span class="o">=</span><span class="n">Delta_max</span> <span class="p">,</span> <span class="n">Nbins_tot</span><span class="o">=</span><span class="n">Nbins_tot</span> <span class="p">,</span> <span class="n">Denser_Center</span><span class="o">=</span><span class="n">Denser_Center</span> <span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="n">normed</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="n">scaled</span> <span class="p">)</span>

    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">w_rest_tar_Arr</span> <span class="o">-</span> <span class="n">w_rest_Machine_Arr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">,</span> <span class="s1">&#39;wavelength array of machine and measure dont match. Check that Delta_min, Delta_max, Nbins_tot and Denser_Center are the same in the model and the imput here.&#39;</span>

    <span class="n">Sol</span> <span class="o">=</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">INPUT</span> <span class="p">)</span>

    <span class="n">w_Lya</span> <span class="o">=</span> <span class="mf">1215.673123</span> <span class="c1">#A</span>

    <span class="n">z_sol</span> <span class="o">=</span> <span class="p">(</span> <span class="n">w_Lya</span> <span class="o">+</span> <span class="n">Sol</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">z_max_tar</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span> <span class="n">w_Lya</span> <span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span>

    <span class="k">if</span> <span class="n">N_iter</span> <span class="ow">is</span> <span class="kc">None</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">Sol</span> <span class="p">,</span> <span class="n">z_sol</span>

    <span class="k">if</span> <span class="n">N_iter</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">log_V_sol_2_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_iter</span> <span class="p">)</span>
        <span class="n">log_N_sol_2_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_iter</span> <span class="p">)</span>
        <span class="n">log_t_sol_2_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_iter</span> <span class="p">)</span>
        <span class="n">log_E_sol_2_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_iter</span> <span class="p">)</span>
        <span class="n">log_W_sol_2_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_iter</span> <span class="p">)</span>

        <span class="n">z_sol_2_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="n">N_iter</span> <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="n">N_iter</span> <span class="p">)</span> <span class="p">:</span>

            <span class="n">f_obs_i_Arr</span> <span class="o">=</span> <span class="n">f_tar_Arr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">s_tar_Arr</span>

            <span class="n">w_rest_i_Arr</span> <span class="p">,</span> <span class="n">f_rest_i_Arr</span> <span class="p">,</span> <span class="n">z_max_i</span> <span class="p">,</span> <span class="n">INPUT_i</span> <span class="o">=</span> <span class="n">Treat_A_Line_To_NN_Input</span><span class="p">(</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_obs_i_Arr</span> <span class="p">,</span> <span class="n">PIX_tar</span> <span class="p">,</span> <span class="n">FWHM_tar</span> <span class="p">,</span> <span class="n">Delta_min</span><span class="o">=</span><span class="n">Delta_min</span> <span class="p">,</span> <span class="n">Delta_max</span><span class="o">=</span><span class="n">Delta_max</span> <span class="p">,</span> <span class="n">Nbins_tot</span><span class="o">=</span><span class="n">Nbins_tot</span> <span class="p">,</span> <span class="n">Denser_Center</span><span class="o">=</span><span class="n">Denser_Center</span> <span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="n">normed</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="n">scaled</span> <span class="p">)</span>

            <span class="n">Sol_i</span> <span class="o">=</span> <span class="n">loaded_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span> <span class="n">INPUT_i</span> <span class="p">)</span>

            <span class="n">z_sol_i</span> <span class="o">=</span> <span class="p">(</span> <span class="n">w_Lya</span> <span class="o">+</span> <span class="n">Sol_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">z_max_i</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="p">(</span> <span class="n">w_Lya</span> <span class="p">)</span> <span class="o">-</span> <span class="mf">1.</span>

            <span class="n">log_V_sol_2_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sol_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">log_N_sol_2_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sol_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">log_t_sol_2_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sol_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">log_E_sol_2_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sol_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
            <span class="n">log_W_sol_2_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Sol_i</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>

            <span class="n">z_sol_2_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">z_sol_i</span>

        <span class="k">return</span> <span class="n">Sol</span> <span class="p">,</span> <span class="n">z_sol</span> <span class="p">,</span> <span class="n">log_V_sol_2_Arr</span> <span class="p">,</span> <span class="n">log_N_sol_2_Arr</span> <span class="p">,</span> <span class="n">log_t_sol_2_Arr</span> <span class="p">,</span> <span class="n">z_sol_2_Arr</span> <span class="p">,</span> <span class="n">log_E_sol_2_Arr</span> <span class="p">,</span> <span class="n">log_W_sol_2_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1"># PSO</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="PSO_compute_xi_2_ONE_6D"><a class="viewcode-back" href="../funcs.html#funcs.PSO_compute_xi_2_ONE_6D">[docs]</a><span class="k">def</span> <span class="nf">PSO_compute_xi_2_ONE_6D</span><span class="p">(</span> <span class="n">x</span> <span class="p">,</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_tar_Arr</span> <span class="p">,</span> <span class="n">FWHM</span> <span class="p">,</span> <span class="n">PIX</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="p">,</span> <span class="n">Geometry</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the chi esquare for the PSO analysis</span>

<span class="sd">        **Input**</span>

<span class="sd">        x: 1-D sequence of float</span>
<span class="sd">                Contains the parameters of the mode:</span>
<span class="sd">                    x[0] = logarithim of the expansion velocity</span>
<span class="sd">                    x[1] = logarithim of the neutral hydrogen column density</span>
<span class="sd">                    x[2] = logarithim of the dust optical depth</span>
<span class="sd">                    x[3] = redshift</span>
<span class="sd">                    x[4] = logarithm of the intrinsic equivalent width</span>
<span class="sd">                    x[5] = intrinsic width</span>

<span class="sd">        w_tar_Arr : 1-D sequence of float</span>
<span class="sd">                    wavelength where the observed density flux is evaluated.</span>

<span class="sd">        f_tar_Arr : 1-D sequence of float</span>
<span class="sd">                    Observed flux density</span>

<span class="sd">        FWHM : float</span>
<span class="sd">              Full width half maximum [A] of the experiment.</span>

<span class="sd">        PIX : float</span>
<span class="sd">              Pixel size in wavelgnth [A] of the experiment.</span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information.</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>

<span class="sd">        **Output**</span>

<span class="sd">        xi_2 : float</span>
<span class="sd">               Chi square of the configuration</span>

<span class="sd">        w_pso_Arr : 1-D sequence of floats</span>
<span class="sd">                    Wavelgnth of the line profile computed by the PSO </span>

<span class="sd">        my_f_pso_Arr : 1-D sequence of floats</span>
<span class="sd">                       Flux density of the line profile computed by the PSO </span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">my_f_tar_Arr</span> <span class="o">=</span> <span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="p">)</span>

    <span class="n">w_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span> <span class="n">w_tar_Arr</span> <span class="p">)</span>
    <span class="n">w_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">w_tar_Arr</span> <span class="p">)</span> <span class="o">+</span> <span class="mf">0.000001</span>

    <span class="n">w_s_tar_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span> <span class="n">w_min</span> <span class="p">,</span> <span class="n">w_max</span> <span class="p">,</span> <span class="mi">100</span> <span class="p">)</span>
    <span class="n">s_tar_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span> <span class="n">w_s_tar_Arr</span> <span class="p">))</span>

    <span class="n">redshift</span>  <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">log_V_pso</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">log_N_pso</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">log_t_pso</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">log_E_pso</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">log_W_pso</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>    

    <span class="n">F_pso</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">w_pso_Arr</span> <span class="p">,</span> <span class="n">f_pso_Arr</span> <span class="p">,</span> <span class="n">dic</span> <span class="o">=</span> <span class="n">generate_a_REAL_line_Noise_w</span><span class="p">(</span> <span class="n">redshift</span>      <span class="p">,</span> <span class="mi">10</span><span class="o">**</span><span class="n">log_V_pso</span><span class="p">,</span> <span class="n">log_N_pso</span>  <span class="p">,</span> 
                                                                <span class="mi">10</span><span class="o">**</span><span class="n">log_t_pso</span> <span class="p">,</span> <span class="n">F_pso</span>        <span class="p">,</span> <span class="n">log_E_pso</span>  <span class="p">,</span> 
                                                                <span class="mi">10</span><span class="o">**</span><span class="n">log_W_pso</span> <span class="p">,</span> <span class="n">w_s_tar_Arr</span> <span class="p">,</span>
                                                                 <span class="n">s_tar_Arr</span>    <span class="p">,</span> <span class="n">FWHM</span>         <span class="p">,</span> <span class="n">PIX</span>        <span class="p">,</span> 
                                                                 <span class="n">w_min</span>        <span class="p">,</span> <span class="n">w_max</span>        <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> 
                                                                 <span class="n">Geometry</span>     <span class="p">)</span>

    <span class="n">my_f_pso_Arr</span> <span class="o">=</span> <span class="n">f_pso_Arr</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_pso_Arr</span><span class="p">)</span>

    <span class="n">my_f_pso_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">w_pso_Arr</span> <span class="p">,</span> <span class="n">my_f_pso_Arr</span> <span class="p">)</span>

    <span class="n">my_f_tar_Arr</span> <span class="o">=</span> <span class="n">my_f_tar_Arr</span> <span class="o">*</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">my_f_tar_Arr</span> <span class="p">)</span>

    <span class="n">xi_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="p">(</span> <span class="n">my_f_pso_Arr</span> <span class="o">-</span> <span class="n">my_f_tar_Arr</span> <span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">xi_2</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;found np.nan in xi_2!!!&#39;</span> <span class="p">)</span>
        <span class="n">xi_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>

    <span class="k">return</span> <span class="n">xi_2</span> <span class="p">,</span> <span class="n">w_pso_Arr</span> <span class="p">,</span> <span class="n">my_f_pso_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<div class="viewcode-block" id="PSO_compute_xi_2_MANY"><a class="viewcode-back" href="../funcs.html#funcs.PSO_compute_xi_2_MANY">[docs]</a><span class="k">def</span> <span class="nf">PSO_compute_xi_2_MANY</span><span class="p">(</span> <span class="n">X</span> <span class="p">,</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_tar_Arr</span> <span class="p">,</span> <span class="n">FWHM</span> <span class="p">,</span> <span class="n">PIX</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="p">,</span> <span class="n">Geometry</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute the chi esquare for the PSO analysis for many configurations</span>

<span class="sd">        **Input**</span>

<span class="sd">        x: 1-D sequence of float</span>
<span class="sd">                Contains the parameters of the mode:</span>
<span class="sd">                    x[0] = logarithim of the expansion velocity</span>
<span class="sd">                    x[1] = logarithim of the neutral hydrogen column density</span>
<span class="sd">                    x[2] = logarithim of the dust optical depth</span>
<span class="sd">                    x[3] = redshift</span>
<span class="sd">                    x[4] = logarithm of the intrinsic equivalent width</span>
<span class="sd">                    x[5] = intrinsic width</span>

<span class="sd">        w_tar_Arr : 1-D sequence of float</span>
<span class="sd">                    wavelength where the observed density flux is evaluated.</span>

<span class="sd">        f_tar_Arr : 1-D sequence of float</span>
<span class="sd">                    Observed flux density</span>

<span class="sd">        FWHM : float</span>
<span class="sd">              Full width half maximum [A] of the experiment.</span>

<span class="sd">        PIX : float</span>
<span class="sd">              Pixel size in wavelgnth [A] of the experiment.</span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information.</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>

<span class="sd">        **Output**</span>

<span class="sd">        xi_2_Arr : 1-D sequence of float</span>
<span class="sd">               Chi square of the configurations</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">xi_2_Arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span> <span class="mi">0</span> <span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="p">):</span>

        <span class="n">xi_2</span> <span class="p">,</span> <span class="n">w_pso_Arr</span> <span class="p">,</span> <span class="n">f_pso_Arr</span> <span class="o">=</span> <span class="n">PSO_compute_xi_2_ONE_6D</span><span class="p">(</span> <span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_tar_Arr</span> <span class="p">,</span> <span class="n">FWHM</span> <span class="p">,</span> <span class="n">PIX</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="p">,</span> <span class="n">Geometry</span> <span class="p">)</span>

        <span class="n">xi_2_Arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi_2</span>

    <span class="k">return</span> <span class="n">xi_2_Arr</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">##====================================================================================#</span>
<div class="viewcode-block" id="PSO_Analysis"><a class="viewcode-back" href="../funcs.html#funcs.PSO_Analysis">[docs]</a><span class="k">def</span> <span class="nf">PSO_Analysis</span><span class="p">(</span> <span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_tar_Arr</span> <span class="p">,</span> <span class="n">FWHM</span> <span class="p">,</span> <span class="n">PIX</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">Geometry</span> <span class="p">,</span> <span class="n">n_particles</span> <span class="p">,</span> <span class="n">n_iters</span> <span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Does a PSO analysis to find in a fast way a close good fit</span>

<span class="sd">        **Input**</span>

<span class="sd">        w_tar_Arr : 1-D sequence of float</span>
<span class="sd">                    wavelength where the observed density flux is evaluated.</span>

<span class="sd">        f_tar_Arr : 1-D sequence of float</span>
<span class="sd">                    Observed flux density</span>

<span class="sd">        FWHM : float</span>
<span class="sd">              Full width half maximum [A] of the experiment.</span>

<span class="sd">        PIX : float</span>
<span class="sd">              Pixel size in wavelgnth [A] of the experiment.</span>

<span class="sd">        DATA_LyaRT : python dictionary</span>
<span class="sd">                     Contains the grid information.</span>

<span class="sd">        Geometry : string</span>
<span class="sd">                   Outflow geometry to use.</span>

<span class="sd">        n_particles : int</span>
<span class="sd">                      Number of particles in the PSO</span>

<span class="sd">        n_iters : int</span>
<span class="sd">                  Number of steps in the PSO</span>

<span class="sd">        **Output**</span>

<span class="sd">        cost : float</span>
<span class="sd">               Cost of the best configuration</span>

<span class="sd">        pos : 1-D sequence of floats</span>
<span class="sd">                Position of the best configuration</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">w_lya</span> <span class="o">=</span> <span class="mf">1215.67</span>

    <span class="c1">#w_max = np.atleast_1d( w_tar_Arr[ f_tar_Arr == np.amax( f_tar_Arr ) ])[0]</span>

    <span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;max = &#39;</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="p">)</span> <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="p">)</span> <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span> <span class="nb">sum</span><span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">w_max</span> <span class="o">=</span> <span class="n">w_tar_Arr</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span> <span class="n">f_tar_Arr</span> <span class="p">)</span> <span class="p">)</span> <span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span> <span class="n">w_max</span> <span class="p">)</span>

    <span class="n">z_of_the_max</span> <span class="o">=</span> <span class="n">w_max</span> <span class="o">/</span> <span class="n">w_lya</span> <span class="o">-</span> <span class="mf">1.</span>

    <span class="nb">print</span><span class="p">(</span> <span class="n">z_of_the_max</span> <span class="p">)</span>

    <span class="n">Dz</span> <span class="o">=</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">z_of_the_max</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">2e-3</span>

    <span class="n">pso_z_min</span> <span class="o">=</span> <span class="n">z_of_the_max</span> <span class="o">-</span> <span class="n">Dz</span>
    <span class="n">pso_z_max</span> <span class="o">=</span> <span class="n">z_of_the_max</span> <span class="o">+</span> <span class="n">Dz</span>

    <span class="k">if</span> <span class="n">pso_z_min</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">pso_z_min</span> <span class="o">=</span> <span class="mf">1e-10</span>

    <span class="n">X_min</span> <span class="o">=</span> <span class="p">[</span> <span class="n">pso_z_min</span> <span class="p">,</span> <span class="mf">1.0</span> <span class="p">,</span> <span class="mf">17.</span> <span class="p">,</span> <span class="o">-</span><span class="mf">4.00</span> <span class="p">,</span> <span class="mf">0.1</span> <span class="p">,</span> <span class="mf">0.01</span> <span class="p">]</span>
    <span class="n">X_max</span> <span class="o">=</span> <span class="p">[</span> <span class="n">pso_z_max</span> <span class="p">,</span> <span class="mf">3.0</span> <span class="p">,</span> <span class="mf">22.</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span> <span class="p">,</span> <span class="mf">3.</span>  <span class="p">,</span> <span class="mf">6.0</span>  <span class="p">]</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">X_min</span><span class="p">,</span> <span class="n">X_max</span><span class="p">)</span>

    <span class="n">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">}</span>

    <span class="n">n_particles</span> <span class="o">=</span> <span class="n">n_particles</span>
    <span class="n">dimensions</span>  <span class="o">=</span> <span class="mi">6</span>

    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">GlobalBestPSO</span><span class="p">(</span> <span class="n">n_particles</span><span class="o">=</span><span class="n">n_particles</span> <span class="p">,</span> <span class="n">dimensions</span><span class="o">=</span><span class="n">dimensions</span> <span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>

    <span class="n">cost</span><span class="p">,</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span> <span class="n">PSO_compute_xi_2_MANY</span> <span class="p">,</span> <span class="n">iters</span><span class="o">=</span><span class="n">n_iters</span> <span class="p">,</span> <span class="n">w_tar_Arr</span><span class="o">=</span><span class="n">w_tar_Arr</span> <span class="p">,</span> <span class="n">f_tar_Arr</span><span class="o">=</span><span class="n">f_tar_Arr</span> <span class="p">,</span> <span class="n">FWHM</span><span class="o">=</span><span class="n">FWHM</span> <span class="p">,</span> <span class="n">PIX</span><span class="o">=</span><span class="n">PIX</span> <span class="p">,</span> <span class="n">DATA_LyaRT</span><span class="o">=</span><span class="n">DATA_LyaRT</span> <span class="p">,</span> <span class="n">Geometry</span><span class="o">=</span><span class="n">Geometry</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">cost</span> <span class="p">,</span> <span class="n">pos</span></div>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>
<span class="c1">#====================================================================#</span>

<span class="c1"># Enjoy</span>

<span class="c1">##====================================================================================#</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="c1">##====================================================================================#</span>














</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Gurung-Lopez, Siddhartha.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>